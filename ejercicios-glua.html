<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ejercicios Pr√°cticos de GLua ‚Äî Extensi√≥n del Curso</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Outfit:wght@300;400;500;600;700;800;900&family=Source+Serif+4:ital,wght@0,300;0,400;0,600;1,400&display=swap" rel="stylesheet">
<style>
/* ===== RESET & VARS ===== */
:root {
  --bg-deep: #080a10;
  --bg-primary: #0c0e14;
  --bg-secondary: #11141d;
  --bg-card: #171b28;
  --bg-code: #0d1117;
  --border-dim: #1a1e2e;
  --border-subtle: #222840;
  --text-primary: #dfe3f0;
  --text-secondary: #8891ab;
  --text-muted: #4e5670;
  --accent-blue: #5a8df7;
  --accent-cyan: #4ecdc4;
  --accent-green: #45c088;
  --accent-orange: #e8973f;
  --accent-red: #e85d5d;
  --accent-purple: #a07ae8;
  --accent-yellow: #e8c94b;
  --glow-blue: rgba(90,141,247,0.07);
  --glow-cyan: rgba(78,205,196,0.05);
  --font-display: 'Outfit', sans-serif;
  --font-body: 'Source Serif 4', Georgia, serif;
  --font-mono: 'JetBrains Mono', 'Fira Code', monospace;
  --radius-sm: 6px;
  --radius-md: 10px;
  --radius-lg: 16px;
  --sidebar-w: 290px;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; scrollbar-width: thin; scrollbar-color: #2a3050 var(--bg-primary); }
body {
  font-family: var(--font-body);
  font-size: 17px; line-height: 1.78;
  color: var(--text-primary);
  background: var(--bg-primary);
  -webkit-font-smoothing: antialiased;
  text-rendering: optimizeLegibility;
}

/* ===== PROGRESS ===== */
.progress {
  position: fixed; top: 54px; left: 0; width: 0%;
  height: 3px; z-index: 500;
  background: linear-gradient(90deg, var(--accent-orange), var(--accent-red), var(--accent-purple));
  transition: width 80ms linear;
}

/* ===== SIDEBAR ===== */
.sidebar {
  position: fixed; top: 54px; left: 0;
  width: var(--sidebar-w); height: calc(100vh - 54px);
  background: var(--bg-secondary);
  border-right: 1px solid var(--border-dim);
  overflow-y: auto; z-index: 100;
  padding: 0;
  scrollbar-width: thin;
  scrollbar-color: var(--border-dim) transparent;
  transition: transform .3s cubic-bezier(.4,0,.2,1);
}
.sb-head {
  position: sticky; top: 0;
  background: var(--bg-secondary);
  padding: 24px 22px 18px;
  border-bottom: 1px solid var(--border-dim);
  z-index: 2;
}
.sb-head h1 {
  font-family: var(--font-display);
  font-size: 16px; font-weight: 800;
  letter-spacing: -.02em;
  background: linear-gradient(135deg, var(--accent-orange), var(--accent-red));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text;
}
.sb-head small {
  font-family: var(--font-mono);
  font-size: 10.5px; color: var(--text-muted);
  display: block; margin-top: 3px;
}
.sb-head .back-link {
  display: inline-block; margin-top: 10px;
  font-family: var(--font-display);
  font-size: 12px; color: var(--accent-cyan);
  text-decoration: none; border: none;
  opacity: .7; transition: opacity .15s;
}
.sb-head .back-link:hover { opacity: 1; }
.sb-nav { padding: 10px 0 24px; }
.sb-nav a {
  display: flex; align-items: baseline; gap: 8px;
  padding: 5px 22px;
  color: var(--text-secondary); text-decoration: none;
  font-family: var(--font-display);
  font-size: 13px; font-weight: 400; line-height: 1.45;
  border-left: 2px solid transparent;
  transition: all .12s ease;
}
.sb-nav a:hover {
  color: var(--text-primary);
  background: var(--glow-blue);
  border-left-color: var(--accent-orange);
}
.sb-nav a .snum {
  font-family: var(--font-mono);
  font-size: 10px; color: var(--text-muted);
  min-width: 18px;
}
.sb-nav a.sub {
  padding-left: 48px;
  font-size: 11.5px;
  color: var(--text-muted);
}
.sb-nav a.sub:hover { color: var(--text-secondary); }

/* ===== MAIN ===== */
.main {
  margin-left: var(--sidebar-w);
  max-width: 840px;
  padding: 44px 52px 140px;
}

/* ===== HERO ===== */
.hero {
  margin-bottom: 60px; padding: 44px 48px;
  background: linear-gradient(145deg, var(--bg-card) 0%, var(--bg-secondary) 100%);
  border: 1px solid var(--border-dim);
  border-radius: var(--radius-lg);
  position: relative; overflow: hidden;
}
.hero::before {
  content: ''; position: absolute;
  top: -60%; right: -25%;
  width: 520px; height: 520px;
  background: radial-gradient(circle, rgba(232,151,63,.05) 0%, transparent 70%);
  pointer-events: none;
}
.hero::after {
  content: ''; position: absolute;
  bottom: -50%; left: -15%;
  width: 400px; height: 400px;
  background: radial-gradient(circle, rgba(232,93,93,.03) 0%, transparent 70%);
  pointer-events: none;
}
.hero h1 {
  font-family: var(--font-display);
  font-size: 34px; font-weight: 900;
  letter-spacing: -.03em; line-height: 1.15;
  margin-bottom: 14px; position: relative;
}
.hero .grad {
  background: linear-gradient(135deg, var(--accent-orange), var(--accent-red), var(--accent-purple));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text;
}
.hero .sub {
  font-size: 15.5px; color: var(--text-secondary);
  line-height: 1.6; position: relative; max-width: 600px;
}
.hero .stats {
  display: flex; gap: 14px; flex-wrap: wrap;
  margin-top: 20px; position: relative;
}
.hero .stats .stat {
  font-family: var(--font-mono); font-size: 11px;
  padding: 5px 14px; border-radius: 20px;
  border: 1px solid var(--border-dim);
  color: var(--text-secondary);
  display: flex; align-items: center; gap: 6px;
}
.hero .stats .stat b {
  color: var(--text-primary);
  font-weight: 600;
}

/* ===== SECTIONS ===== */
.section { margin-bottom: 54px; scroll-margin-top: 20px; }
h2 {
  font-family: var(--font-display);
  font-size: 27px; font-weight: 800;
  letter-spacing: -.02em; color: var(--text-primary);
  margin-bottom: 22px; padding-bottom: 12px;
  border-bottom: 2px solid var(--border-dim);
  display: flex; align-items: center; gap: 12px;
}
h2 .num {
  font-family: var(--font-mono); font-size: 12px; font-weight: 700;
  color: var(--accent-orange);
  background: rgba(232,151,63,.07);
  border: 1px solid rgba(232,151,63,.13);
  padding: 2px 10px; border-radius: 20px;
  flex-shrink: 0; line-height: 1.6;
}
h3 {
  font-family: var(--font-display);
  font-size: 18px; font-weight: 700;
  color: var(--text-primary);
  margin: 34px 0 10px;
  padding: 12px 16px;
  background: var(--bg-card);
  border: 1px solid var(--border-dim);
  border-radius: var(--radius-sm);
  border-left: 3px solid var(--accent-blue);
}
h4 {
  font-family: var(--font-display);
  font-size: 15.5px; font-weight: 600;
  color: var(--accent-orange);
  margin: 22px 0 8px;
}
p { margin-bottom: 13px; }
strong { color: var(--text-primary); font-weight: 600; }
a { color: var(--accent-blue); text-decoration: none; border-bottom: 1px solid rgba(90,141,247,.25); transition: border-color .15s; }
a:hover { border-bottom-color: var(--accent-blue); }
ul, ol { margin: 10px 0 14px 22px; color: var(--text-secondary); }
li { margin-bottom: 3px; }
hr { border: none; height: 1px; background: var(--border-dim); margin: 44px 0; }

/* ===== DIFFICULTY BADGES ===== */
.badge {
  display: inline-block;
  font-family: var(--font-mono);
  font-size: 11px; font-weight: 600;
  padding: 2px 10px;
  border-radius: 12px;
  vertical-align: middle;
  letter-spacing: .02em;
}
.badge.easy {
  background: rgba(69,192,136,.1);
  border: 1px solid rgba(69,192,136,.2);
  color: var(--accent-green);
}
.badge.medium {
  background: rgba(232,201,75,.08);
  border: 1px solid rgba(232,201,75,.18);
  color: var(--accent-yellow);
}
.badge.advanced {
  background: rgba(232,151,63,.08);
  border: 1px solid rgba(232,151,63,.18);
  color: var(--accent-orange);
}
.badge.expert {
  background: rgba(232,93,93,.08);
  border: 1px solid rgba(232,93,93,.18);
  color: var(--accent-red);
}

/* ===== CODE ===== */
.highlight {
  background: var(--bg-code) !important;
  border: 1px solid var(--border-dim);
  border-radius: var(--radius-md);
  padding: 18px 22px;
  margin: 14px 0 18px;
  overflow-x: auto;
  font-size: 13.5px; line-height: 1.65;
}
.highlight pre {
  background: transparent !important;
  border: none !important;
  padding: 0 !important; margin: 0 !important;
  overflow-x: auto;
}
.highlight code {
  font-family: var(--font-mono) !important;
  font-size: 13.5px;
  background: transparent !important;
}
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.highlight .hll { background-color: #49483e }
.highlight { background: #272822; color: #F8F8F2 }
.highlight .c { color: #959077 } /* Comment */
.highlight .err { color: #ED007E; background-color: #1E0010 } /* Error */
.highlight .esc { color: #F8F8F2 } /* Escape */
.highlight .g { color: #F8F8F2 } /* Generic */
.highlight .k { color: #66D9EF } /* Keyword */
.highlight .l { color: #AE81FF } /* Literal */
.highlight .n { color: #F8F8F2 } /* Name */
.highlight .o { color: #FF4689 } /* Operator */
.highlight .x { color: #F8F8F2 } /* Other */
.highlight .p { color: #F8F8F2 } /* Punctuation */
.highlight .ch { color: #959077 } /* Comment.Hashbang */
.highlight .cm { color: #959077 } /* Comment.Multiline */
.highlight .cp { color: #959077 } /* Comment.Preproc */
.highlight .cpf { color: #959077 } /* Comment.PreprocFile */
.highlight .c1 { color: #959077 } /* Comment.Single */
.highlight .cs { color: #959077 } /* Comment.Special */
.highlight .gd { color: #FF4689 } /* Generic.Deleted */
.highlight .ge { color: #F8F8F2; font-style: italic } /* Generic.Emph */
.highlight .ges { color: #F8F8F2; font-weight: bold; font-style: italic } /* Generic.EmphStrong */
.highlight .gr { color: #F8F8F2 } /* Generic.Error */
.highlight .gh { color: #F8F8F2 } /* Generic.Heading */
.highlight .gi { color: #A6E22E } /* Generic.Inserted */
.highlight .go { color: #66D9EF } /* Generic.Output */
.highlight .gp { color: #FF4689; font-weight: bold } /* Generic.Prompt */
.highlight .gs { color: #F8F8F2; font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #959077 } /* Generic.Subheading */
.highlight .gt { color: #F8F8F2 } /* Generic.Traceback */
.highlight .kc { color: #66D9EF } /* Keyword.Constant */
.highlight .kd { color: #66D9EF } /* Keyword.Declaration */
.highlight .kn { color: #FF4689 } /* Keyword.Namespace */
.highlight .kp { color: #66D9EF } /* Keyword.Pseudo */
.highlight .kr { color: #66D9EF } /* Keyword.Reserved */
.highlight .kt { color: #66D9EF } /* Keyword.Type */
.highlight .ld { color: #E6DB74 } /* Literal.Date */
.highlight .m { color: #AE81FF } /* Literal.Number */
.highlight .s { color: #E6DB74 } /* Literal.String */
.highlight .na { color: #A6E22E } /* Name.Attribute */
.highlight .nb { color: #F8F8F2 } /* Name.Builtin */
.highlight .nc { color: #A6E22E } /* Name.Class */
.highlight .no { color: #66D9EF } /* Name.Constant */
.highlight .nd { color: #A6E22E } /* Name.Decorator */
.highlight .ni { color: #F8F8F2 } /* Name.Entity */
.highlight .ne { color: #A6E22E } /* Name.Exception */
.highlight .nf { color: #A6E22E } /* Name.Function */
.highlight .nl { color: #F8F8F2 } /* Name.Label */
.highlight .nn { color: #F8F8F2 } /* Name.Namespace */
.highlight .nx { color: #A6E22E } /* Name.Other */
.highlight .py { color: #F8F8F2 } /* Name.Property */
.highlight .nt { color: #FF4689 } /* Name.Tag */
.highlight .nv { color: #F8F8F2 } /* Name.Variable */
.highlight .ow { color: #FF4689 } /* Operator.Word */
.highlight .pm { color: #F8F8F2 } /* Punctuation.Marker */
.highlight .w { color: #F8F8F2 } /* Text.Whitespace */
.highlight .mb { color: #AE81FF } /* Literal.Number.Bin */
.highlight .mf { color: #AE81FF } /* Literal.Number.Float */
.highlight .mh { color: #AE81FF } /* Literal.Number.Hex */
.highlight .mi { color: #AE81FF } /* Literal.Number.Integer */
.highlight .mo { color: #AE81FF } /* Literal.Number.Oct */
.highlight .sa { color: #E6DB74 } /* Literal.String.Affix */
.highlight .sb { color: #E6DB74 } /* Literal.String.Backtick */
.highlight .sc { color: #E6DB74 } /* Literal.String.Char */
.highlight .dl { color: #E6DB74 } /* Literal.String.Delimiter */
.highlight .sd { color: #E6DB74 } /* Literal.String.Doc */
.highlight .s2 { color: #E6DB74 } /* Literal.String.Double */
.highlight .se { color: #AE81FF } /* Literal.String.Escape */
.highlight .sh { color: #E6DB74 } /* Literal.String.Heredoc */
.highlight .si { color: #E6DB74 } /* Literal.String.Interpol */
.highlight .sx { color: #E6DB74 } /* Literal.String.Other */
.highlight .sr { color: #E6DB74 } /* Literal.String.Regex */
.highlight .s1 { color: #E6DB74 } /* Literal.String.Single */
.highlight .ss { color: #E6DB74 } /* Literal.String.Symbol */
.highlight .bp { color: #F8F8F2 } /* Name.Builtin.Pseudo */
.highlight .fm { color: #A6E22E } /* Name.Function.Magic */
.highlight .vc { color: #F8F8F2 } /* Name.Variable.Class */
.highlight .vg { color: #F8F8F2 } /* Name.Variable.Global */
.highlight .vi { color: #F8F8F2 } /* Name.Variable.Instance */
.highlight .vm { color: #F8F8F2 } /* Name.Variable.Magic */
.highlight .il { color: #AE81FF } /* Literal.Number.Integer.Long */

code {
  font-family: var(--font-mono); font-size: 13.5px;
}
p > code, li > code, td > code, a > code, strong > code,
h3 > code, h4 > code {
  background: rgba(90,141,247,.07);
  border: 1px solid rgba(90,141,247,.09);
  color: var(--accent-cyan);
  padding: 1px 6px; border-radius: 4px;
  font-size: .86em;
}

/* ===== TABLES ===== */
table {
  width: 100%; border-collapse: collapse;
  margin: 14px 0 18px; font-size: 14px;
}
th {
  font-family: var(--font-display); font-weight: 600;
  text-align: left; padding: 9px 14px;
  background: var(--bg-card);
  border: 1px solid var(--border-dim);
  color: var(--accent-blue); font-size: 13px;
}
td {
  padding: 7px 14px;
  border: 1px solid var(--border-dim);
  color: var(--text-secondary);
}

/* ===== BLOCKQUOTE ===== */
blockquote {
  border-left: 3px solid var(--accent-orange);
  background: rgba(232,151,63,.04);
  padding: 12px 18px;
  margin: 14px 0 18px;
  border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
  color: var(--text-secondary);
  font-size: 15px;
}
blockquote strong { color: var(--text-primary); }

/* ===== MOBILE ===== */
.mob-btn {
  display: none; position: fixed;
  top: 62px; left: 10px; z-index: 200;
  width: 38px; height: 38px;
  background: var(--bg-card);
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius-sm);
  color: var(--text-primary); font-size: 19px;
  cursor: pointer; align-items: center; justify-content: center;
  line-height: 1;
}
@media (max-width: 900px) {
  .sidebar { transform: translateX(-100%); }
  .topnav { height: 48px; }
  .progress { top: 48px !important; }
  .sidebar.open { transform: translateX(0); box-shadow: 4px 0 40px rgba(0,0,0,.6); }
  .main { margin-left: 0; padding: 28px 18px 80px; }
  .hero { padding: 24px; }
  .hero h1 { font-size: 24px; }
  .mob-btn { display: flex; }
}

/* ===== BACK-TOP ===== */
.btt {
  position: fixed; bottom: 22px; right: 22px;
  width: 42px; height: 42px;
  background: var(--bg-card);
  border: 1px solid var(--border-subtle);
  border-radius: 50%; color: var(--accent-orange);
  font-size: 17px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  opacity: 0; transform: translateY(8px);
  transition: all .2s ease; z-index: 150;
}
.btt.show { opacity: 1; transform: translateY(0); }
.btt:hover { background: var(--accent-orange); color: var(--bg-primary); }

/* ===== DETAILS/SUMMARY (Solutions) ===== */
details {
  margin: 16px 0 24px;
  border: 1px solid var(--border-dim);
  border-radius: var(--radius-md);
  background: rgba(78, 205, 196, 0.02);
  overflow: hidden;
}
details[open] {
  background: var(--bg-card);
  border-color: rgba(78, 205, 196, 0.15);
}
details summary {
  padding: 12px 18px;
  cursor: pointer;
  font-family: var(--font-display);
  font-size: 14px;
  font-weight: 600;
  color: var(--accent-cyan);
  background: rgba(78, 205, 196, 0.04);
  border-bottom: 1px solid transparent;
  user-select: none;
  transition: all 0.15s ease;
  list-style: none;
  display: flex;
  align-items: center;
  gap: 8px;
}
details summary::-webkit-details-marker { display: none; }
details summary::before {
  content: '‚ñ∂';
  font-size: 10px;
  transition: transform 0.2s ease;
}
details[open] summary::before { transform: rotate(90deg); }
details[open] summary {
  border-bottom-color: var(--border-dim);
  background: rgba(78, 205, 196, 0.06);
}
details summary:hover {
  background: rgba(78, 205, 196, 0.08);
}
details .solution-content {
  padding: 18px 20px;
  font-size: 15px;
  line-height: 1.7;
  animation: fadeIn 0.2s ease;
}
details .solution-content p { margin-bottom: 10px; }
details .solution-content .highlight {
  margin: 10px 0 14px;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-5px); }
  to { opacity: 1; transform: translateY(0); }
}


/* ===== TOP NAV ===== */
.topnav {
  position: fixed; top: 0; left: 0; right: 0;
  height: 54px; z-index: 900;
  background: rgba(12, 14, 20, 0.85);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border-bottom: 1px solid var(--border-dim);
  display: flex; align-items: center;
  padding: 0 32px; gap: 6px;
}
.topnav-logo {
  font-family: var(--font-display);
  font-size: 16px; font-weight: 800;
  letter-spacing: -.02em;
  background: linear-gradient(135deg, var(--accent-cyan), var(--accent-blue));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-right: 24px;
  text-decoration: none;
}
.topnav a.nav-link {
  font-family: var(--font-display);
  font-size: 13.5px; font-weight: 500;
  color: var(--text-secondary);
  text-decoration: none;
  padding: 6px 16px;
  border-radius: 8px;
  transition: all .15s ease;
}
.topnav a.nav-link:hover {
  color: var(--text-primary);
  background: var(--glow-blue);
}
.topnav a.nav-link.active {
  color: var(--accent-cyan);
  background: rgba(78,205,196,.08);
}
@media (max-width: 900px) {
  .topnav { padding: 0 12px 0 54px; height: 48px; }
  .topnav-logo { margin-right: 10px; font-size: 14px; }
  .topnav a.nav-link { font-size: 12px; padding: 4px 8px; }
}

</style>
</head>
<body>

<nav class="topnav">
  <a href="index.html" class="topnav-logo">GLua Hub</a>
  <a href="index.html" class="nav-link ">Inicio</a>
  <a href="curso-glua.html" class="nav-link ">Curso GLua</a>
  <a href="ejercicios-glua.html" class="nav-link active">Ejercicios</a>
</nav>


<div class="progress" id="prog"></div>
<button class="mob-btn" id="mobBtn" onclick="document.getElementById('sb').classList.toggle('open')">‚ò∞</button>

<aside class="sidebar" id="sb">
  <div class="sb-head">
    <h1>Ejercicios GLua</h1>
    <small>Extensi√≥n del Curso ¬∑ Pr√°ctica</small>
  </div>
  <nav class="sb-nav">
    <a href="#1-fundamentos-y-realms"><span class="snum">01</span> Fundamentos y Realms</a>
    <a href="#ejercicio-11-detectar-el-realm-facil" class="sub">Ejercicio 1.1 ‚Äî Detectar el Realm (‚≠ê F√°cil)</a>
    <a href="#ejercicio-12-autorun-correcto-facil" class="sub">Ejercicio 1.2 ‚Äî Autorun Correcto (‚≠ê F√°cil)</a>
    <a href="#ejercicio-13-orden-de-ejecucion-intermedio" class="sub">Ejercicio 1.3 ‚Äî Orden de Ejecuci√≥n (‚≠ê‚≠ê Intermedio)</a>
    <a href="#2-hooks-y-timers"><span class="snum">02</span> Hooks y Timers</a>
    <a href="#ejercicio-21-mensaje-de-bienvenida-con-delay-facil" class="sub">Ejercicio 2.1 ‚Äî Mensaje de Bienvenida con Delay (‚≠ê F√°cil)</a>
    <a href="#ejercicio-22-contador-de-muertes-en-racha-intermedio" class="sub">Ejercicio 2.2 ‚Äî Contador de Muertes en Racha (‚≠ê‚≠ê Intermedio)</a>
    <a href="#ejercicio-23-sistema-de-afk-intermedio" class="sub">Ejercicio 2.3 ‚Äî Sistema de AFK (‚≠ê‚≠ê Intermedio)</a>
    <a href="#ejercicio-24-encontrar-el-bug-hook-duplicado-facil" class="sub">Ejercicio 2.4 ‚Äî Encontrar el Bug: Hook Duplicado (‚≠ê F√°cil)</a>
    <a href="#ejercicio-25-anti-spam-de-chat-intermedio" class="sub">Ejercicio 2.5 ‚Äî Anti-Spam de Chat (‚≠ê‚≠ê Intermedio)</a>
    <a href="#3-entidades-y-player"><span class="snum">03</span> Entidades y Player</a>
    <a href="#ejercicio-31-comando-hp-facil" class="sub">Ejercicio 3.1 ‚Äî Comando !hp (‚≠ê F√°cil)</a>
    <a href="#ejercicio-32-explodin-props-cercanos-intermedio" class="sub">Ejercicio 3.2 ‚Äî Explod√≠n Props Cercanos (‚≠ê‚≠ê Intermedio)</a>
    <a href="#ejercicio-33-encontrar-el-bug-entidad-invalida-facil" class="sub">Ejercicio 3.3 ‚Äî Encontrar el Bug: Entidad Inv√°lida (‚≠ê F√°cil)</a>
    <a href="#ejercicio-34-teleport-al-trace-facil" class="sub">Ejercicio 3.4 ‚Äî Teleport al Trace (‚≠ê F√°cil)</a>
    <a href="#ejercicio-35-sistema-de-puntos-de-spawn-avanzado" class="sub">Ejercicio 3.5 ‚Äî Sistema de Puntos de Spawn (‚≠ê‚≠ê‚≠ê Avanzado)</a>
    <a href="#4-networking"><span class="snum">04</span> Networking</a>
    <a href="#ejercicio-41-notificacion-del-server-al-client-facil" class="sub">Ejercicio 4.1 ‚Äî Notificaci√≥n del Server al Client (‚≠ê F√°cil)</a>
    <a href="#ejercicio-42-encontrar-el-bug-net-desincronizado-intermedio" class="sub">Ejercicio 4.2 ‚Äî Encontrar el Bug: Net Desincronizado (‚≠ê‚≠ê Intermedio)</a>
    <a href="#ejercicio-43-sistema-de-votacion-avanzado" class="sub">Ejercicio 4.3 ‚Äî Sistema de Votaci√≥n (‚≠ê‚≠ê‚≠ê Avanzado)</a>
    <a href="#ejercicio-44-rate-limiting-de-net-messages-intermedio" class="sub">Ejercicio 4.4 ‚Äî Rate Limiting de Net Messages (‚≠ê‚≠ê Intermedio)</a>
    <a href="#ejercicio-45-sincronizar-un-inventario-simple-avanzado" class="sub">Ejercicio 4.5 ‚Äî Sincronizar un Inventario Simple (‚≠ê‚≠ê‚≠ê Avanzado)</a>
    <a href="#5-almacenamiento-de-datos"><span class="snum">05</span> Almacenamiento de Datos</a>
    <a href="#ejercicio-51-guardar-y-cargar-config-facil" class="sub">Ejercicio 5.1 ‚Äî Guardar y Cargar Config (‚≠ê F√°cil)</a>
    <a href="#ejercicio-52-sistema-de-bans-con-sqlite-intermedio" class="sub">Ejercicio 5.2 ‚Äî Sistema de Bans con SQLite (‚≠ê‚≠ê Intermedio)</a>
    <a href="#ejercicio-53-encontrar-el-bug-sql-injection-facil" class="sub">Ejercicio 5.3 ‚Äî Encontrar el Bug: SQL Injection (‚≠ê F√°cil)</a>
    <a href="#ejercicio-54-estadisticas-persistentes-avanzado" class="sub">Ejercicio 5.4 ‚Äî Estad√≠sticas Persistentes (‚≠ê‚≠ê‚≠ê Avanzado)</a>
    <a href="#6-http-y-servicios-externos"><span class="snum">06</span> HTTP y Servicios Externos</a>
    <a href="#ejercicio-61-webhook-de-discord-para-reportes-intermedio" class="sub">Ejercicio 6.1 ‚Äî Webhook de Discord para Reportes (‚≠ê‚≠ê Intermedio)</a>
    <a href="#ejercicio-62-api-de-servidor-avanzado" class="sub">Ejercicio 6.2 ‚Äî API de Servidor (‚≠ê‚≠ê‚≠ê Avanzado)</a>
    <a href="#ejercicio-63-sistema-de-motd-desde-url-intermedio" class="sub">Ejercicio 6.3 ‚Äî Sistema de MOTD desde URL (‚≠ê‚≠ê Intermedio)</a>
    <a href="#7-renderizado-2d-y-hud"><span class="snum">07</span> Renderizado 2D y HUD</a>
    <a href="#ejercicio-71-hud-de-vida-con-animacion-intermedio" class="sub">Ejercicio 7.1 ‚Äî HUD de Vida con Animaci√≥n (‚≠ê‚≠ê Intermedio)</a>
    <a href="#ejercicio-72-indicador-de-dano-direccional-avanzado" class="sub">Ejercicio 7.2 ‚Äî Indicador de Da√±o Direccional (‚≠ê‚≠ê‚≠ê Avanzado)</a>
    <a href="#ejercicio-73-texto-flotante-sobre-jugadores-intermedio" class="sub">Ejercicio 7.3 ‚Äî Texto Flotante sobre Jugadores (‚≠ê‚≠ê Intermedio)</a>
    <a href="#ejercicio-74-minimap-basico-avanzado" class="sub">Ejercicio 7.4 ‚Äî Minimap B√°sico (‚≠ê‚≠ê‚≠ê Avanzado)</a>
    <a href="#ejercicio-75-disenar-este-hud-intermedio" class="sub">Ejercicio 7.5 ‚Äî Dise√±ar este HUD (‚≠ê‚≠ê Intermedio)</a>
    <a href="#8-vgui-y-derma"><span class="snum">08</span> VGUI y Derma</a>
    <a href="#ejercicio-81-panel-de-informacion-de-jugador-facil" class="sub">Ejercicio 8.1 ‚Äî Panel de Informaci√≥n de Jugador (‚≠ê F√°cil)</a>
    <a href="#ejercicio-82-menu-de-configuracion-con-guardado-intermedio" class="sub">Ejercicio 8.2 ‚Äî Men√∫ de Configuraci√≥n con Guardado (‚≠ê‚≠ê Intermedio)</a>
    <a href="#ejercicio-83-disenar-una-tienda-con-ui-completa-avanzado" class="sub">Ejercicio 8.3 ‚Äî Dise√±ar una Tienda con UI Completa (‚≠ê‚≠ê‚≠ê Avanzado)</a>
    <a href="#ejercicio-84-encontrar-el-bug-panel-que-no-cierra-facil" class="sub">Ejercicio 8.4 ‚Äî Encontrar el Bug: Panel que No Cierra (‚≠ê F√°cil)</a>
    <a href="#ejercicio-85-sistema-de-tabs-personalizado-intermedio" class="sub">Ejercicio 8.5 ‚Äî Sistema de Tabs Personalizado (‚≠ê‚≠ê Intermedio)</a>
    <a href="#ejercicio-86-popup-de-confirmacion-reutilizable-intermedio" class="sub">Ejercicio 8.6 ‚Äî Popup de Confirmaci√≥n Reutilizable (‚≠ê‚≠ê Intermedio)</a>
    <a href="#9-renderizado-3d"><span class="snum">09</span> Renderizado 3D</a>
    <a href="#ejercicio-91-letrero-3d-sobre-entidad-facil" class="sub">Ejercicio 9.1 ‚Äî Letrero 3D sobre Entidad (‚≠ê F√°cil)</a>
    <a href="#ejercicio-92-panel-3d-interactivo-avanzado" class="sub">Ejercicio 9.2 ‚Äî Panel 3D Interactivo (‚≠ê‚≠ê‚≠ê Avanzado)</a>
    <a href="#10-sweps-armas-scripteadas"><span class="snum">10</span> SWEPs (Armas Scripteadas)</a>
    <a href="#ejercicio-101-arma-de-gravedad-simple-intermedio" class="sub">Ejercicio 10.1 ‚Äî Arma de Gravedad Simple (‚≠ê‚≠ê Intermedio)</a>
    <a href="#ejercicio-102-arma-de-curacion-por-area-intermedio" class="sub">Ejercicio 10.2 ‚Äî Arma de Curaci√≥n por √Årea (‚≠ê‚≠ê Intermedio)</a>
    <a href="#ejercicio-103-encontrar-el-bug-arma-que-no-funciona-en-multiplayer-intermedio" class="sub">Ejercicio 10.3 ‚Äî Encontrar el Bug: Arma que No Funciona en Multiplayer (‚≠ê‚≠ê Intermedio)</a>
    <a href="#ejercicio-104-swep-con-modos-alternables-avanzado" class="sub">Ejercicio 10.4 ‚Äî SWEP con Modos Alternables (‚≠ê‚≠ê‚≠ê Avanzado)</a>
    <a href="#11-sents-entidades-scripteadas"><span class="snum">11</span> SENTs (Entidades Scripteadas)</a>
    <a href="#ejercicio-111-trampa-explosiva-intermedio" class="sub">Ejercicio 11.1 ‚Äî Trampa Explosiva (‚≠ê‚≠ê Intermedio)</a>
    <a href="#ejercicio-112-maquina-expendedora-avanzado" class="sub">Ejercicio 11.2 ‚Äî M√°quina Expendedora (‚≠ê‚≠ê‚≠ê Avanzado)</a>
    <a href="#ejercicio-113-checkpoint-persistente-intermedio" class="sub">Ejercicio 11.3 ‚Äî Checkpoint Persistente (‚≠ê‚≠ê Intermedio)</a>
    <a href="#12-seguridad-y-debugging"><span class="snum">12</span> Seguridad y Debugging</a>
    <a href="#ejercicio-121-encontrar-todas-las-vulnerabilidades-avanzado" class="sub">Ejercicio 12.1 ‚Äî Encontrar Todas las Vulnerabilidades (‚≠ê‚≠ê‚≠ê Avanzado)</a>
    <a href="#ejercicio-122-blindar-un-net-receive-intermedio" class="sub">Ejercicio 12.2 ‚Äî Blindar un Net Receive (‚≠ê‚≠ê Intermedio)</a>
    <a href="#ejercicio-123-debug-logger-intermedio" class="sub">Ejercicio 12.3 ‚Äî Debug Logger (‚≠ê‚≠ê Intermedio)</a>
    <a href="#13-optimizacion"><span class="snum">13</span> Optimizaci√≥n</a>
    <a href="#ejercicio-131-encontrar-los-problemas-de-performance-intermedio" class="sub">Ejercicio 13.1 ‚Äî Encontrar los Problemas de Performance (‚≠ê‚≠ê Intermedio)</a>
    <a href="#ejercicio-132-benchmark-de-metodos-intermedio" class="sub">Ejercicio 13.2 ‚Äî Benchmark de M√©todos (‚≠ê‚≠ê Intermedio)</a>
    <a href="#ejercicio-133-cache-inteligente-de-entidades-avanzado" class="sub">Ejercicio 13.3 ‚Äî Cach√© Inteligente de Entidades (‚≠ê‚≠ê‚≠ê Avanzado)</a>
    <a href="#135-metatables-y-oop"><span class="snum">13.5</span> Metatables y OOP</a>
    <a href="#ejercicio-135-1-sistema-de-inventario-con-oop-intermedio" class="sub">Ejercicio 13.5.1 ‚Äî Sistema de Inventario con OOP (‚≠ê‚≠ê Intermedio)</a>
    <a href="#ejercicio-135-2-extender-metatable-de-player-intermedio" class="sub">Ejercicio 13.5.2 ‚Äî Extender la Metatable de Player (‚≠ê‚≠ê Intermedio)</a>
    <a href="#14-desafios-integradores"><span class="snum">14</span> Desaf√≠os Integradores</a>
    <a href="#desafio-141-sistema-de-duelos-avanzado" class="sub">Desaf√≠o 14.1 ‚Äî Sistema de Duelos (‚≠ê‚≠ê‚≠ê Avanzado)</a>
    <a href="#desafio-142-addon-de-carteles-personalizados-avanzado" class="sub">Desaf√≠o 14.2 ‚Äî Addon de Carteles Personalizados (‚≠ê‚≠ê‚≠ê Avanzado)</a>
    <a href="#desafio-143-gamemode-rey-de-la-colina-experto" class="sub">Desaf√≠o 14.3 ‚Äî Gamemode: Rey de la Colina (‚≠ê‚≠ê‚≠ê‚≠ê Experto)</a>
    <a href="#desafio-144-dashboard-de-admin-experto" class="sub">Desaf√≠o 14.4 ‚Äî Dashboard de Admin (‚≠ê‚≠ê‚≠ê‚≠ê Experto)</a>
    <a href="#desafio-145-sistema-de-misionesquests-experto" class="sub">Desaf√≠o 14.5 ‚Äî Sistema de Misiones/Quests (‚≠ê‚≠ê‚≠ê‚≠ê Experto)</a>
    <a href="#15-preguntas-teoricas"><span class="snum">15</span> Preguntas Te√≥ricas</a>
    <a href="#pregunta-151" class="sub">Pregunta 15.1</a>
    <a href="#pregunta-152" class="sub">Pregunta 15.2</a>
    <a href="#pregunta-153" class="sub">Pregunta 15.3</a>
    <a href="#pregunta-154" class="sub">Pregunta 15.4</a>
    <a href="#pregunta-155" class="sub">Pregunta 15.5</a>
    <a href="#pregunta-156" class="sub">Pregunta 15.6</a>
    <a href="#pregunta-157" class="sub">Pregunta 15.7</a>
    <a href="#pregunta-158" class="sub">Pregunta 15.8</a>
  </nav>
</aside>

<main class="main">

<div class="hero">
  <h1>Ejercicios Pr√°cticos de <span class="grad">GLua</span></h1>
  <p class="sub">P√°gina complementaria al Curso Completo de GLua. Ejercicios organizados por dificultad y categor√≠a: desde scripts simples hasta addons completos de producci√≥n.</p>
  <div class="stats">
    <div class="stat">üéØ <b>60+</b> ejercicios</div>
    <div class="stat">üêõ <b>9</b> find-the-bug</div>
    <div class="stat">üèóÔ∏è <b>5</b> desaf√≠os integradores</div>
    <div class="stat">üí¨ <b>8</b> preguntas te√≥ricas</div>
  </div>
</div>

<h1 id="ejercicios-practicos-de-glua-extension-del-curso">Ejercicios Pr√°cticos de GLua ‚Äî Extensi√≥n del Curso</h1>
<blockquote>
<p>P√°gina complementaria al Curso Completo de GLua. Ejercicios organizados por dificultad y categor√≠a para practicar cada sistema del motor.</p>
</blockquote>
<hr />
<h2 id="1-fundamentos-y-realms"><span class="num">01</span> Fundamentos y Realms</h2>
<h3 id="ejercicio-11-addon-base-compartido-intermedio">Ejercicio 1.1 ‚Äî Addon Base Compartido <span class="badge medium">‚≠ê‚≠ê Intermedio</span></h3>
<p>Cre√° la estructura completa de un addon llamado <code>mi_sistema</code> con separaci√≥n correcta de realms. Debe tener:</p>
<ul>
<li>Un archivo de autorun (<code>lua/autorun/mi_sistema_init.lua</code>) que inicialice todo</li>
<li>Un archivo shared de configuraci√≥n (<code>lua/mi_sistema/sh_config.lua</code>) con una tabla de settings</li>
<li>Un m√≥dulo de servidor (<code>lua/mi_sistema/sv_core.lua</code>) que registre hooks y comandos</li>
<li>Un m√≥dulo de cliente (<code>lua/mi_sistema/cl_hud.lua</code>) que dibuje algo simple en pantalla</li>
</ul>
<p>El autorun debe usar <code>AddCSLuaFile</code> correctamente para cada archivo que necesite el cliente, <code>include()</code> con guardas de realm, y la config shared debe ser accesible desde ambos lados. El server debe tener un comando de chat <code>!info</code> que imprima datos del config, y el client debe mostrar el nombre del addon en pantalla.</p>
<p><strong>Objetivos:</strong> <code>AddCSLuaFile</code>, <code>include</code>, <code>SERVER</code>/<code>CLIENT</code>, estructura de addon, tablas de configuraci√≥n compartidas</p>

<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<p><strong>Estructura de archivos:</strong></p>
<div class="highlight"><pre><div class="highlight"><pre><span></span>addons/mi_sistema/
‚îú‚îÄ‚îÄ lua/
‚îÇ   ‚îú‚îÄ‚îÄ autorun/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ mi_sistema_init.lua
‚îÇ   ‚îî‚îÄ‚îÄ mi_sistema/
‚îÇ       ‚îú‚îÄ‚îÄ sh_config.lua
‚îÇ       ‚îú‚îÄ‚îÄ sv_core.lua
‚îÇ       ‚îî‚îÄ‚îÄ cl_hud.lua</pre></div></pre></div>

<p><strong>lua/autorun/mi_sistema_init.lua:</strong></p>
<div class="highlight"><pre><div class="highlight"><pre><span></span>-- Archivo de entrada del addon
-- Se ejecuta en SERVER y CLIENT (est√° en autorun/)

MiSistema = MiSistema or {}

-- El server env√≠a los archivos cl_ y sh_ al cliente
if SERVER then
    AddCSLuaFile()  -- env√≠a este mismo archivo
    AddCSLuaFile("mi_sistema/sh_config.lua")
    AddCSLuaFile("mi_sistema/cl_hud.lua")
end

-- Shared se incluye en ambos lados
include("mi_sistema/sh_config.lua")

-- Cada realm incluye solo lo que le corresponde
if SERVER then
    include("mi_sistema/sv_core.lua")
end

if CLIENT then
    include("mi_sistema/cl_hud.lua")
end

MsgC(
    Color(232, 151, 63), "[MiSistema] ",
    Color(255, 255, 255), "Cargado en " .. (SERVER and "SERVER" or "CLIENT") .. "\n"
)</pre></div></pre></div>

<p><strong>lua/mi_sistema/sh_config.lua:</strong></p>
<div class="highlight"><pre><div class="highlight"><pre><span></span>-- Configuraci√≥n compartida ‚Äî accesible desde server y client
MiSistema.Config = {
    Nombre = "Mi Sistema v1.0",
    Prefijo = "[MS]",
    MaxVida = 150,
    VelocidadBase = 250,
    Colores = {
        Primario = Color(78, 205, 196),
        Secundario = Color(232, 151, 63),
        Error = Color(232, 93, 93),
    },
}</pre></div></pre></div>

<p><strong>lua/mi_sistema/sv_core.lua:</strong></p>
<div class="highlight"><pre><div class="highlight"><pre><span></span>-- Solo se ejecuta en el servidor

hook.Add("PlayerSay", "MiSistema_Info", function(ply, text)
    if string.lower(text) == "!info" then
        local cfg = MiSistema.Config
        ply:ChatPrint(cfg.Prefijo .. " Addon: " .. cfg.Nombre)
        ply:ChatPrint(cfg.Prefijo .. " Max Vida: " .. cfg.MaxVida)
        ply:ChatPrint(cfg.Prefijo .. " Velocidad Base: " .. cfg.VelocidadBase)
        return ""
    end
end)

hook.Add("PlayerSpawn", "MiSistema_Spawn", function(ply)
    timer.Simple(0.1, function()
        if not IsValid(ply) then return end
        ply:SetMaxHealth(MiSistema.Config.MaxVida)
        ply:SetHealth(MiSistema.Config.MaxVida)
        ply:SetRunSpeed(MiSistema.Config.VelocidadBase)
    end)
end)</pre></div></pre></div>

<p><strong>lua/mi_sistema/cl_hud.lua:</strong></p>
<div class="highlight"><pre><div class="highlight"><pre><span></span>-- Solo se ejecuta en el cliente

hook.Add("HUDPaint", "MiSistema_HUD", function()
    local cfg = MiSistema.Config
    draw.SimpleText(
        cfg.Nombre,
        "DermaDefaultBold",
        ScrW() - 10, 10,
        cfg.Colores.Primario,
        TEXT_ALIGN_RIGHT, TEXT_ALIGN_TOP
    )
end)</pre></div></pre></div>

<p><strong>Puntos clave:</strong> 1) <code>AddCSLuaFile()</code> sin argumento env√≠a el archivo actual. Con argumento, env√≠a ese archivo relativo a <code>lua/</code>. 2) Nunca incluyas <code>sv_</code> en el cliente ni <code>cl_</code> en el servidor. 3) La tabla global <code>MiSistema</code> se inicializa con <code>or {}</code> para evitar sobreescribirla en hot-reload. 4) <code>sh_config.lua</code> se incluye sin guarda porque es shared.</p>

</div>
</details>
<h3 id="ejercicio-12-auto-loader-dinamico-avanzado">Ejercicio 1.2 ‚Äî Auto-loader Din√°mico <span class="badge advanced">‚≠ê‚≠ê‚≠ê Avanzado</span></h3>
<p>Cre√° un sistema de carga autom√°tica de archivos que escanee un directorio y los incluya seg√∫n su prefijo:</p>
<ul>
<li><code>sv_*.lua</code> ‚Äî solo se incluyen en el servidor</li>
<li><code>cl_*.lua</code> ‚Äî se env√≠an con <code>AddCSLuaFile</code> y se incluyen solo en el cliente</li>
<li><code>sh_*.lua</code> ‚Äî se env√≠an con <code>AddCSLuaFile</code> y se incluyen en ambos lados</li>
</ul>
<p>El loader debe ser una funci√≥n reutilizable que acepte la ruta del directorio como argumento. Debe imprimir en consola qu√© archivos carg√≥ y en qu√© realm. Probalo con al menos 3 archivos de ejemplo.</p>
<p><strong>Objetivos:</strong> <code>file.Find</code>, <code>string.StartsWith</code>, <code>AddCSLuaFile</code>, <code>include</code>, automatizaci√≥n de carga</p>

<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<div class="highlight"><pre><div class="highlight"><pre><span></span>-- lua/autorun/mi_addon_init.lua

MiAddon = MiAddon or {}

-- Funci√≥n reutilizable de auto-carga
-- dir: ruta relativa a lua/ (ej: "mi_addon/modules")
function MiAddon.CargarDirectorio(dir)
    local archivos, _ = file.Find(dir .. "/*.lua", "LUA")

    if not archivos then
        MsgC(Color(232, 93, 93), "[MiAddon] No se encontr√≥ el directorio: " .. dir .. "\n")
        return
    end

    -- Ordenar para carga predecible (sh_ primero, luego sv_/cl_)
    table.sort(archivos, function(a, b)
        local orden = {sh = 1, sv = 2, cl = 3}
        local preA = string.sub(a, 1, 2)
        local preB = string.sub(b, 1, 2)
        return (orden[preA] or 99) < (orden[preB] or 99)
    end)

    for _, archivo in ipairs(archivos) do
        local ruta = dir .. "/" .. archivo
        local prefijo = string.sub(archivo, 1, 3) -- "sv_", "cl_", "sh_"

        if prefijo == "sh_" then
            -- Shared: enviar al client e incluir en ambos
            if SERVER then
                AddCSLuaFile(ruta)
            end
            include(ruta)
            MsgC(Color(232, 201, 75), "[SHARED] ", Color(255,255,255), ruta .. "\n")

        elseif prefijo == "sv_" then
            -- Server only
            if SERVER then
                include(ruta)
                MsgC(Color(100, 255, 100), "[SERVER] ", Color(255,255,255), ruta .. "\n")
            end

        elseif prefijo == "cl_" then
            -- Client only
            if SERVER then
                AddCSLuaFile(ruta)
            end
            if CLIENT then
                include(ruta)
                MsgC(Color(100, 200, 255), "[CLIENT] ", Color(255,255,255), ruta .. "\n")
            end
        else
            -- Archivo sin prefijo reconocido, tratarlo como shared
            if SERVER then
                AddCSLuaFile(ruta)
            end
            include(ruta)
            MsgC(Color(160, 122, 232), "[AUTO]   ", Color(255,255,255), ruta .. " (sin prefijo, shared)\n")
        end
    end
end

-- Uso: cargar todos los m√≥dulos
if SERVER then
    AddCSLuaFile()  -- enviar este archivo al client
end

MiAddon.CargarDirectorio("mi_addon/modules")
MiAddon.CargarDirectorio("mi_addon/plugins") -- pod√©s agregar m√°s directorios</pre></div></pre></div>

<p><strong>Explicaci√≥n:</strong> 1) <code>file.Find</code> busca archivos con un patr√≥n en un path source (<code>"LUA"</code> = la carpeta <code>lua/</code>). 2) Ordenamos para que <code>sh_</code> se cargue primero ‚Äî as√≠ la config shared est√° disponible cuando los m√≥dulos sv/cl se ejecuten. 3) El fallback para archivos sin prefijo los trata como shared, lo cual es seguro. 4) Esta funci√≥n es reutilizable para cualquier addon ‚Äî simplemente cambi√° las rutas.</p>

</div>
</details>
<h3 id="ejercicio-13-orden-de-ejecucion-intermedio">Ejercicio 1.3 ‚Äî Orden de Ejecuci√≥n <span class="badge medium">‚≠ê‚≠ê Intermedio</span></h3>
<p>Sin ejecutar el c√≥digo, ¬øqu√© se imprime en la consola del <strong>servidor</strong> y qu√© en la del <strong>cliente</strong>? ¬øEn qu√© orden?</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- lua/autorun/test_orden.lua</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;A - Shared&quot;</span><span class="p">)</span>

<span class="kr">if</span><span class="w"> </span><span class="nv">SERVER</span><span class="w"> </span><span class="kr">then</span>
<span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;B - Server&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nf">AddCSLuaFile</span><span class="p">()</span>
<span class="kr">end</span>

<span class="kr">if</span><span class="w"> </span><span class="nv">CLIENT</span><span class="w"> </span><span class="kr">then</span>
<span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;C - Client&quot;</span><span class="p">)</span>
<span class="kr">end</span>

<span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;Initialize&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Test_Init&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span>
<span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;D - Initialize&quot;</span><span class="p">)</span>
<span class="kr">end</span><span class="p">)</span>

<span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;InitPostEntity&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Test_IPE&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span>
<span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;E - InitPostEntity&quot;</span><span class="p">)</span>
<span class="kr">end</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;F - Shared final&quot;</span><span class="p">)</span>
</code></pre></div>

<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<p><strong>Consola del servidor:</strong></p>
<div class="highlight"><pre><code>A - Shared
B - Server
F - Shared final
D - Initialize
E - InitPostEntity</code></pre></div>
<p><strong>Consola del cliente:</strong></p>
<div class="highlight"><pre><code>A - Shared
C - Client
F - Shared final
E - InitPostEntity</code></pre></div>
<p><strong>Explicaci√≥n:</strong> El c√≥digo "suelto" (A, B/C, F) se ejecuta inmediatamente al cargar. <code>Initialize</code> es un hook <strong>solo del servidor</strong>. <code>InitPostEntity</code> existe en ambos. <code>AddCSLuaFile()</code> sin argumentos env√≠a el archivo actual al cliente.</p>

</div>
</details>

<hr />
<h2 id="2-hooks-y-timers"><span class="num">02</span> Hooks y Timers</h2>
<h3 id="ejercicio-21-mensaje-de-bienvenida-con-delay-facil">Ejercicio 2.1 ‚Äî Mensaje de Bienvenida con Delay <span class="badge easy">‚≠ê F√°cil</span></h3>
<p>Escrib√≠ un hook que cuando un jugador se conecta al servidor (spawn inicial), le mande un mensaje de bienvenida al chat despu√©s de 3 segundos. Debe incluir su nombre.</p>
<p><strong>Objetivos:</strong> <code>PlayerInitialSpawn</code>, <code>timer.Simple</code>, <code>ChatPrint</code>, <code>IsValid</code></p>

<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- SERVER</span>
<span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;PlayerInitialSpawn&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;MiAddon_Bienvenida&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">ply</span><span class="p">)</span>
<span class="w">    </span><span class="nv">timer</span><span class="p">.</span><span class="nf">Simple</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nf">IsValid</span><span class="p">(</span><span class="nv">ply</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>
<span class="w">        </span><span class="nv">ply</span><span class="p">:</span><span class="nf">ChatPrint</span><span class="p">(</span><span class="s2">&quot;¬°Bienvenido al servidor, &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">Nick</span><span class="p">()</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;!&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kr">end</span><span class="p">)</span>
<span class="kr">end</span><span class="p">)</span>
</pre></div>
</pre></div>
<p><strong>Punto clave:</strong> Siempre verific√° <code>IsValid(ply)</code> dentro del callback de <code>timer.Simple</code> ‚Äî despu√©s de 3 segundos el jugador podr√≠a haberse desconectado.</p>

</div>
</details>
<h3 id="ejercicio-22-contador-de-muertes-en-racha-intermedio">Ejercicio 2.2 ‚Äî Contador de Muertes en Racha <span class="badge medium">‚≠ê‚≠ê Intermedio</span></h3>
<p>Implement√° un sistema de "kill streak": cada vez que un jugador mata a otro, se acumula un contador. Si muere, el contador se reinicia. Mostr√° en el chat mensajes especiales al llegar a 3, 5, 7 y 10 kills seguidos.</p>
<p><strong>Objetivos:</strong> <code>PlayerDeath</code>, tablas por jugador, <code>PlayerDisconnected</code> para limpiar</p>

<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- SERVER</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">streaks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{}}</span>

<span class="kd">local</span><span class="w"> </span><span class="nv">MENSAJES</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span>
<span class="w">    </span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot; est√° en racha (3 kills)!&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot; es imparable (5 kills)!&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot; es una leyenda (7 kills)!&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot; ¬°¬°¬°ES DIOS!!! (10 kills)!&quot;</span><span class="p">,</span>
<span class="p">}}</span>

<span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;PlayerDeath&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;MiAddon_KillStreak&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">victima</span><span class="p">,</span><span class="w"> </span><span class="nv">inflictor</span><span class="p">,</span><span class="w"> </span><span class="nv">atacante</span><span class="p">)</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nf">IsValid</span><span class="p">(</span><span class="nv">victima</span><span class="p">)</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">victima</span><span class="p">:</span><span class="nf">IsPlayer</span><span class="p">()</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">vStreak</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">streaks</span><span class="p">[</span><span class="nv">victima</span><span class="p">:</span><span class="nf">SteamID64</span><span class="p">()]</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">vStreak</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="nf">PrintMessage</span><span class="p">(</span><span class="nv">HUD_PRINTTALK</span><span class="p">,</span><span class="w"> </span><span class="nv">victima</span><span class="p">:</span><span class="nf">Nick</span><span class="p">()</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; perdi√≥ su racha de &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">vStreak</span><span class="p">)</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">        </span><span class="nv">streaks</span><span class="p">[</span><span class="nv">victima</span><span class="p">:</span><span class="nf">SteamID64</span><span class="p">()]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nf">IsValid</span><span class="p">(</span><span class="nv">atacante</span><span class="p">)</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">atacante</span><span class="p">:</span><span class="nf">IsPlayer</span><span class="p">()</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">atacante</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="nv">victima</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">sid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">atacante</span><span class="p">:</span><span class="nf">SteamID64</span><span class="p">()</span>
<span class="w">        </span><span class="nv">streaks</span><span class="p">[</span><span class="nv">sid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nv">streaks</span><span class="p">[</span><span class="nv">sid</span><span class="p">]</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">MENSAJES</span><span class="p">[</span><span class="nv">streaks</span><span class="p">[</span><span class="nv">sid</span><span class="p">]]</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">msg</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="nf">PrintMessage</span><span class="p">(</span><span class="nv">HUD_PRINTTALK</span><span class="p">,</span><span class="w"> </span><span class="nv">atacante</span><span class="p">:</span><span class="nf">Nick</span><span class="p">()</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">msg</span><span class="p">)</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">end</span>
<span class="kr">end</span><span class="p">)</span>

<span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;PlayerDisconnected&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;MiAddon_KillStreak_Limpiar&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">ply</span><span class="p">)</span>
<span class="w">    </span><span class="nv">streaks</span><span class="p">[</span><span class="nv">ply</span><span class="p">:</span><span class="nf">SteamID64</span><span class="p">()]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">nil</span>
<span class="kr">end</span><span class="p">)</span>
</pre></div>
</pre></div>

</div>
</details>
<h3 id="ejercicio-23-sistema-de-afk-intermedio">Ejercicio 2.3 ‚Äî Sistema de AFK <span class="badge medium">‚≠ê‚≠ê Intermedio</span></h3>
<p>Cre√° un sistema que detecte jugadores AFK. Si un jugador no se mueve durante 5 minutos, marcarlos como AFK y avisar al servidor. Si se mueven de nuevo, quitar la marca. Us√° <code>timer.Create</code> con identificador √∫nico por jugador.</p>
<p><strong>Pista:</strong> Guard√° la √∫ltima posici√≥n conocida y comparala cada 30 segundos.</p>

<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- SERVER</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">afkData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{}}</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">AFK_TIEMPO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">300</span>

<span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;PlayerInitialSpawn&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;AFK_Iniciar&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">ply</span><span class="p">)</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">sid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">SteamID64</span><span class="p">()</span>
<span class="w">    </span><span class="nv">afkData</span><span class="p">[</span><span class="nv">sid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="nv">ultimaPos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">GetPos</span><span class="p">(),</span><span class="w"> </span><span class="nv">ultimoMov</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">CurTime</span><span class="p">(),</span><span class="w"> </span><span class="nv">esAFK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">}}</span>

<span class="w">    </span><span class="nv">timer</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;AFK_Check_&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">sid</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nf">IsValid</span><span class="p">(</span><span class="nv">ply</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="nv">timer</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="s2">&quot;AFK_Check_&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">sid</span><span class="p">)</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">afkData</span><span class="p">[</span><span class="nv">sid</span><span class="p">]</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">data</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>

<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">GetPos</span><span class="p">():</span><span class="nf">DistToSqr</span><span class="p">(</span><span class="nv">data</span><span class="p">.</span><span class="py">ultimaPos</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="nv">data</span><span class="p">.</span><span class="py">ultimaPos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">GetPos</span><span class="p">()</span>
<span class="w">            </span><span class="nv">data</span><span class="p">.</span><span class="py">ultimoMov</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">CurTime</span><span class="p">()</span>
<span class="w">            </span><span class="kr">if</span><span class="w"> </span><span class="nv">data</span><span class="p">.</span><span class="py">esAFK</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                </span><span class="nv">data</span><span class="p">.</span><span class="py">esAFK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">                </span><span class="nf">PrintMessage</span><span class="p">(</span><span class="nv">HUD_PRINTTALK</span><span class="p">,</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">Nick</span><span class="p">()</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; ya no est√° AFK&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="kr">end</span>
<span class="w">        </span><span class="kr">else</span>
<span class="w">            </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">data</span><span class="p">.</span><span class="py">esAFK</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="p">(</span><span class="nf">CurTime</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">data</span><span class="p">.</span><span class="py">ultimoMov</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nv">AFK_TIEMPO</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                </span><span class="nv">data</span><span class="p">.</span><span class="py">esAFK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">                </span><span class="nf">PrintMessage</span><span class="p">(</span><span class="nv">HUD_PRINTTALK</span><span class="p">,</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">Nick</span><span class="p">()</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; est√° AFK&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="kr">end</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">end</span><span class="p">)</span>
<span class="kr">end</span><span class="p">)</span>

<span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;PlayerDisconnected&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;AFK_Limpiar&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">ply</span><span class="p">)</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">sid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">SteamID64</span><span class="p">()</span>
<span class="w">    </span><span class="nv">timer</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="s2">&quot;AFK_Check_&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">sid</span><span class="p">)</span>
<span class="w">    </span><span class="nv">afkData</span><span class="p">[</span><span class="nv">sid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">nil</span>
<span class="kr">end</span><span class="p">)</span>
</pre></div>
</pre></div>
<p><strong>Nota:</strong> Se usa <code>DistToSqr</code> en vez de <code>Distance</code> por rendimiento (evita ra√≠z cuadrada).</p>

</div>
</details>
<h3 id="ejercicio-24-encontrar-el-bug-hook-duplicado-facil">Ejercicio 2.4 ‚Äî Encontrar el Bug: Hook Duplicado <span class="badge easy">‚≠ê F√°cil</span></h3>
<p>Este c√≥digo tiene un problema que causa que el mensaje se muestre cada vez m√°s veces al recargar el archivo con Auto Refresh. ¬øPor qu√©? ¬øC√≥mo lo arregl√°s?</p>
<div class="highlight"><pre><span></span><code><span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;PlayerSay&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nb">math.random</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">99999</span><span class="p">)),</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">ply</span><span class="p">,</span><span class="w"> </span><span class="nv">text</span><span class="p">)</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;!test&quot;</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="nv">ply</span><span class="p">:</span><span class="nf">ChatPrint</span><span class="p">(</span><span class="s2">&quot;Funciona!&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="kr">end</span>
<span class="kr">end</span><span class="p">)</span>
</code></pre></div>


<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<p><strong>El problema:</strong> El identificador del hook es <code>tostring(math.random(1, 99999))</code> ‚Äî un n√∫mero aleatorio diferente cada recarga. Cada Auto Refresh crea un <strong>nuevo</strong> hook sin eliminar los anteriores.</p>
<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- SOLUCI√ìN: Identificador fijo y √∫nico</span>
<span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;PlayerSay&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;MiAddon_TestCommand&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">ply</span><span class="p">,</span><span class="w"> </span><span class="nv">text</span><span class="p">)</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;!test&quot;</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="nv">ply</span><span class="p">:</span><span class="nf">ChatPrint</span><span class="p">(</span><span class="s2">&quot;Funciona!&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="kr">end</span>
<span class="kr">end</span><span class="p">)</span>
</pre></div>
</pre></div>
<p><strong>Regla:</strong> Siempre us√° un identificador fijo con prefijo de tu addon.</p>

</div>
</details>
<h3 id="ejercicio-25-anti-spam-de-chat-intermedio">Ejercicio 2.5 ‚Äî Anti-Spam de Chat <span class="badge medium">‚≠ê‚≠ê Intermedio</span></h3>
<p>Implement√° un sistema anti-spam en el chat: si un jugador manda m√°s de 3 mensajes en 5 segundos, se le bloquea el chat por 10 segundos y se le notifica. Despu√©s de los 10 segundos, puede volver a hablar.</p>
<p><strong>Objetivos:</strong> <code>PlayerSay</code>, tablas de timestamps, <code>CurTime()</code></p>
<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- SERVER</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">chatHistory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{}}</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">mutedUntil</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{}}</span>

<span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;PlayerSay&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;AntiSpam_Check&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">ply</span><span class="p">,</span><span class="w"> </span><span class="nv">text</span><span class="p">)</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">sid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">SteamID64</span><span class="p">()</span>

<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">mutedUntil</span><span class="p">[</span><span class="nv">sid</span><span class="p">]</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nf">CurTime</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nv">mutedUntil</span><span class="p">[</span><span class="nv">sid</span><span class="p">]</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="nv">ply</span><span class="p">:</span><span class="nf">ChatPrint</span><span class="p">(</span><span class="s2">&quot;[Anti-Spam] Silenciado. Esper√° &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">math.ceil</span><span class="p">(</span><span class="nv">mutedUntil</span><span class="p">[</span><span class="nv">sid</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nf">CurTime</span><span class="p">())</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;s&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="nv">chatHistory</span><span class="p">[</span><span class="nv">sid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">chatHistory</span><span class="p">[</span><span class="nv">sid</span><span class="p">]</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="p">{{}}</span>
<span class="w">    </span><span class="nb">table.insert</span><span class="p">(</span><span class="nv">chatHistory</span><span class="p">[</span><span class="nv">sid</span><span class="p">],</span><span class="w"> </span><span class="nf">CurTime</span><span class="p">())</span>

<span class="w">    </span><span class="c1">-- Limpiar mensajes fuera de la ventana de 5 segundos</span>
<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">#</span><span class="nv">chatHistory</span><span class="p">[</span><span class="nv">sid</span><span class="p">],</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">chatHistory</span><span class="p">[</span><span class="nv">sid</span><span class="p">][</span><span class="nv">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nf">CurTime</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="nb">table.remove</span><span class="p">(</span><span class="nv">chatHistory</span><span class="p">[</span><span class="nv">sid</span><span class="p">],</span><span class="w"> </span><span class="nv">i</span><span class="p">)</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="o">#</span><span class="nv">chatHistory</span><span class="p">[</span><span class="nv">sid</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="nv">mutedUntil</span><span class="p">[</span><span class="nv">sid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">CurTime</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">10</span>
<span class="w">        </span><span class="nv">chatHistory</span><span class="p">[</span><span class="nv">sid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{}}</span>
<span class="w">        </span><span class="nv">ply</span><span class="p">:</span><span class="nf">ChatPrint</span><span class="p">(</span><span class="s2">&quot;[Anti-Spam] Silenciado por 10s&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="kr">end</span>
<span class="kr">end</span><span class="p">)</span>

<span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;PlayerDisconnected&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;AntiSpam_Limpiar&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">ply</span><span class="p">)</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">sid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">SteamID64</span><span class="p">()</span>
<span class="w">    </span><span class="nv">chatHistory</span><span class="p">[</span><span class="nv">sid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">    </span><span class="nv">mutedUntil</span><span class="p">[</span><span class="nv">sid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">nil</span>
<span class="kr">end</span><span class="p">)</span>
</pre></div>
</pre></div>

</div>
</details>

<hr />
<h2 id="3-entidades-y-player"><span class="num">03</span> Entidades y Player</h2>
<h3 id="ejercicio-31-comando-hp-facil">Ejercicio 3.1 ‚Äî Comando !hp <span class="badge easy">‚≠ê F√°cil</span></h3>
<p>Cre√° un comando de chat <code>!hp</code> que muestre la vida del jugador y la entidad a la que est√° mirando (si hay alguna). Si no est√° mirando nada, decir "No est√°s mirando nada".</p>
<p><strong>Objetivos:</strong> <code>PlayerSay</code>, <code>GetEyeTrace</code>, <code>IsValid</code>, <code>Health</code>, <code>GetClass</code></p>

<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- SERVER</span>
<span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;PlayerSay&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;MiAddon_CmdHP&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">ply</span><span class="p">,</span><span class="w"> </span><span class="nv">text</span><span class="p">)</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;!hp&quot;</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="nv">ply</span><span class="p">:</span><span class="nf">ChatPrint</span><span class="p">(</span><span class="s2">&quot;Tu vida: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">Health</span><span class="p">()</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;/&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">GetMaxHealth</span><span class="p">())</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">tr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">GetEyeTrace</span><span class="p">()</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nf">IsValid</span><span class="p">(</span><span class="nv">tr</span><span class="p">.</span><span class="py">Entity</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="nv">ply</span><span class="p">:</span><span class="nf">ChatPrint</span><span class="p">(</span><span class="s2">&quot;Mirando: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">tr</span><span class="p">.</span><span class="py">Entity</span><span class="p">:</span><span class="nf">GetClass</span><span class="p">()</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; | HP: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">tr</span><span class="p">.</span><span class="py">Entity</span><span class="p">:</span><span class="nf">Health</span><span class="p">())</span>
<span class="w">        </span><span class="kr">else</span>
<span class="w">            </span><span class="nv">ply</span><span class="p">:</span><span class="nf">ChatPrint</span><span class="p">(</span><span class="s2">&quot;No est√°s mirando ninguna entidad&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="kr">end</span>
<span class="kr">end</span><span class="p">)</span>
</pre></div>
</pre></div>

</div>
</details>
<h3 id="ejercicio-32-explodin-props-cercanos-intermedio">Ejercicio 3.2 ‚Äî Explod√≠n Props Cercanos <span class="badge medium">‚≠ê‚≠ê Intermedio</span></h3>
<p>Cre√° un comando de admin <code>!boom</code> que cree una explosi√≥n en la posici√≥n del jugador, eliminando todos los <code>prop_physics</code> en un radio de 500 unidades. Mostr√° cu√°ntos props fueron destruidos.</p>
<p><strong>Objetivos:</strong> <code>ents.FindInSphere</code>, <code>ent:GetClass()</code>, <code>ent:Remove()</code>, verificaci√≥n de admin</p>

<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- SERVER</span>
<span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;PlayerSay&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;MiAddon_Boom&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">ply</span><span class="p">,</span><span class="w"> </span><span class="nv">text</span><span class="p">)</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="s2">&quot;!boom&quot;</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">IsAdmin</span><span class="p">()</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">ChatPrint</span><span class="p">(</span><span class="s2">&quot;Necesit√°s ser admin&quot;</span><span class="p">)</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="kr">end</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">ent</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">ents</span><span class="p">.</span><span class="nf">FindInSphere</span><span class="p">(</span><span class="nv">ply</span><span class="p">:</span><span class="nf">GetPos</span><span class="p">(),</span><span class="w"> </span><span class="mi">500</span><span class="p">))</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nf">IsValid</span><span class="p">(</span><span class="nv">ent</span><span class="p">)</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">ent</span><span class="p">:</span><span class="nf">GetClass</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;prop_physics&quot;</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="kd">local</span><span class="w"> </span><span class="nv">ed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">EffectData</span><span class="p">()</span>
<span class="w">            </span><span class="nv">ed</span><span class="p">:</span><span class="nf">SetOrigin</span><span class="p">(</span><span class="nv">ent</span><span class="p">:</span><span class="nf">GetPos</span><span class="p">())</span>
<span class="w">            </span><span class="nv">util</span><span class="p">.</span><span class="nf">Effect</span><span class="p">(</span><span class="s2">&quot;Explosion&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">ed</span><span class="p">)</span>
<span class="w">            </span><span class="nf">SafeRemoveEntity</span><span class="p">(</span><span class="nv">ent</span><span class="p">)</span>
<span class="w">            </span><span class="nv">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">count</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="nv">ply</span><span class="p">:</span><span class="nf">ChatPrint</span><span class="p">(</span><span class="s2">&quot;¬°BOOM! &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">count</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; props destruidos&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="kr">end</span><span class="p">)</span>
</pre></div>
</pre></div>

</div>
</details>
<h3 id="ejercicio-33-encontrar-el-bug-entidad-invalida-facil">Ejercicio 3.3 ‚Äî Encontrar el Bug: Entidad Inv√°lida <span class="badge easy">‚≠ê F√°cil</span></h3>
<p>¬øPor qu√© este c√≥digo tira error a veces? Arreglalo.</p>
<div class="highlight"><pre><span></span><code><span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;PlayerDeath&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;MiAddon_Muerte&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">victima</span><span class="p">,</span><span class="w"> </span><span class="nv">inflictor</span><span class="p">,</span><span class="w"> </span><span class="nv">atacante</span><span class="p">)</span>
<span class="w">    </span><span class="nv">atacante</span><span class="p">:</span><span class="nf">AddFrags</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="nv">atacante</span><span class="p">:</span><span class="nf">ChatPrint</span><span class="p">(</span><span class="s2">&quot;¬°Mataste a &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">victima</span><span class="p">:</span><span class="nf">Nick</span><span class="p">()</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;!&quot;</span><span class="p">)</span>
<span class="kr">end</span><span class="p">)</span>
</code></pre></div>

<p><strong>Pista:</strong> ¬øQu√© pasa si el jugador muere por ca√≠da, por el mundo, o se mata a s√≠ mismo?</p>

<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<p><strong>El problema:</strong> <code>atacante</code> puede ser <code>NULL</code> (muerte por el mundo/ca√≠da), una entidad no-jugador (NPC), o el mismo jugador (suicidio). Llamar m√©todos sobre <code>NULL</code> causa error.</p>
<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- CORREGIDO</span>
<span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;PlayerDeath&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;MiAddon_Muerte&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">victima</span><span class="p">,</span><span class="w"> </span><span class="nv">inflictor</span><span class="p">,</span><span class="w"> </span><span class="nv">atacante</span><span class="p">)</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nf">IsValid</span><span class="p">(</span><span class="nv">atacante</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">atacante</span><span class="p">:</span><span class="nf">IsPlayer</span><span class="p">()</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">atacante</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">victima</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>

<span class="w">    </span><span class="nv">atacante</span><span class="p">:</span><span class="nf">AddFrags</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="nv">atacante</span><span class="p">:</span><span class="nf">ChatPrint</span><span class="p">(</span><span class="s2">&quot;¬°Mataste a &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">victima</span><span class="p">:</span><span class="nf">Nick</span><span class="p">()</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;!&quot;</span><span class="p">)</span>
<span class="kr">end</span><span class="p">)</span>
</pre></div>
</pre></div>

</div>
</details>
<h3 id="ejercicio-34-teleport-al-trace-facil">Ejercicio 3.4 ‚Äî Teleport al Trace <span class="badge easy">‚≠ê F√°cil</span></h3>
<p>Cre√° un comando de consola <code>mi_tp</code> (solo admin) que teletransporte al jugador a donde est√° mirando. Asegurate de que no quede atrapado en el piso sumando un offset vertical.</p>

<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- SERVER</span>
<span class="nv">concommand</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;mi_tp&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">ply</span><span class="p">)</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nf">IsValid</span><span class="p">(</span><span class="nv">ply</span><span class="p">)</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">IsAdmin</span><span class="p">()</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">tr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">GetEyeTrace</span><span class="p">()</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">tr</span><span class="p">.</span><span class="py">Hit</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">ChatPrint</span><span class="p">(</span><span class="s2">&quot;No hay superficie&quot;</span><span class="p">)</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>

<span class="w">    </span><span class="nv">ply</span><span class="p">:</span><span class="nf">SetPos</span><span class="p">(</span><span class="nv">tr</span><span class="p">.</span><span class="py">HitPos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">tr</span><span class="p">.</span><span class="py">HitNormal</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span>
<span class="w">    </span><span class="nv">ply</span><span class="p">:</span><span class="nf">ChatPrint</span><span class="p">(</span><span class="s2">&quot;Teletransportado!&quot;</span><span class="p">)</span>
<span class="kr">end</span><span class="p">)</span>
</pre></div>
</pre></div>
<p><strong>Nota:</strong> Se usa <code>tr.HitNormal * 10</code> en vez de solo <code>Vector(0,0,10)</code> porque si teleport√°s contra una pared, la normal apunta hacia afuera, evitando quedar atrapado.</p>

</div>
</details>
<h3 id="ejercicio-35-sistema-de-puntos-de-spawn-avanzado">Ejercicio 3.5 ‚Äî Sistema de Puntos de Spawn <span class="badge advanced">‚≠ê‚≠ê‚≠ê Avanzado</span></h3>
<p>Cre√° un addon que permita a los admins colocar puntos de spawn personalizados con <code>!addspawn</code>. Los puntos deben guardarse con <code>file</code> (JSON) y cargarse al iniciar el servidor. Los jugadores deben spawnear en un punto aleatorio de la lista.</p>
<p><strong>Objetivos:</strong> <code>PlayerSpawn</code>, <code>file.Write/Read</code>, <code>util.TableToJSON</code>, <code>SetPos</code>, manejo de archivo vac√≠o/inexistente</p>
<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- SERVER</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">spawns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{}}</span>

<span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">CargarSpawns</span><span class="p">()</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">file</span><span class="p">.</span><span class="nf">Exists</span><span class="p">(</span><span class="s2">&quot;mi_addon/spawns.json&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;DATA&quot;</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="nv">spawns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">util</span><span class="p">.</span><span class="nf">JSONToTable</span><span class="p">(</span><span class="nv">file</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="s2">&quot;mi_addon/spawns.json&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;DATA&quot;</span><span class="p">))</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="p">{{}}</span>
<span class="w">    </span><span class="kr">end</span>
<span class="kr">end</span>

<span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">GuardarSpawns</span><span class="p">()</span>
<span class="w">    </span><span class="nv">file</span><span class="p">.</span><span class="nf">CreateDir</span><span class="p">(</span><span class="s2">&quot;mi_addon&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">file</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="s2">&quot;mi_addon/spawns.json&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">util</span><span class="p">.</span><span class="nf">TableToJSON</span><span class="p">(</span><span class="nv">spawns</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">))</span>
<span class="kr">end</span>

<span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;Initialize&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Spawns_Cargar&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">CargarSpawns</span><span class="p">)</span>

<span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;PlayerSay&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Spawns_Cmd&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">ply</span><span class="p">,</span><span class="w"> </span><span class="nv">text</span><span class="p">)</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;!addspawn&quot;</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">IsAdmin</span><span class="p">()</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">p</span><span class="p">,</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">GetPos</span><span class="p">(),</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">EyeAngles</span><span class="p">()</span>
<span class="w">        </span><span class="nb">table.insert</span><span class="p">(</span><span class="nv">spawns</span><span class="p">,</span><span class="w"> </span><span class="p">{{</span><span class="nv">x</span><span class="o">=</span><span class="nv">p</span><span class="p">.</span><span class="py">x</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="o">=</span><span class="nv">p</span><span class="p">.</span><span class="py">y</span><span class="p">,</span><span class="w"> </span><span class="nv">z</span><span class="o">=</span><span class="nv">p</span><span class="p">.</span><span class="py">z</span><span class="p">,</span><span class="w"> </span><span class="nv">p</span><span class="o">=</span><span class="nv">a</span><span class="p">.</span><span class="py">p</span><span class="p">,</span><span class="w"> </span><span class="nv">yaw</span><span class="o">=</span><span class="nv">a</span><span class="p">.</span><span class="py">y</span><span class="p">}})</span>
<span class="w">        </span><span class="nf">GuardarSpawns</span><span class="p">()</span>
<span class="w">        </span><span class="nv">ply</span><span class="p">:</span><span class="nf">ChatPrint</span><span class="p">(</span><span class="s2">&quot;Spawn #&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="o">#</span><span class="nv">spawns</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; guardado&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="kr">end</span>
<span class="kr">end</span><span class="p">)</span>

<span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;PlayerSpawn&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Spawns_Usar&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">ply</span><span class="p">)</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="o">#</span><span class="nv">spawns</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="nv">timer</span><span class="p">.</span><span class="nf">Simple</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nf">IsValid</span><span class="p">(</span><span class="nv">ply</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">sp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">spawns</span><span class="p">[</span><span class="nb">math.random</span><span class="p">(</span><span class="o">#</span><span class="nv">spawns</span><span class="p">)]</span>
<span class="w">        </span><span class="nv">ply</span><span class="p">:</span><span class="nf">SetPos</span><span class="p">(</span><span class="nf">Vector</span><span class="p">(</span><span class="nv">sp</span><span class="p">.</span><span class="py">x</span><span class="p">,</span><span class="w"> </span><span class="nv">sp</span><span class="p">.</span><span class="py">y</span><span class="p">,</span><span class="w"> </span><span class="nv">sp</span><span class="p">.</span><span class="py">z</span><span class="p">))</span>
<span class="w">        </span><span class="nv">ply</span><span class="p">:</span><span class="nf">SetEyeAngles</span><span class="p">(</span><span class="nf">Angle</span><span class="p">(</span><span class="nv">sp</span><span class="p">.</span><span class="py">p</span><span class="p">,</span><span class="w"> </span><span class="nv">sp</span><span class="p">.</span><span class="py">yaw</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<span class="w">    </span><span class="kr">end</span><span class="p">)</span>
<span class="kr">end</span><span class="p">)</span>
</pre></div>
</pre></div>
<p><strong>Notas:</strong> El <code>timer.Simple(0, ...)</code> es necesario porque <code>SetPos</code> en <code>PlayerSpawn</code> puede ser sobreescrito por el gamemode. Los Vectors se guardan como tablas simples porque <code>util.TableToJSON</code> no serializa objetos Vector.</p>

</div>
</details>

<hr />
<h2 id="4-networking"><span class="num">04</span> Networking</h2>
<h3 id="ejercicio-41-notificacion-del-server-al-client-facil">Ejercicio 4.1 ‚Äî Notificaci√≥n del Server al Client <span class="badge easy">‚≠ê F√°cil</span></h3>
<p>Cre√° un sistema donde el servidor pueda enviar notificaciones al cliente con un mensaje de texto y un color. El cliente debe mostrarlo en el chat usando <code>chat.AddText</code>.</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- Uso desde el server:</span>
<span class="nf">NotificarJugador</span><span class="p">(</span><span class="nv">ply</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;¬°Subiste de nivel!&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">215</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
</code></pre></div>

<p><strong>Objetivos:</strong> <code>util.AddNetworkString</code>, <code>net.WriteString</code>, <code>net.WriteColor</code>, <code>net.Send</code></p>

<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- SERVER</span>
<span class="nv">util</span><span class="p">.</span><span class="nf">AddNetworkString</span><span class="p">(</span><span class="s2">&quot;MiAddon_Notificar&quot;</span><span class="p">)</span>

<span class="kr">function</span><span class="w"> </span><span class="nf">NotificarJugador</span><span class="p">(</span><span class="nv">ply</span><span class="p">,</span><span class="w"> </span><span class="nv">mensaje</span><span class="p">,</span><span class="w"> </span><span class="nv">color</span><span class="p">)</span>
<span class="w">    </span><span class="nv">net</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="s2">&quot;MiAddon_Notificar&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nv">net</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="nv">mensaje</span><span class="p">)</span>
<span class="w">        </span><span class="nv">net</span><span class="p">.</span><span class="nf">WriteColor</span><span class="p">(</span><span class="nv">color</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">))</span>
<span class="w">    </span><span class="nv">net</span><span class="p">.</span><span class="nf">Send</span><span class="p">(</span><span class="nv">ply</span><span class="p">)</span>
<span class="kr">end</span>

<span class="c1">-- CLIENT</span>
<span class="nv">net</span><span class="p">.</span><span class="nf">Receive</span><span class="p">(</span><span class="s2">&quot;MiAddon_Notificar&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">mensaje</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">net</span><span class="p">.</span><span class="nf">ReadString</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">net</span><span class="p">.</span><span class="nf">ReadColor</span><span class="p">()</span>
<span class="w">    </span><span class="nv">chat</span><span class="p">.</span><span class="nf">AddText</span><span class="p">(</span><span class="nv">color</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;[Notificaci√≥n] &quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">),</span><span class="w"> </span><span class="nv">mensaje</span><span class="p">)</span>
<span class="kr">end</span><span class="p">)</span>
</pre></div>
</pre></div>

</div>
</details>
<h3 id="ejercicio-42-encontrar-el-bug-net-desincronizado-intermedio">Ejercicio 4.2 ‚Äî Encontrar el Bug: Net Desincronizado <span class="badge medium">‚≠ê‚≠ê Intermedio</span></h3>
<p>Este c√≥digo tiene un bug sutil. El cliente a veces recibe datos incorrectos. ¬øPor qu√©?</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- SERVER</span>
<span class="nv">util</span><span class="p">.</span><span class="nf">AddNetworkString</span><span class="p">(</span><span class="s2">&quot;Datos_Enviar&quot;</span><span class="p">)</span>

<span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">EnviarDatos</span><span class="p">(</span><span class="nv">ply</span><span class="p">,</span><span class="w"> </span><span class="nv">nombre</span><span class="p">,</span><span class="w"> </span><span class="nv">nivel</span><span class="p">,</span><span class="w"> </span><span class="nv">esAdmin</span><span class="p">)</span>
<span class="w">    </span><span class="nv">net</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="s2">&quot;Datos_Enviar&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nv">net</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="nv">nombre</span><span class="p">)</span>
<span class="w">        </span><span class="nv">net</span><span class="p">.</span><span class="nf">WriteBool</span><span class="p">(</span><span class="nv">esAdmin</span><span class="p">)</span>
<span class="w">        </span><span class="nv">net</span><span class="p">.</span><span class="nf">WriteUInt</span><span class="p">(</span><span class="nv">nivel</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span>
<span class="w">    </span><span class="nv">net</span><span class="p">.</span><span class="nf">Send</span><span class="p">(</span><span class="nv">ply</span><span class="p">)</span>
<span class="kr">end</span>

<span class="c1">-- CLIENT</span>
<span class="nv">net</span><span class="p">.</span><span class="nf">Receive</span><span class="p">(</span><span class="s2">&quot;Datos_Enviar&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">nombre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">net</span><span class="p">.</span><span class="nf">ReadString</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">nivel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">net</span><span class="p">.</span><span class="nf">ReadUInt</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">esAdmin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">net</span><span class="p">.</span><span class="nf">ReadBool</span><span class="p">()</span>
<span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="nv">nombre</span><span class="p">,</span><span class="w"> </span><span class="nv">nivel</span><span class="p">,</span><span class="w"> </span><span class="nv">esAdmin</span><span class="p">)</span>
<span class="kr">end</span><span class="p">)</span>
</code></pre></div>


<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<p><strong>El problema:</strong> El orden de escritura y lectura no coincide. El servidor escribe <code>String ‚Üí Bool ‚Üí UInt</code> pero el cliente lee <code>String ‚Üí UInt ‚Üí Bool</code>. Los datos se leen como un stream de bits ‚Äî si el orden no coincide, todo se corrompe.</p>
<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- CORREGIDO: Write y Read deben ser espejo perfecto</span>
<span class="c1">-- SERVER: String -&gt; UInt -&gt; Bool</span>
<span class="nv">net</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="nv">nombre</span><span class="p">)</span>
<span class="nv">net</span><span class="p">.</span><span class="nf">WriteUInt</span><span class="p">(</span><span class="nv">nivel</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span>
<span class="nv">net</span><span class="p">.</span><span class="nf">WriteBool</span><span class="p">(</span><span class="nv">esAdmin</span><span class="p">)</span>

<span class="c1">-- CLIENT: String -&gt; UInt -&gt; Bool (mismo orden)</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">nombre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">net</span><span class="p">.</span><span class="nf">ReadString</span><span class="p">()</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">nivel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">net</span><span class="p">.</span><span class="nf">ReadUInt</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">esAdmin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">net</span><span class="p">.</span><span class="nf">ReadBool</span><span class="p">()</span>
</pre></div>
</pre></div>

</div>
</details>
<h3 id="ejercicio-43-sistema-de-votacion-avanzado">Ejercicio 4.3 ‚Äî Sistema de Votaci√≥n <span class="badge advanced">‚≠ê‚≠ê‚≠ê Avanzado</span></h3>
<p>Implement√° un sistema de votaci√≥n completo:
- Un admin escribe <code>!votar ¬øCambiar de mapa?</code> para iniciar una votaci√≥n.
- Todos los jugadores reciben un panel VGUI con los botones "S√≠" y "No".
- Cada jugador solo puede votar una vez.
- Despu√©s de 30 segundos, se cierra la votaci√≥n y se anuncia el resultado en el chat.</p>
<p><strong>Objetivos:</strong> <code>net</code>, <code>vgui.Create("DFrame")</code>, <code>DButton</code>, <code>timer.Create</code>, validaci√≥n server-side, control de estado</p>

<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<p>Este ejercicio requiere combinar net library + VGUI + timers + validaci√≥n server-side. La soluci√≥n involucra: el server registra el estado de la votaci√≥n y valida cada voto; el client muestra un DFrame con botones y lo auto-cierra al timeout.</p>
<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- SERVER</span>
<span class="nv">util</span><span class="p">.</span><span class="nf">AddNetworkString</span><span class="p">(</span><span class="s2">&quot;Votar_Abrir&quot;</span><span class="p">)</span>
<span class="nv">util</span><span class="p">.</span><span class="nf">AddNetworkString</span><span class="p">(</span><span class="s2">&quot;Votar_Enviar&quot;</span><span class="p">)</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">votacionActiva</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">votos</span><span class="p">,</span><span class="w"> </span><span class="nv">yaVotaron</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="nv">si</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nv">no</span><span class="o">=</span><span class="mi">0</span><span class="p">}},</span><span class="w"> </span><span class="p">{{}}</span>

<span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;PlayerSay&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Votar_Iniciar&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">ply</span><span class="p">,</span><span class="w"> </span><span class="nv">text</span><span class="p">)</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">string</span><span class="p">.</span><span class="nf">StartWith</span><span class="p">(</span><span class="nv">text</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;!votar &quot;</span><span class="p">)</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">IsAdmin</span><span class="p">()</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">votacionActiva</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">ChatPrint</span><span class="p">(</span><span class="s2">&quot;Ya hay una votaci√≥n activa&quot;</span><span class="p">)</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="kr">end</span>

<span class="w">    </span><span class="nv">votacionActiva</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="nv">votos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="nv">si</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nv">no</span><span class="o">=</span><span class="mi">0</span><span class="p">}}</span>
<span class="w">    </span><span class="nv">yaVotaron</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{}}</span>

<span class="w">    </span><span class="nv">net</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="s2">&quot;Votar_Abrir&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nv">net</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="nb">string.sub</span><span class="p">(</span><span class="nv">text</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">))</span>
<span class="w">    </span><span class="nv">net</span><span class="p">.</span><span class="nf">Broadcast</span><span class="p">()</span>

<span class="w">    </span><span class="nv">timer</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;Votar_Timeout&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span>
<span class="w">        </span><span class="nv">votacionActiva</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">votos</span><span class="p">.</span><span class="py">si</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nv">votos</span><span class="p">.</span><span class="py">no</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="s2">&quot;APROBADA&quot;</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nv">votos</span><span class="p">.</span><span class="py">si</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nv">votos</span><span class="p">.</span><span class="py">no</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="s2">&quot;RECHAZADA&quot;</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s2">&quot;EMPATE&quot;</span>
<span class="w">        </span><span class="nf">PrintMessage</span><span class="p">(</span><span class="nv">HUD_PRINTTALK</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;[Votaci√≥n] &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">res</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; (&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">votos</span><span class="p">.</span><span class="py">si</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; s√≠ / &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">votos</span><span class="p">.</span><span class="py">no</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; no)&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kr">end</span><span class="p">)</span>
<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="kr">end</span><span class="p">)</span>

<span class="nv">net</span><span class="p">.</span><span class="nf">Receive</span><span class="p">(</span><span class="s2">&quot;Votar_Enviar&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">len</span><span class="p">,</span><span class="w"> </span><span class="nv">ply</span><span class="p">)</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">votacionActiva</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nv">yaVotaron</span><span class="p">[</span><span class="nv">ply</span><span class="p">:</span><span class="nf">SteamID64</span><span class="p">()]</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="nv">yaVotaron</span><span class="p">[</span><span class="nv">ply</span><span class="p">:</span><span class="nf">SteamID64</span><span class="p">()]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">net</span><span class="p">.</span><span class="nf">ReadBool</span><span class="p">()</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="nv">votos</span><span class="p">.</span><span class="py">si</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">votos</span><span class="p">.</span><span class="py">si</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="nv">votos</span><span class="p">.</span><span class="py">no</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">votos</span><span class="p">.</span><span class="py">no</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="kr">end</span>
<span class="kr">end</span><span class="p">)</span>

<span class="c1">-- CLIENT</span>
<span class="nv">net</span><span class="p">.</span><span class="nf">Receive</span><span class="p">(</span><span class="s2">&quot;Votar_Abrir&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">pregunta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">net</span><span class="p">.</span><span class="nf">ReadString</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DFrame&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">frame</span><span class="p">:</span><span class="nf">SetSize</span><span class="p">(</span><span class="mi">350</span><span class="p">,</span><span class="w"> </span><span class="mi">150</span><span class="p">)</span>
<span class="w">    </span><span class="nv">frame</span><span class="p">:</span><span class="nf">Center</span><span class="p">()</span>
<span class="w">    </span><span class="nv">frame</span><span class="p">:</span><span class="nf">SetTitle</span><span class="p">(</span><span class="s2">&quot;Votaci√≥n: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">pregunta</span><span class="p">)</span>
<span class="w">    </span><span class="nv">frame</span><span class="p">:</span><span class="nf">MakePopup</span><span class="p">()</span>

<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">data</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">({{{</span><span class="s2">&quot;S√≠&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">},</span><span class="w"> </span><span class="p">{{</span><span class="s2">&quot;No&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">}}}})</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">btn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DButton&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">frame</span><span class="p">)</span>
<span class="w">        </span><span class="nv">btn</span><span class="p">:</span><span class="nf">Dock</span><span class="p">(</span><span class="nv">LEFT</span><span class="p">)</span>
<span class="w">        </span><span class="nv">btn</span><span class="p">:</span><span class="nf">SetWide</span><span class="p">(</span><span class="mi">160</span><span class="p">)</span>
<span class="w">        </span><span class="nv">btn</span><span class="p">:</span><span class="nf">DockMargin</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
<span class="w">        </span><span class="nv">btn</span><span class="p">:</span><span class="nf">SetText</span><span class="p">(</span><span class="nv">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="w">        </span><span class="nv">btn</span><span class="p">.</span><span class="py">DoClick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span>
<span class="w">            </span><span class="nv">net</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="s2">&quot;Votar_Enviar&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="nv">net</span><span class="p">.</span><span class="nf">WriteBool</span><span class="p">(</span><span class="nv">data</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="w">            </span><span class="nv">net</span><span class="p">.</span><span class="nf">SendToServer</span><span class="p">()</span>
<span class="w">            </span><span class="nv">frame</span><span class="p">:</span><span class="nf">Close</span><span class="p">()</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="nv">timer</span><span class="p">.</span><span class="nf">Simple</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span><span class="nf">IsValid</span><span class="p">(</span><span class="nv">frame</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="nv">frame</span><span class="p">:</span><span class="nf">Close</span><span class="p">()</span><span class="w"> </span><span class="kr">end</span><span class="w"> </span><span class="kr">end</span><span class="p">)</span>
<span class="kr">end</span><span class="p">)</span>
</pre></div>
</pre></div>

</div>
</details>
<h3 id="ejercicio-44-rate-limiting-de-net-messages-intermedio">Ejercicio 4.4 ‚Äî Rate Limiting de Net Messages <span class="badge medium">‚≠ê‚≠ê Intermedio</span></h3>
<p>Escrib√≠ una funci√≥n helper <code>NetRateLimited(nombre, ply, cooldown)</code> que retorne <code>true</code> si el jugador puede enviar el mensaje, o <code>false</code> si est√° en cooldown. Integrala en un <code>net.Receive</code> para proteger un endpoint.</p>

<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- SERVER</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">netCooldowns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{}}</span>

<span class="kr">function</span><span class="w"> </span><span class="nf">NetRateLimited</span><span class="p">(</span><span class="nv">nombre</span><span class="p">,</span><span class="w"> </span><span class="nv">ply</span><span class="p">,</span><span class="w"> </span><span class="nv">cooldown</span><span class="p">)</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">nombre</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;_&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">SteamID64</span><span class="p">()</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">netCooldowns</span><span class="p">[</span><span class="nv">key</span><span class="p">]</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nf">CurTime</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">netCooldowns</span><span class="p">[</span><span class="nv">key</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nv">cooldown</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="nv">netCooldowns</span><span class="p">[</span><span class="nv">key</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">CurTime</span><span class="p">()</span>
<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="kc">true</span>
<span class="kr">end</span>

<span class="c1">-- Uso:</span>
<span class="nv">net</span><span class="p">.</span><span class="nf">Receive</span><span class="p">(</span><span class="s2">&quot;MiAddon_Accion&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">len</span><span class="p">,</span><span class="w"> </span><span class="nv">ply</span><span class="p">)</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nf">NetRateLimited</span><span class="p">(</span><span class="s2">&quot;MiAddon_Accion&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">ply</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="c1">-- Procesar...</span>
<span class="kr">end</span><span class="p">)</span>

<span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;PlayerDisconnected&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;NetRL_Limpiar&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">ply</span><span class="p">)</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">sid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">SteamID64</span><span class="p">()</span>
<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">key</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">pairs</span><span class="p">(</span><span class="nv">netCooldowns</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nb">string.find</span><span class="p">(</span><span class="nv">key</span><span class="p">,</span><span class="w"> </span><span class="nv">sid</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="nv">netCooldowns</span><span class="p">[</span><span class="nv">key</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">end</span>
<span class="kr">end</span><span class="p">)</span>
</pre></div>
</pre></div>

</div>
</details>
<h3 id="ejercicio-45-sincronizar-un-inventario-simple-avanzado">Ejercicio 4.5 ‚Äî Sincronizar un Inventario Simple <span class="badge advanced">‚≠ê‚≠ê‚≠ê Avanzado</span></h3>
<p>Cre√° un inventario server-side con un m√°ximo de 10 slots. El servidor gestiona los items. El cliente puede pedir abrir el inventario (<code>net.SendToServer</code>), y el servidor le env√≠a el contenido. El cliente lo muestra en un <code>DFrame</code> con <code>DScrollPanel</code> y botones para "Usar" o "Tirar" cada item.</p>
<p><strong>Objetivos:</strong> Net bidireccional, validaci√≥n server-side, VGUI din√°mico, <code>net.WriteTable</code>/<code>ReadTable</code></p>
<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<p>El servidor mantiene el inventario y env√≠a los datos al cliente cuando los solicita. Cada acci√≥n se valida en el server.</p>
<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- === SERVER (sv_inventario.lua) ===</span>
<span class="nv">util</span><span class="p">.</span><span class="nf">AddNetworkString</span><span class="p">(</span><span class="s2">&quot;Inv_Pedir&quot;</span><span class="p">)</span>
<span class="nv">util</span><span class="p">.</span><span class="nf">AddNetworkString</span><span class="p">(</span><span class="s2">&quot;Inv_Datos&quot;</span><span class="p">)</span>
<span class="nv">util</span><span class="p">.</span><span class="nf">AddNetworkString</span><span class="p">(</span><span class="s2">&quot;Inv_Accion&quot;</span><span class="p">)</span>

<span class="kd">local</span><span class="w"> </span><span class="nv">inventarios</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">MAX_SLOTS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span>

<span class="kd">local</span><span class="w"> </span><span class="nv">ITEMS_DB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nv">medkit</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="nv">nombre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Kit M√©dico&quot;</span><span class="p">,</span><span class="w">  </span><span class="nv">desc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Cura 25 HP&quot;</span><span class="p">},</span>
<span class="w">    </span><span class="nv">armor</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="nv">nombre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Armadura&quot;</span><span class="p">,</span><span class="w">    </span><span class="nv">desc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;+50 armor&quot;</span><span class="p">},</span>
<span class="w">    </span><span class="nv">pistol</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="nv">nombre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Pistola&quot;</span><span class="p">,</span><span class="w">     </span><span class="nv">desc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Arma b√°sica&quot;</span><span class="p">},</span>
<span class="p">}</span>

<span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;PlayerInitialSpawn&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Inv_Init&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">ply</span><span class="p">)</span>
<span class="w">    </span><span class="nv">inventarios</span><span class="p">[</span><span class="nv">ply</span><span class="p">:</span><span class="nf">SteamID64</span><span class="p">()]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">inventarios</span><span class="p">[</span><span class="nv">ply</span><span class="p">:</span><span class="nf">SteamID64</span><span class="p">()]</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">{</span><span class="nv">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;medkit&quot;</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="nv">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;armor&quot;</span><span class="p">},</span>
<span class="w">    </span><span class="p">}</span>
<span class="kr">end</span><span class="p">)</span>

<span class="nv">net</span><span class="p">.</span><span class="nf">Receive</span><span class="p">(</span><span class="s2">&quot;Inv_Pedir&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">len</span><span class="p">,</span><span class="w"> </span><span class="nv">ply</span><span class="p">)</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">inv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">inventarios</span><span class="p">[</span><span class="nv">ply</span><span class="p">:</span><span class="nf">SteamID64</span><span class="p">()]</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="p">{}</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">enviar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">i</span><span class="p">,</span><span class="w"> </span><span class="nv">slot</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">inv</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ITEMS_DB</span><span class="p">[</span><span class="nv">slot</span><span class="p">.</span><span class="py">id</span><span class="p">]</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">info</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="nv">enviar</span><span class="p">[</span><span class="nv">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="nv">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">slot</span><span class="p">.</span><span class="py">id</span><span class="p">,</span><span class="w"> </span><span class="nv">nombre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">info</span><span class="p">.</span><span class="py">nombre</span><span class="p">,</span><span class="w"> </span><span class="nv">desc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">info</span><span class="p">.</span><span class="py">desc</span><span class="p">}</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">end</span>
<span class="w">    </span><span class="nv">net</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="s2">&quot;Inv_Datos&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nv">net</span><span class="p">.</span><span class="nf">WriteTable</span><span class="p">(</span><span class="nv">enviar</span><span class="p">)</span>
<span class="w">    </span><span class="nv">net</span><span class="p">.</span><span class="nf">Send</span><span class="p">(</span><span class="nv">ply</span><span class="p">)</span>
<span class="kr">end</span><span class="p">)</span>

<span class="nv">net</span><span class="p">.</span><span class="nf">Receive</span><span class="p">(</span><span class="s2">&quot;Inv_Accion&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">len</span><span class="p">,</span><span class="w"> </span><span class="nv">ply</span><span class="p">)</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">Alive</span><span class="p">()</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">accion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">net</span><span class="p">.</span><span class="nf">ReadString</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">indice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">net</span><span class="p">.</span><span class="nf">ReadUInt</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">sid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">SteamID64</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">inv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">inventarios</span><span class="p">[</span><span class="nv">sid</span><span class="p">]</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">inv</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">inv</span><span class="p">[</span><span class="nv">indice</span><span class="p">]</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">inv</span><span class="p">[</span><span class="nv">indice</span><span class="p">]</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">accion</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;usar&quot;</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">item</span><span class="p">.</span><span class="py">id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;medkit&quot;</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="nv">ply</span><span class="p">:</span><span class="nf">SetHealth</span><span class="p">(</span><span class="nb">math.min</span><span class="p">(</span><span class="nv">ply</span><span class="p">:</span><span class="nf">Health</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">25</span><span class="p">,</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">GetMaxHealth</span><span class="p">()))</span>
<span class="w">        </span><span class="kr">elseif</span><span class="w"> </span><span class="nv">item</span><span class="p">.</span><span class="py">id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;armor&quot;</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="nv">ply</span><span class="p">:</span><span class="nf">SetArmor</span><span class="p">(</span><span class="nb">math.min</span><span class="p">(</span><span class="nv">ply</span><span class="p">:</span><span class="nf">Armor</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">))</span>
<span class="w">        </span><span class="kr">elseif</span><span class="w"> </span><span class="nv">item</span><span class="p">.</span><span class="py">id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;pistol&quot;</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="nv">ply</span><span class="p">:</span><span class="nf">Give</span><span class="p">(</span><span class="s2">&quot;weapon_pistol&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">        </span><span class="nb">table.remove</span><span class="p">(</span><span class="nv">inv</span><span class="p">,</span><span class="w"> </span><span class="nv">indice</span><span class="p">)</span>
<span class="w">        </span><span class="nv">ply</span><span class="p">:</span><span class="nf">ChatPrint</span><span class="p">(</span><span class="s2">&quot;Usaste &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="p">(</span><span class="nv">ITEMS_DB</span><span class="p">[</span><span class="nv">item</span><span class="p">.</span><span class="py">id</span><span class="p">]</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">ITEMS_DB</span><span class="p">[</span><span class="nv">item</span><span class="p">.</span><span class="py">id</span><span class="p">].</span><span class="nv">nombre</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nv">item</span><span class="p">.</span><span class="py">id</span><span class="p">))</span>
<span class="w">    </span><span class="kr">elseif</span><span class="w"> </span><span class="nv">accion</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;tirar&quot;</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="nb">table.remove</span><span class="p">(</span><span class="nv">inv</span><span class="p">,</span><span class="w"> </span><span class="nv">indice</span><span class="p">)</span>
<span class="w">        </span><span class="nv">ply</span><span class="p">:</span><span class="nf">ChatPrint</span><span class="p">(</span><span class="s2">&quot;Tiraste el item&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kr">end</span>
<span class="kr">end</span><span class="p">)</span>

<span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;PlayerDisconnected&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Inv_Limpiar&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">ply</span><span class="p">)</span>
<span class="w">    </span><span class="c1">-- No limpiamos para que persista durante la sesi√≥n del server</span>
<span class="kr">end</span><span class="p">)</span>
</pre></div>
</pre></div>
<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- === CLIENT (cl_inventario.lua) ===</span>
<span class="nv">net</span><span class="p">.</span><span class="nf">Receive</span><span class="p">(</span><span class="s2">&quot;Inv_Datos&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">net</span><span class="p">.</span><span class="nf">ReadTable</span><span class="p">()</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DFrame&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">frame</span><span class="p">:</span><span class="nf">SetSize</span><span class="p">(</span><span class="mi">420</span><span class="p">,</span><span class="w"> </span><span class="mi">360</span><span class="p">)</span>
<span class="w">    </span><span class="nv">frame</span><span class="p">:</span><span class="nf">Center</span><span class="p">()</span>
<span class="w">    </span><span class="nv">frame</span><span class="p">:</span><span class="nf">SetTitle</span><span class="p">(</span><span class="s2">&quot;Inventario (&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="o">#</span><span class="nv">items</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;/&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;)&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">frame</span><span class="p">:</span><span class="nf">MakePopup</span><span class="p">()</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">scroll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DScrollPanel&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">frame</span><span class="p">)</span>
<span class="w">    </span><span class="nv">scroll</span><span class="p">:</span><span class="nf">Dock</span><span class="p">(</span><span class="nv">FILL</span><span class="p">)</span>

<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="o">#</span><span class="nv">items</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">lbl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">scroll</span><span class="p">:</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;DLabel&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nv">lbl</span><span class="p">:</span><span class="nf">Dock</span><span class="p">(</span><span class="nv">TOP</span><span class="p">)</span>
<span class="w">        </span><span class="nv">lbl</span><span class="p">:</span><span class="nf">SetText</span><span class="p">(</span><span class="s2">&quot;  Inventario vac√≠o&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nv">lbl</span><span class="p">:</span><span class="nf">SetTall</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span>
<span class="w">        </span><span class="kr">return</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">i</span><span class="p">,</span><span class="w"> </span><span class="nv">item</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">items</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">pnl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">scroll</span><span class="p">:</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;DPanel&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nv">pnl</span><span class="p">:</span><span class="nf">Dock</span><span class="p">(</span><span class="nv">TOP</span><span class="p">)</span>
<span class="w">        </span><span class="nv">pnl</span><span class="p">:</span><span class="nf">SetTall</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
<span class="w">        </span><span class="nv">pnl</span><span class="p">:</span><span class="nf">DockMargin</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="nv">pnl</span><span class="p">.</span><span class="py">Paint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">s</span><span class="p">,</span><span class="w"> </span><span class="nv">w</span><span class="p">,</span><span class="w"> </span><span class="nv">h</span><span class="p">)</span>
<span class="w">            </span><span class="nv">draw</span><span class="p">.</span><span class="nf">RoundedBox</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">w</span><span class="p">,</span><span class="w"> </span><span class="nv">h</span><span class="p">,</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">))</span>
<span class="w">        </span><span class="kr">end</span>

<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">lbl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DLabel&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">pnl</span><span class="p">)</span>
<span class="w">        </span><span class="nv">lbl</span><span class="p">:</span><span class="nf">SetPos</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span>
<span class="w">        </span><span class="nv">lbl</span><span class="p">:</span><span class="nf">SetFont</span><span class="p">(</span><span class="s2">&quot;DermaDefaultBold&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nv">lbl</span><span class="p">:</span><span class="nf">SetText</span><span class="p">(</span><span class="nv">item</span><span class="p">.</span><span class="py">nombre</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nv">item</span><span class="p">.</span><span class="py">id</span><span class="p">)</span>
<span class="w">        </span><span class="nv">lbl</span><span class="p">:</span><span class="nf">SizeToContents</span><span class="p">()</span>

<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">desc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DLabel&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">pnl</span><span class="p">)</span>
<span class="w">        </span><span class="nv">desc</span><span class="p">:</span><span class="nf">SetPos</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">25</span><span class="p">)</span>
<span class="w">        </span><span class="nv">desc</span><span class="p">:</span><span class="nf">SetText</span><span class="p">(</span><span class="nv">item</span><span class="p">.</span><span class="py">desc</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nv">desc</span><span class="p">:</span><span class="nf">SetColor</span><span class="p">(</span><span class="nf">Color</span><span class="p">(</span><span class="mi">180</span><span class="p">,</span><span class="w"> </span><span class="mi">180</span><span class="p">,</span><span class="w"> </span><span class="mi">180</span><span class="p">))</span>
<span class="w">        </span><span class="nv">desc</span><span class="p">:</span><span class="nf">SizeToContents</span><span class="p">()</span>

<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">DoAccion</span><span class="p">(</span><span class="nv">accion</span><span class="p">)</span>
<span class="w">            </span><span class="nv">net</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="s2">&quot;Inv_Accion&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="nv">net</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="nv">accion</span><span class="p">)</span>
<span class="w">                </span><span class="nv">net</span><span class="p">.</span><span class="nf">WriteUInt</span><span class="p">(</span><span class="nv">i</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span>
<span class="w">            </span><span class="nv">net</span><span class="p">.</span><span class="nf">SendToServer</span><span class="p">()</span>
<span class="w">            </span><span class="nv">frame</span><span class="p">:</span><span class="nf">Close</span><span class="p">()</span>
<span class="w">        </span><span class="kr">end</span>

<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">btnUsar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DButton&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">pnl</span><span class="p">)</span>
<span class="w">        </span><span class="nv">btnUsar</span><span class="p">:</span><span class="nf">SetPos</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span>
<span class="w">        </span><span class="nv">btnUsar</span><span class="p">:</span><span class="nf">SetSize</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">)</span>
<span class="w">        </span><span class="nv">btnUsar</span><span class="p">:</span><span class="nf">SetText</span><span class="p">(</span><span class="s2">&quot;Usar&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nv">btnUsar</span><span class="p">.</span><span class="py">DoClick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span><span class="w"> </span><span class="nf">DoAccion</span><span class="p">(</span><span class="s2">&quot;usar&quot;</span><span class="p">)</span><span class="w"> </span><span class="kr">end</span>

<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">btnTirar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DButton&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">pnl</span><span class="p">)</span>
<span class="w">        </span><span class="nv">btnTirar</span><span class="p">:</span><span class="nf">SetPos</span><span class="p">(</span><span class="mi">355</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span>
<span class="w">        </span><span class="nv">btnTirar</span><span class="p">:</span><span class="nf">SetSize</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">)</span>
<span class="w">        </span><span class="nv">btnTirar</span><span class="p">:</span><span class="nf">SetText</span><span class="p">(</span><span class="s2">&quot;Tirar&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nv">btnTirar</span><span class="p">.</span><span class="py">DoClick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span><span class="w"> </span><span class="nf">DoAccion</span><span class="p">(</span><span class="s2">&quot;tirar&quot;</span><span class="p">)</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">end</span>
<span class="kr">end</span><span class="p">)</span>

<span class="nv">concommand</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;abrir_inventario&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span>
<span class="w">    </span><span class="nv">net</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="s2">&quot;Inv_Pedir&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">net</span><span class="p">.</span><span class="nf">SendToServer</span><span class="p">()</span>
<span class="kr">end</span><span class="p">)</span>
</pre></div>
</pre></div>

</div>
</details>

<hr />
<h2 id="5-almacenamiento-de-datos"><span class="num">05</span> Almacenamiento de Datos</h2>
<h3 id="ejercicio-51-guardar-y-cargar-config-facil">Ejercicio 5.1 ‚Äî Guardar y Cargar Config <span class="badge easy">‚≠ê F√°cil</span></h3>
<p>Cre√° funciones <code>GuardarConfig(tabla)</code> y <code>CargarConfig()</code> que usen la librer√≠a <code>file</code> con JSON. Si el archivo no existe, debe retornar valores por defecto. Testealo guardando y cargando <code>{salario = 100, pvp = true, nombre = "Test"}</code>.</p>

<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="kd">local</span><span class="w"> </span><span class="nv">ARCHIVO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;mi_addon/config.json&quot;</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">DEFAULTS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="nv">salario</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="nv">pvp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nv">nombre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Test&quot;</span><span class="p">}}</span>

<span class="kr">function</span><span class="w"> </span><span class="nf">GuardarConfig</span><span class="p">(</span><span class="nv">config</span><span class="p">)</span>
<span class="w">    </span><span class="nv">file</span><span class="p">.</span><span class="nf">CreateDir</span><span class="p">(</span><span class="s2">&quot;mi_addon&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">file</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nv">ARCHIVO</span><span class="p">,</span><span class="w"> </span><span class="nv">util</span><span class="p">.</span><span class="nf">TableToJSON</span><span class="p">(</span><span class="nv">config</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">))</span>
<span class="kr">end</span>

<span class="kr">function</span><span class="w"> </span><span class="nf">CargarConfig</span><span class="p">()</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">file</span><span class="p">.</span><span class="nf">Exists</span><span class="p">(</span><span class="nv">ARCHIVO</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;DATA&quot;</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="nv">table</span><span class="p">.</span><span class="nf">Copy</span><span class="p">(</span><span class="nv">DEFAULTS</span><span class="p">)</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">util</span><span class="p">.</span><span class="nf">JSONToTable</span><span class="p">(</span><span class="nv">file</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="nv">ARCHIVO</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;DATA&quot;</span><span class="p">))</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="nv">table</span><span class="p">.</span><span class="nf">Copy</span><span class="p">(</span><span class="nv">DEFAULTS</span><span class="p">)</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="c1">-- Merge con defaults para nuevas claves</span>
<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">k</span><span class="p">,</span><span class="w"> </span><span class="nv">v</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">pairs</span><span class="p">(</span><span class="nv">DEFAULTS</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">config</span><span class="p">[</span><span class="nv">k</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="nv">config</span><span class="p">[</span><span class="nv">k</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">v</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">config</span>
<span class="kr">end</span>
</pre></div>
</pre></div>
<p><strong>Nota:</strong> Se usa <code>table.Copy(DEFAULTS)</code> para no modificar la tabla original. El merge con defaults es importante para cuando agreg√°s nuevas opciones.</p>

</div>
</details>
<h3 id="ejercicio-52-sistema-de-bans-con-sqlite-intermedio">Ejercicio 5.2 ‚Äî Sistema de Bans con SQLite <span class="badge medium">‚≠ê‚≠ê Intermedio</span></h3>
<p>Implement√° un sistema de bans local usando <code>sql</code>:
- <code>BanearJugador(steamid, razon, duracion_minutos, admin_steamid)</code> ‚Äî Inserta un ban.
- <code>DesbanearJugador(steamid)</code> ‚Äî Elimina el ban.
- <code>EstaBaneado(steamid)</code> ‚Äî Retorna <code>true/false</code> y la raz√≥n (verificando si expir√≥).
- Hook <code>CheckPassword</code> para rechazar jugadores baneados al conectar.</p>
<p><strong>Objetivos:</strong> <code>sql.Query</code>, <code>sql.SQLStr</code>, <code>os.time()</code>, prevenci√≥n de SQL injection</p>

<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- SERVER</span>
<span class="nv">sql</span><span class="p">.</span><span class="nf">Query</span><span class="p">([[</span><span class="nv">CREATE</span><span class="w"> </span><span class="nv">TABLE</span><span class="w"> </span><span class="nv">IF</span><span class="w"> </span><span class="nv">NOT</span><span class="w"> </span><span class="nv">EXISTS</span><span class="w"> </span><span class="nf">bans</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="nv">steamid</span><span class="w"> </span><span class="nv">TEXT</span><span class="w"> </span><span class="nv">PRIMARY</span><span class="w"> </span><span class="nv">KEY</span><span class="p">,</span><span class="w"> </span><span class="nv">razon</span><span class="w"> </span><span class="nv">TEXT</span><span class="p">,</span><span class="w"> </span><span class="nv">admin_steamid</span><span class="w"> </span><span class="nv">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="nv">timestamp</span><span class="w"> </span><span class="nv">INTEGER</span><span class="p">,</span><span class="w"> </span><span class="nv">expira</span><span class="w"> </span><span class="nv">INTEGER</span><span class="p">)]])</span>

<span class="kr">function</span><span class="w"> </span><span class="nf">BanearJugador</span><span class="p">(</span><span class="nv">steamid</span><span class="p">,</span><span class="w"> </span><span class="nv">razon</span><span class="p">,</span><span class="w"> </span><span class="nv">duracion_min</span><span class="p">,</span><span class="w"> </span><span class="nv">admin_sid</span><span class="p">)</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">expira</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">duracion_min</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="p">(</span><span class="nb">os.time</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">duracion_min</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="p">)</span>
<span class="w">    </span><span class="nv">sql</span><span class="p">.</span><span class="nf">Query</span><span class="p">(</span><span class="nb">string.format</span><span class="p">(</span>
<span class="w">        </span><span class="s2">&quot;REPLACE INTO bans VALUES (%s, %s, %s, %d, %d)&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nv">sql</span><span class="p">.</span><span class="nf">SQLStr</span><span class="p">(</span><span class="nv">steamid</span><span class="p">),</span><span class="w"> </span><span class="nv">sql</span><span class="p">.</span><span class="nf">SQLStr</span><span class="p">(</span><span class="nv">razon</span><span class="p">),</span><span class="w"> </span><span class="nv">sql</span><span class="p">.</span><span class="nf">SQLStr</span><span class="p">(</span><span class="nv">admin_sid</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s2">&quot;CONSOLE&quot;</span><span class="p">),</span>
<span class="w">        </span><span class="nb">os.time</span><span class="p">(),</span><span class="w"> </span><span class="nv">expira</span><span class="p">))</span>
<span class="kr">end</span>

<span class="kr">function</span><span class="w"> </span><span class="nf">EstaBaneado</span><span class="p">(</span><span class="nv">steamid</span><span class="p">)</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">sql</span><span class="p">.</span><span class="nf">Query</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM bans WHERE steamid = &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">sql</span><span class="p">.</span><span class="nf">SQLStr</span><span class="p">(</span><span class="nv">steamid</span><span class="p">))</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">res</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">expira</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">tonumber</span><span class="p">(</span><span class="nv">res</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nv">expira</span><span class="p">)</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">expira</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nb">os.time</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nv">expira</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="nv">sql</span><span class="p">.</span><span class="nf">Query</span><span class="p">(</span><span class="s2">&quot;DELETE FROM bans WHERE steamid = &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">sql</span><span class="p">.</span><span class="nf">SQLStr</span><span class="p">(</span><span class="nv">steamid</span><span class="p">))</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nv">res</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nv">razon</span><span class="p">,</span><span class="w"> </span><span class="nv">expira</span>
<span class="kr">end</span>

<span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;CheckPassword&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Bans_Check&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">sid64</span><span class="p">)</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">banned</span><span class="p">,</span><span class="w"> </span><span class="nv">razon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">EstaBaneado</span><span class="p">(</span><span class="nv">sid64</span><span class="p">)</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">banned</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Baneado: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">razon</span><span class="w"> </span><span class="kr">end</span>
<span class="kr">end</span><span class="p">)</span>
</pre></div>
</pre></div>

</div>
</details>
<h3 id="ejercicio-53-encontrar-el-bug-sql-injection-facil">Ejercicio 5.3 ‚Äî Encontrar el Bug: SQL Injection <span class="badge easy">‚≠ê F√°cil</span></h3>
<p>¬øQu√© est√° mal en este c√≥digo y c√≥mo se explota?</p>
<div class="highlight"><pre><span></span><code><span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;PlayerSay&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Guardar_Nota&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">ply</span><span class="p">,</span><span class="w"> </span><span class="nv">text</span><span class="p">)</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">string</span><span class="p">.</span><span class="nf">StartWith</span><span class="p">(</span><span class="nv">text</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;!nota &quot;</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">nota</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">string.sub</span><span class="p">(</span><span class="nv">text</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">)</span>
<span class="w">        </span><span class="nv">sql</span><span class="p">.</span><span class="nf">Query</span><span class="p">(</span><span class="s2">&quot;INSERT INTO notas (steamid, texto) VALUES (&#39;&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">SteamID64</span><span class="p">()</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;&#39;, &#39;&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">nota</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;&#39;)&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nv">ply</span><span class="p">:</span><span class="nf">ChatPrint</span><span class="p">(</span><span class="s2">&quot;Nota guardada!&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="kr">end</span>
<span class="kr">end</span><span class="p">)</span>
</code></pre></div>


<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<p><strong>Vulnerabilidad:</strong> SQL Injection. La variable <code>nota</code> viene directamente del input del jugador sin sanitizar. Un jugador escribe <code>!nota '); DROP TABLE notas; --</code> y elimina toda la tabla.</p>
<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- SOLUCI√ìN: Siempre usar sql.SQLStr()</span>
<span class="nv">sql</span><span class="p">.</span><span class="nf">Query</span><span class="p">(</span><span class="nb">string.format</span><span class="p">(</span>
<span class="w">    </span><span class="s2">&quot;INSERT INTO notas (steamid, texto) VALUES (%s, %s)&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nv">sql</span><span class="p">.</span><span class="nf">SQLStr</span><span class="p">(</span><span class="nv">ply</span><span class="p">:</span><span class="nf">SteamID64</span><span class="p">()),</span>
<span class="w">    </span><span class="nv">sql</span><span class="p">.</span><span class="nf">SQLStr</span><span class="p">(</span><span class="nv">nota</span><span class="p">)</span>
<span class="p">))</span>
</pre></div>
</pre></div>

</div>
</details>
<h3 id="ejercicio-54-estadisticas-persistentes-avanzado">Ejercicio 5.4 ‚Äî Estad√≠sticas Persistentes <span class="badge advanced">‚≠ê‚≠ê‚≠ê Avanzado</span></h3>
<p>Cre√° un sistema completo de estad√≠sticas de jugador que persista entre sesiones:
- Registrar: kills, muertes, tiempo jugado, dinero ganado.
- Tabla SQL con steamid como PRIMARY KEY.
- Cargar datos al conectar, guardar peri√≥dicamente (cada 5 min) y al desconectar.
- Comando <code>!stats</code> que muestre tus estad√≠sticas.
- Comando <code>!top</code> que muestre los top 5 jugadores por kills.</p>
<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<p>Sistema completo con SQL para persistencia, hooks para tracking, timers para auto-guardado.</p>
<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- SERVER</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">Stats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
<span class="nv">Stats</span><span class="p">.</span><span class="py">Cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>

<span class="nv">sql</span><span class="p">.</span><span class="nf">Query</span><span class="p">([[</span><span class="nv">CREATE</span><span class="w"> </span><span class="nv">TABLE</span><span class="w"> </span><span class="nv">IF</span><span class="w"> </span><span class="nv">NOT</span><span class="w"> </span><span class="nv">EXISTS</span><span class="w"> </span><span class="nf">player_stats</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="nv">steamid</span><span class="w"> </span><span class="nv">TEXT</span><span class="w"> </span><span class="nv">PRIMARY</span><span class="w"> </span><span class="nv">KEY</span><span class="p">,</span><span class="w"> </span><span class="nv">nombre</span><span class="w"> </span><span class="nv">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="nv">kills</span><span class="w"> </span><span class="nv">INTEGER</span><span class="w"> </span><span class="nv">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">muertes</span><span class="w"> </span><span class="nv">INTEGER</span><span class="w"> </span><span class="nv">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="nv">tiempo_jugado</span><span class="w"> </span><span class="nv">INTEGER</span><span class="w"> </span><span class="nv">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">)]])</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">Stats</span><span class="p">.</span><span class="nf">Cargar</span><span class="p">(</span><span class="nv">ply</span><span class="p">)</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">sid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">SteamID64</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">sql</span><span class="p">.</span><span class="nf">Query</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM player_stats WHERE steamid = &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">sql</span><span class="p">.</span><span class="nf">SQLStr</span><span class="p">(</span><span class="nv">sid</span><span class="p">))</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">res</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="nv">Stats</span><span class="p">.</span><span class="py">Cache</span><span class="p">[</span><span class="nv">sid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nv">kills</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">tonumber</span><span class="p">(</span><span class="nv">res</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nv">kills</span><span class="p">),</span><span class="w"> </span><span class="nv">muertes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">tonumber</span><span class="p">(</span><span class="nv">res</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nv">muertes</span><span class="p">),</span>
<span class="w">            </span><span class="nv">tiempo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">tonumber</span><span class="p">(</span><span class="nv">res</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nv">tiempo_jugado</span><span class="p">),</span><span class="w"> </span><span class="nv">inicio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">CurTime</span><span class="p">(),</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="kr">else</span>
<span class="w">        </span><span class="nv">sql</span><span class="p">.</span><span class="nf">Query</span><span class="p">(</span><span class="nb">string.format</span><span class="p">(</span><span class="s2">&quot;INSERT INTO player_stats (steamid, nombre) VALUES (%s, %s)&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nv">sql</span><span class="p">.</span><span class="nf">SQLStr</span><span class="p">(</span><span class="nv">sid</span><span class="p">),</span><span class="w"> </span><span class="nv">sql</span><span class="p">.</span><span class="nf">SQLStr</span><span class="p">(</span><span class="nv">ply</span><span class="p">:</span><span class="nf">Nick</span><span class="p">())))</span>
<span class="w">        </span><span class="nv">Stats</span><span class="p">.</span><span class="py">Cache</span><span class="p">[</span><span class="nv">sid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="nv">kills</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">muertes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">tiempo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">inicio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">CurTime</span><span class="p">()}</span>
<span class="w">    </span><span class="kr">end</span>
<span class="kr">end</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">Stats</span><span class="p">.</span><span class="nf">Guardar</span><span class="p">(</span><span class="nv">ply</span><span class="p">)</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">Stats</span><span class="p">.</span><span class="py">Cache</span><span class="p">[</span><span class="nv">ply</span><span class="p">:</span><span class="nf">SteamID64</span><span class="p">()]</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">d</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">sesion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.floor</span><span class="p">(</span><span class="nf">CurTime</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">d</span><span class="p">.</span><span class="py">inicio</span><span class="p">)</span>
<span class="w">    </span><span class="nv">sql</span><span class="p">.</span><span class="nf">Query</span><span class="p">(</span><span class="nb">string.format</span><span class="p">(</span>
<span class="w">        </span><span class="s2">&quot;UPDATE player_stats SET nombre=%s, kills=%d, muertes=%d, tiempo_jugado=%d WHERE steamid=%s&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nv">sql</span><span class="p">.</span><span class="nf">SQLStr</span><span class="p">(</span><span class="nv">ply</span><span class="p">:</span><span class="nf">Nick</span><span class="p">()),</span><span class="w"> </span><span class="nv">d</span><span class="p">.</span><span class="py">kills</span><span class="p">,</span><span class="w"> </span><span class="nv">d</span><span class="p">.</span><span class="py">muertes</span><span class="p">,</span><span class="w"> </span><span class="nv">d</span><span class="p">.</span><span class="py">tiempo</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">sesion</span><span class="p">,</span><span class="w"> </span><span class="nv">sql</span><span class="p">.</span><span class="nf">SQLStr</span><span class="p">(</span><span class="nv">ply</span><span class="p">:</span><span class="nf">SteamID64</span><span class="p">())))</span>
<span class="kr">end</span>

<span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;PlayerInitialSpawn&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Stats_Load&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">ply</span><span class="p">)</span><span class="w"> </span><span class="nv">Stats</span><span class="p">.</span><span class="nf">Cargar</span><span class="p">(</span><span class="nv">ply</span><span class="p">)</span><span class="w"> </span><span class="kr">end</span><span class="p">)</span>
<span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;PlayerDisconnected&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Stats_Save&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">ply</span><span class="p">)</span>
<span class="w">    </span><span class="nv">Stats</span><span class="p">.</span><span class="nf">Guardar</span><span class="p">(</span><span class="nv">ply</span><span class="p">)</span>
<span class="w">    </span><span class="nv">Stats</span><span class="p">.</span><span class="py">Cache</span><span class="p">[</span><span class="nv">ply</span><span class="p">:</span><span class="nf">SteamID64</span><span class="p">()]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">nil</span>
<span class="kr">end</span><span class="p">)</span>

<span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;PlayerDeath&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Stats_Death&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">v</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">a</span><span class="p">)</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">vs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">Stats</span><span class="p">.</span><span class="py">Cache</span><span class="p">[</span><span class="nv">v</span><span class="p">:</span><span class="nf">SteamID64</span><span class="p">()]</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">vs</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="nv">vs</span><span class="p">.</span><span class="py">muertes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vs</span><span class="p">.</span><span class="py">muertes</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nf">IsValid</span><span class="p">(</span><span class="nv">a</span><span class="p">)</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">a</span><span class="p">:</span><span class="nf">IsPlayer</span><span class="p">()</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="nv">v</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">as</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">Stats</span><span class="p">.</span><span class="py">Cache</span><span class="p">[</span><span class="nv">a</span><span class="p">:</span><span class="nf">SteamID64</span><span class="p">()]</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">as</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="nv">as</span><span class="p">.</span><span class="py">kills</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">as</span><span class="p">.</span><span class="py">kills</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">end</span>
<span class="kr">end</span><span class="p">)</span>

<span class="nv">timer</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;Stats_AutoSave&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">300</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span>
<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">ply</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">player</span><span class="p">.</span><span class="nf">GetAll</span><span class="p">())</span><span class="w"> </span><span class="kr">do</span><span class="w"> </span><span class="nv">Stats</span><span class="p">.</span><span class="nf">Guardar</span><span class="p">(</span><span class="nv">ply</span><span class="p">)</span><span class="w"> </span><span class="kr">end</span>
<span class="kr">end</span><span class="p">)</span>

<span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;PlayerSay&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Stats_Cmds&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">ply</span><span class="p">,</span><span class="w"> </span><span class="nv">text</span><span class="p">)</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;!stats&quot;</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">Stats</span><span class="p">.</span><span class="py">Cache</span><span class="p">[</span><span class="nv">ply</span><span class="p">:</span><span class="nf">SteamID64</span><span class="p">()]</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">d</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="kr">end</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">d</span><span class="p">.</span><span class="py">tiempo</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">math.floor</span><span class="p">(</span><span class="nf">CurTime</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">d</span><span class="p">.</span><span class="py">inicio</span><span class="p">)</span>
<span class="w">        </span><span class="nv">ply</span><span class="p">:</span><span class="nf">ChatPrint</span><span class="p">(</span><span class="s2">&quot;Kills: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">d</span><span class="p">.</span><span class="py">kills</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; | Muertes: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">d</span><span class="p">.</span><span class="py">muertes</span><span class="w"> </span><span class="o">..</span>
<span class="w">            </span><span class="s2">&quot; | K/D: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">string.format</span><span class="p">(</span><span class="s2">&quot;%.2f&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">d</span><span class="p">.</span><span class="py">kills</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nb">math.max</span><span class="p">(</span><span class="nv">d</span><span class="p">.</span><span class="py">muertes</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">..</span>
<span class="w">            </span><span class="s2">&quot; | Tiempo: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">math.floor</span><span class="p">(</span><span class="nv">t</span><span class="o">/</span><span class="mi">3600</span><span class="p">)</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;h &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">math.floor</span><span class="p">((</span><span class="nv">t</span><span class="o">%</span><span class="mi">3600</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;m&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;!top&quot;</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">sql</span><span class="p">.</span><span class="nf">Query</span><span class="p">(</span><span class="s2">&quot;SELECT nombre, kills FROM player_stats ORDER BY kills DESC LIMIT 5&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nv">ply</span><span class="p">:</span><span class="nf">ChatPrint</span><span class="p">(</span><span class="s2">&quot;--- Top 5 Kills ---&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">res</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="kr">for</span><span class="w"> </span><span class="nv">i</span><span class="p">,</span><span class="w"> </span><span class="nv">r</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">res</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">ChatPrint</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">r</span><span class="p">.</span><span class="py">nombre</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; - &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">r</span><span class="p">.</span><span class="py">kills</span><span class="p">)</span><span class="w"> </span><span class="kr">end</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="kr">end</span>
<span class="kr">end</span><span class="p">)</span>
</pre></div>
</pre></div>

</div>
</details>

<hr />
<h2 id="6-http-y-servicios-externos"><span class="num">06</span> HTTP y Servicios Externos</h2>
<h3 id="ejercicio-61-webhook-de-discord-para-reportes-intermedio">Ejercicio 6.1 ‚Äî Webhook de Discord para Reportes <span class="badge medium">‚≠ê‚≠ê Intermedio</span></h3>
<p>Cre√° un comando <code>!report &lt;jugador&gt; &lt;raz√≥n&gt;</code> que env√≠e un embed a un canal de Discord v√≠a webhook. El embed debe incluir: qui√©n report√≥, qui√©n fue reportado, la raz√≥n, fecha/hora, y el SteamID de ambos.</p>

<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- SERVER</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">WEBHOOK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;https://discord.com/api/webhooks/TU_ID/TU_TOKEN&quot;</span>

<span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;PlayerSay&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Report_Cmd&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">ply</span><span class="p">,</span><span class="w"> </span><span class="nv">text</span><span class="p">)</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">string</span><span class="p">.</span><span class="nf">StartWith</span><span class="p">(</span><span class="nv">text</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;!report &quot;</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">string</span><span class="p">.</span><span class="nf">Explode</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">string.sub</span><span class="p">(</span><span class="nv">text</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">))</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">targetName</span><span class="p">,</span><span class="w"> </span><span class="nv">razon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="nb">table.concat</span><span class="p">(</span><span class="nv">args</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">targetName</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">ChatPrint</span><span class="p">(</span><span class="s2">&quot;Uso: !report &lt;jugador&gt; &lt;raz√≥n&gt;&quot;</span><span class="p">)</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="kr">end</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">target</span>
<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">player</span><span class="p">.</span><span class="nf">GetAll</span><span class="p">())</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nb">string.find</span><span class="p">(</span><span class="nb">string.lower</span><span class="p">(</span><span class="nv">p</span><span class="p">:</span><span class="nf">Nick</span><span class="p">()),</span><span class="w"> </span><span class="nb">string.lower</span><span class="p">(</span><span class="nv">targetName</span><span class="p">),</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="nv">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="kr">break</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">target</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">ChatPrint</span><span class="p">(</span><span class="s2">&quot;No encontrado&quot;</span><span class="p">)</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="kr">end</span>

<span class="w">    </span><span class="nf">HTTP</span><span class="p">({{</span>
<span class="w">        </span><span class="nv">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">WEBHOOK</span><span class="p">,</span><span class="w"> </span><span class="nv">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;POST&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nv">headers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{[</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;application/json&quot;</span><span class="p">}},</span>
<span class="w">        </span><span class="nv">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">util</span><span class="p">.</span><span class="nf">TableToJSON</span><span class="p">({{</span><span class="nv">embeds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{{{</span>
<span class="w">            </span><span class="nv">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Nuevo Reporte&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">15158332</span><span class="p">,</span>
<span class="w">            </span><span class="nv">fields</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span>
<span class="w">                </span><span class="p">{{</span><span class="nv">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;De&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">Nick</span><span class="p">()</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">SteamID</span><span class="p">(),</span><span class="w"> </span><span class="nv">inline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">}},</span>
<span class="w">                </span><span class="p">{{</span><span class="nv">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Contra&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">target</span><span class="p">:</span><span class="nf">Nick</span><span class="p">()</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">target</span><span class="p">:</span><span class="nf">SteamID</span><span class="p">(),</span><span class="w"> </span><span class="nv">inline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">}},</span>
<span class="w">                </span><span class="p">{{</span><span class="nv">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Raz√≥n&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">razon</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">razon</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s2">&quot;Sin raz√≥n&quot;</span><span class="p">}},</span>
<span class="w">            </span><span class="p">}},</span>
<span class="w">            </span><span class="nv">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">os.date</span><span class="p">(</span><span class="s2">&quot;!%Y-%m-%dT%H:%M:%SZ&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">}}}}}}}),</span><span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nv">success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span><span class="w"> </span><span class="kr">end</span><span class="p">,</span><span class="w"> </span><span class="nv">failed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">e</span><span class="p">)</span><span class="w"> </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[Report] Error: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">e</span><span class="p">)</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="p">}})</span>
<span class="w">    </span><span class="nv">ply</span><span class="p">:</span><span class="nf">ChatPrint</span><span class="p">(</span><span class="s2">&quot;Reporte enviado!&quot;</span><span class="p">)</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="kr">end</span><span class="p">)</span>
</pre></div>
</pre></div>

</div>
</details>
<h3 id="ejercicio-62-api-de-servidor-avanzado">Ejercicio 6.2 ‚Äî API de Servidor <span class="badge advanced">‚≠ê‚≠ê‚≠ê Avanzado</span></h3>
<p>Cre√° un sistema que cada 60 segundos env√≠e por HTTP POST la informaci√≥n del servidor a una URL configurable: nombre del server, mapa actual, cantidad de jugadores, lista de jugadores con nombre y SteamID, uptime.</p>
<p><strong>Objetivos:</strong> <code>HTTP()</code>, <code>game.GetMap()</code>, <code>GetHostName()</code>, <code>engine.TickCount()</code>, <code>player.GetAll()</code></p>
<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- SERVER</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">API_URL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;https://tu-api.ejemplo.com/heartbeat&quot;</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">inicioServer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">os.time</span><span class="p">()</span>

<span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">EnviarHeartbeat</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">jugadores</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">ply</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">player</span><span class="p">.</span><span class="nf">GetAll</span><span class="p">())</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="nb">table.insert</span><span class="p">(</span><span class="nv">jugadores</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nv">nombre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">Nick</span><span class="p">(),</span><span class="w"> </span><span class="nv">steamid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">SteamID64</span><span class="p">(),</span><span class="w"> </span><span class="nv">ping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">Ping</span><span class="p">()})</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="nf">HTTP</span><span class="p">({</span>
<span class="w">        </span><span class="nv">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">API_URL</span><span class="p">,</span><span class="w"> </span><span class="nv">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;POST&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nv">headers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{[</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;application/json&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;Authorization&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Bearer TU_TOKEN&quot;</span><span class="p">},</span>
<span class="w">        </span><span class="nv">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">util</span><span class="p">.</span><span class="nf">TableToJSON</span><span class="p">({</span>
<span class="w">            </span><span class="nv">nombre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">GetHostName</span><span class="p">(),</span><span class="w"> </span><span class="nv">mapa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">game</span><span class="p">.</span><span class="nf">GetMap</span><span class="p">(),</span>
<span class="w">            </span><span class="nv">jugadores_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">player</span><span class="p">.</span><span class="nf">GetCount</span><span class="p">(),</span><span class="w"> </span><span class="nv">max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">game</span><span class="p">.</span><span class="nf">MaxPlayers</span><span class="p">(),</span>
<span class="w">            </span><span class="nv">jugadores</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">jugadores</span><span class="p">,</span><span class="w"> </span><span class="nv">uptime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">os.time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">inicioServer</span><span class="p">,</span>
<span class="w">            </span><span class="nv">gamemode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">engine</span><span class="p">.</span><span class="nf">ActiveGamemode</span><span class="p">(),</span><span class="w"> </span><span class="nv">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">os.time</span><span class="p">(),</span>
<span class="w">        </span><span class="p">}),</span>
<span class="w">        </span><span class="nb">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nv">success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">code</span><span class="p">)</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span><span class="nv">code</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[API] HTTP &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">code</span><span class="p">)</span><span class="w"> </span><span class="kr">end</span><span class="w"> </span><span class="kr">end</span><span class="p">,</span>
<span class="w">        </span><span class="nv">failed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">err</span><span class="p">)</span><span class="w"> </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[API] Error: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">err</span><span class="p">)</span><span class="w"> </span><span class="kr">end</span><span class="p">,</span>
<span class="w">    </span><span class="p">})</span>
<span class="kr">end</span>

<span class="nv">timer</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;API_Heartbeat&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">60</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">EnviarHeartbeat</span><span class="p">)</span>
</pre></div>
</pre></div>

</div>
</details>

<h3 id="ejercicio-63-sistema-de-motd-desde-url-intermedio">Ejercicio 6.3 ‚Äî Sistema de MOTD desde URL <span class="badge medium">‚≠ê‚≠ê Intermedio</span></h3>
<p>Cre√° un sistema que al entrar un jugador al servidor, descargue el "Mensaje del D√≠a" desde una URL configurada y se lo muestre en un panel Derma. El texto debe cachearse por 5 minutos para no hacer HTTP requests innecesarios.</p>
<ul>
<li>Usar <code>http.Fetch</code> para descargar el contenido.</li>
<li>Cachear el resultado con un timestamp.</li>
<li>Mostrar el texto en un DFrame con un DLabel o HTML panel.</li>
<li>Si el fetch falla, mostrar un mensaje de error.</li>
</ul>
<p><strong>Objetivos:</strong> <code>http.Fetch</code>, cach√© temporal, manejo de errores HTTP, integraci√≥n con VGUI</p>
<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<div class="highlight"><pre><span></span><code>-- SERVER
util.AddNetworkString("MOTD_Mostrar")

local motdCache = ""
local motdTime = 0
local MOTD_URL = "https://tu-sitio.com/motd.txt"
local CACHE_DURACION = 300  -- 5 minutos

local function ObtenerMOTD(callback)
    -- Usar cach√© si es reciente
    if motdCache ~= "" and CurTime() - motdTime < CACHE_DURACION then
        callback(motdCache)
        return
    end

    http.Fetch(MOTD_URL,
        function(body, size, headers, code)
            if code == 200 then
                motdCache = body
                motdTime = CurTime()
                callback(body)
            else
                callback("Error al cargar MOTD (HTTP " .. code .. ")")
            end
        end,
        function(err)
            callback("Error de conexi√≥n: " .. err)
        end
    )
end

hook.Add("PlayerInitialSpawn", "MOTD_Enviar", function(ply)
    timer.Simple(3, function()
        if not IsValid(ply) then return end
        ObtenerMOTD(function(texto)
            net.Start("MOTD_Mostrar")
                net.WriteString(texto)
            net.Send(ply)
        end)
    end)
end)

-- CLIENT
net.Receive("MOTD_Mostrar", function()
    local texto = net.ReadString()

    local frame = vgui.Create("DFrame")
    frame:SetSize(500, 350)
    frame:Center()
    frame:SetTitle("Mensaje del D√≠a")
    frame:MakePopup()

    local label = vgui.Create("DLabel", frame)
    label:Dock(FILL)
    label:DockMargin(10, 10, 10, 10)
    label:SetText(texto)
    label:SetWrap(true)
    label:SetAutoStretchVertical(true)
end)
</code></pre></div>

</div>
</details>

<hr />
<h2 id="7-renderizado-2d-y-hud"><span class="num">07</span> Renderizado 2D y HUD</h2>
<h3 id="ejercicio-71-hud-de-vida-con-animacion-intermedio">Ejercicio 7.1 ‚Äî HUD de Vida con Animaci√≥n <span class="badge medium">‚≠ê‚≠ê Intermedio</span></h3>
<p>Cre√° un HUD personalizado de vida que:
- Muestre una barra de vida con animaci√≥n suave (que se mueva gradualmente, no de golpe).
- Cambie de color seg√∫n el porcentaje: verde &gt; 60%, amarillo 30-60%, rojo &lt; 30%.
- Muestre el n√∫mero de HP centrado dentro de la barra.
- Tenga un fondo semi-transparente con bordes redondeados.
- Oculte el HUD de vida por defecto del juego.</p>
<p><strong>Pista:</strong> Us√° <code>Lerp()</code> para interpolar el ancho de la barra.</p>

<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- CLIENT</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">vidaAnimada</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span>

<span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;HUDPaint&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;MiHUD_Vida&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">ply</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">LocalPlayer</span><span class="p">()</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nf">IsValid</span><span class="p">(</span><span class="nv">ply</span><span class="p">)</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">Alive</span><span class="p">()</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>

<span class="w">    </span><span class="nv">vidaAnimada</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Lerp</span><span class="p">(</span><span class="nf">FrameTime</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="nv">vidaAnimada</span><span class="p">,</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">Health</span><span class="p">())</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">pct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">math</span><span class="p">.</span><span class="nf">Clamp</span><span class="p">(</span><span class="nv">vidaAnimada</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">GetMaxHealth</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">x</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="p">,</span><span class="w"> </span><span class="nv">w</span><span class="p">,</span><span class="w"> </span><span class="nv">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="nf">ScrH</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">60</span><span class="p">,</span><span class="w"> </span><span class="mi">300</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span>

<span class="w">    </span><span class="c1">-- Color seg√∫n porcentaje</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">pct</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.6</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="mi">80</span><span class="p">)</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nv">pct</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.3</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">230</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">220</span><span class="p">,</span><span class="w"> </span><span class="mi">60</span><span class="p">,</span><span class="w"> </span><span class="mi">60</span><span class="p">)</span>

<span class="w">    </span><span class="nv">draw</span><span class="p">.</span><span class="nf">RoundedBox</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="nv">x</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="nv">w</span><span class="o">+</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="nv">h</span><span class="o">+</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">180</span><span class="p">))</span>
<span class="w">    </span><span class="nv">draw</span><span class="p">.</span><span class="nf">RoundedBox</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="nv">x</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="p">,</span><span class="w"> </span><span class="nv">w</span><span class="p">,</span><span class="w"> </span><span class="nv">h</span><span class="p">,</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">40</span><span class="p">))</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">pct</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="nv">draw</span><span class="p">.</span><span class="nf">RoundedBox</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="nv">x</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="p">,</span><span class="w"> </span><span class="nv">w</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">pct</span><span class="p">,</span><span class="w"> </span><span class="nv">h</span><span class="p">,</span><span class="w"> </span><span class="nv">color</span><span class="p">)</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="nv">draw</span><span class="p">.</span><span class="nf">SimpleText</span><span class="p">(</span><span class="nb">math.floor</span><span class="p">(</span><span class="nv">vidaAnimada</span><span class="p">)</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; HP&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;DermaDefaultBold&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nv">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">w</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">h</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nv">color_white</span><span class="p">,</span><span class="w"> </span><span class="nv">TEXT_ALIGN_CENTER</span><span class="p">,</span><span class="w"> </span><span class="nv">TEXT_ALIGN_CENTER</span><span class="p">)</span>
<span class="kr">end</span><span class="p">)</span>

<span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;HUDShouldDraw&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;MiHUD_Ocultar&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">n</span><span class="p">)</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span><span class="nv">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;CHudHealth&quot;</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kr">end</span><span class="w"> </span><span class="kr">end</span><span class="p">)</span>
</pre></div>
</pre></div>
<p><strong>Clave:</strong> <code>Lerp(FrameTime() * velocidad, actual, objetivo)</code> interpola suavemente entre el valor actual y el objetivo cada frame.</p>

</div>
</details>
<h3 id="ejercicio-72-indicador-de-dano-direccional-avanzado">Ejercicio 7.2 ‚Äî Indicador de Da√±o Direccional <span class="badge advanced">‚≠ê‚≠ê‚≠ê Avanzado</span></h3>
<p>Implement√° un indicador de da√±o como los de los FPS modernos: cuando recib√≠s da√±o, aparece un arco rojo en la direcci√≥n de donde vino el ataque. Debe desvanecerse despu√©s de 1.5 segundos.</p>
<p><strong>Pista:</strong> Calcul√° el √°ngulo relativo entre tu posici√≥n y la del atacante. Dibuj√° un arco con <code>surface.DrawPoly</code> rotado seg√∫n ese √°ngulo. Us√° el hook <code>EntityTakeDamage</code> en el server y envi√° la posici√≥n del atacante al cliente con <code>net</code>.</p>

<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<p>El server env√≠a la posici√≥n del atacante al cliente v√≠a net. El client calcula el √°ngulo relativo y dibuja un arco que se desvanece.</p>
<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- === SERVER ===</span>
<span class="nv">util</span><span class="p">.</span><span class="nf">AddNetworkString</span><span class="p">(</span><span class="s2">&quot;DmgDir&quot;</span><span class="p">)</span>

<span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;EntityTakeDamage&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;DmgDir_Send&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">target</span><span class="p">,</span><span class="w"> </span><span class="nv">dmg</span><span class="p">)</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">target</span><span class="p">:</span><span class="nf">IsPlayer</span><span class="p">()</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">atk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">dmg</span><span class="p">:</span><span class="nf">GetAttacker</span><span class="p">()</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nf">IsValid</span><span class="p">(</span><span class="nv">atk</span><span class="p">)</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nv">atk</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">target</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="nv">net</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="s2">&quot;DmgDir&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nv">net</span><span class="p">.</span><span class="nf">WriteVector</span><span class="p">(</span><span class="nv">atk</span><span class="p">:</span><span class="nf">GetPos</span><span class="p">())</span>
<span class="w">    </span><span class="nv">net</span><span class="p">.</span><span class="nf">Send</span><span class="p">(</span><span class="nv">target</span><span class="p">)</span>
<span class="kr">end</span><span class="p">)</span>

<span class="c1">-- === CLIENT ===</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">indicadores</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>

<span class="nv">net</span><span class="p">.</span><span class="nf">Receive</span><span class="p">(</span><span class="s2">&quot;DmgDir&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">posAtk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">net</span><span class="p">.</span><span class="nf">ReadVector</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">lp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">LocalPlayer</span><span class="p">()</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nf">IsValid</span><span class="p">(</span><span class="nv">lp</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nv">posAtk</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">lp</span><span class="p">:</span><span class="nf">GetPos</span><span class="p">()):</span><span class="nf">Angle</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">diff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">math</span><span class="p">.</span><span class="nf">NormalizeAngle</span><span class="p">(</span><span class="nv">dir</span><span class="p">.</span><span class="py">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">lp</span><span class="p">:</span><span class="nf">EyeAngles</span><span class="p">().</span><span class="nv">y</span><span class="p">)</span>
<span class="w">    </span><span class="nb">table.insert</span><span class="p">(</span><span class="nv">indicadores</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nv">ang</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">diff</span><span class="p">,</span><span class="w"> </span><span class="nv">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">CurTime</span><span class="p">()})</span>
<span class="kr">end</span><span class="p">)</span>

<span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;HUDPaint&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;DmgDir_Draw&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">cx</span><span class="p">,</span><span class="w"> </span><span class="nv">cy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ScrW</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nf">ScrH</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">120</span>

<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">#</span><span class="nv">indicadores</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">ind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">indicadores</span><span class="p">[</span><span class="nv">i</span><span class="p">]</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">elapsed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">CurTime</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">ind</span><span class="p">.</span><span class="py">t</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">elapsed</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">1.5</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="nb">table.remove</span><span class="p">(</span><span class="nv">indicadores</span><span class="p">,</span><span class="w"> </span><span class="nv">i</span><span class="p">)</span>
<span class="w">        </span><span class="kr">else</span>
<span class="w">            </span><span class="kd">local</span><span class="w"> </span><span class="nv">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">255</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">elapsed</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1.5</span><span class="p">)</span>
<span class="w">            </span><span class="kd">local</span><span class="w"> </span><span class="nv">rad</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.rad</span><span class="p">(</span><span class="o">-</span><span class="nv">ind</span><span class="p">.</span><span class="py">ang</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">90</span><span class="p">)</span>
<span class="w">            </span><span class="kd">local</span><span class="w"> </span><span class="nv">pts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
<span class="w">            </span><span class="kr">for</span><span class="w"> </span><span class="nv">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="kr">do</span>
<span class="w">                </span><span class="kd">local</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">rad</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">math.rad</span><span class="p">(</span><span class="o">-</span><span class="mi">15</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mi">30</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">s</span><span class="p">)</span>
<span class="w">                </span><span class="nb">table.insert</span><span class="p">(</span><span class="nv">pts</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nv">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">cx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">math.cos</span><span class="p">(</span><span class="nv">a</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nv">r</span><span class="o">-</span><span class="mi">10</span><span class="p">),</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">cy</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">math.sin</span><span class="p">(</span><span class="nv">a</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nv">r</span><span class="o">-</span><span class="mi">10</span><span class="p">)})</span>
<span class="w">            </span><span class="kr">end</span>
<span class="w">            </span><span class="kr">for</span><span class="w"> </span><span class="nv">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="kr">do</span>
<span class="w">                </span><span class="kd">local</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">rad</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">math.rad</span><span class="p">(</span><span class="o">-</span><span class="mi">15</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mi">30</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">s</span><span class="p">)</span>
<span class="w">                </span><span class="nb">table.insert</span><span class="p">(</span><span class="nv">pts</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nv">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">cx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">math.cos</span><span class="p">(</span><span class="nv">a</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nv">r</span><span class="o">+</span><span class="mi">10</span><span class="p">),</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">cy</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">math.sin</span><span class="p">(</span><span class="nv">a</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nv">r</span><span class="o">+</span><span class="mi">10</span><span class="p">)})</span>
<span class="w">            </span><span class="kr">end</span>
<span class="w">            </span><span class="nv">draw</span><span class="p">.</span><span class="nf">NoTexture</span><span class="p">()</span>
<span class="w">            </span><span class="nv">surface</span><span class="p">.</span><span class="nf">SetDrawColor</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="nv">alpha</span><span class="p">)</span>
<span class="w">            </span><span class="nv">surface</span><span class="p">.</span><span class="nf">DrawPoly</span><span class="p">(</span><span class="nv">pts</span><span class="p">)</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">end</span>
<span class="kr">end</span><span class="p">)</span>
</pre></div>
</pre></div>

</div>
</details>
<h3 id="ejercicio-73-texto-flotante-sobre-jugadores-intermedio">Ejercicio 7.3 ‚Äî Texto Flotante sobre Jugadores <span class="badge medium">‚≠ê‚≠ê Intermedio</span></h3>
<p>Dibuj√° el nombre y la vida de cada jugador flotando sobre su cabeza, visible solo cuando est√°n a menos de 800 unidades de distancia. El texto debe escalar seg√∫n la distancia. No mostrar la info del jugador local.</p>
<p><strong>Pista:</strong> Us√° el hook <code>PostDrawOpaqueRenderables</code> con <code>cam.Start3D2D</code> o us√° <code>pos:ToScreen()</code> con <code>HUDPaint</code>.</p>

<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- CLIENT</span>
<span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;HUDPaint&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;MiAddon_Nombres&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">lp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">LocalPlayer</span><span class="p">()</span>
<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">ply</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">player</span><span class="p">.</span><span class="nf">GetAll</span><span class="p">())</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">ply</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">lp</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">Alive</span><span class="p">()</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="nv">continue</span><span class="w"> </span><span class="kr">end</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">lp</span><span class="p">:</span><span class="nf">GetPos</span><span class="p">():</span><span class="nf">Distance</span><span class="p">(</span><span class="nv">ply</span><span class="p">:</span><span class="nf">GetPos</span><span class="p">())</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">dist</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">800</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="nv">continue</span><span class="w"> </span><span class="kr">end</span>

<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">screen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nv">ply</span><span class="p">:</span><span class="nf">GetPos</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">Vector</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">80</span><span class="p">)):</span><span class="nf">ToScreen</span><span class="p">()</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">screen</span><span class="p">.</span><span class="py">visible</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="nv">continue</span><span class="w"> </span><span class="kr">end</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">255</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">math</span><span class="p">.</span><span class="nf">Clamp</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">dist</span><span class="o">/</span><span class="mi">800</span><span class="p">,</span><span class="w"> </span><span class="mf">0.4</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">        </span><span class="nv">draw</span><span class="p">.</span><span class="nf">SimpleTextOutlined</span><span class="p">(</span><span class="nv">ply</span><span class="p">:</span><span class="nf">Nick</span><span class="p">(),</span><span class="w"> </span><span class="s2">&quot;DermaDefault&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nv">screen</span><span class="p">.</span><span class="py">x</span><span class="p">,</span><span class="w"> </span><span class="nv">screen</span><span class="p">.</span><span class="py">y</span><span class="p">,</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="nv">alpha</span><span class="p">),</span>
<span class="w">            </span><span class="nv">TEXT_ALIGN_CENTER</span><span class="p">,</span><span class="w"> </span><span class="nv">TEXT_ALIGN_CENTER</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nv">alpha</span><span class="p">))</span>

<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">barW</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">dist</span><span class="o">/</span><span class="mi">800</span><span class="p">)</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">vida</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">Health</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">GetMaxHealth</span><span class="p">()</span>
<span class="w">        </span><span class="nv">draw</span><span class="p">.</span><span class="nf">RoundedBox</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nv">screen</span><span class="p">.</span><span class="py">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">barW</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nv">screen</span><span class="p">.</span><span class="py">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="nv">barW</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nv">alpha</span><span class="p">))</span>
<span class="w">        </span><span class="nv">draw</span><span class="p">.</span><span class="nf">RoundedBox</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nv">screen</span><span class="p">.</span><span class="py">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">barW</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nv">screen</span><span class="p">.</span><span class="py">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="nv">barW</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">math</span><span class="p">.</span><span class="nf">Clamp</span><span class="p">(</span><span class="nv">vida</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span><span class="mi">220</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="nv">alpha</span><span class="p">))</span>
<span class="w">    </span><span class="kr">end</span>
<span class="kr">end</span><span class="p">)</span>
</pre></div>
</pre></div>

</div>
</details>
<h3 id="ejercicio-74-minimap-basico-avanzado">Ejercicio 7.4 ‚Äî Minimap B√°sico <span class="badge advanced">‚≠ê‚≠ê‚≠ê Avanzado</span></h3>
<p>Cre√° un minimap funcional:
- Un cuadrado en la esquina superior derecha mostrando una vista cenital.
- El jugador local como un punto celeste en el centro.
- Los otros jugadores como puntos rojos relativos a tu posici√≥n.
- Rot√° el minimap seg√∫n tu √°ngulo de vista (<code>EyeAngles().y</code>).
- Escala configurable.</p>
<p><strong>Objetivos:</strong> <code>surface.DrawRect</code>, <code>surface.DrawPoly</code>, transformaci√≥n de coordenadas, trigonometr√≠a</p>

<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- CLIENT</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">MAP_SIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">200</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">MAP_SCALE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span>

<span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;HUDPaint&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Minimap&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">lp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">LocalPlayer</span><span class="p">()</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nf">IsValid</span><span class="p">(</span><span class="nv">lp</span><span class="p">)</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">lp</span><span class="p">:</span><span class="nf">Alive</span><span class="p">()</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">mx</span><span class="p">,</span><span class="w"> </span><span class="nv">my</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ScrW</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">MAP_SIZE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">center</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">MAP_SIZE</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">myPos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">lp</span><span class="p">:</span><span class="nf">GetPos</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">myAng</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.rad</span><span class="p">(</span><span class="nv">lp</span><span class="p">:</span><span class="nf">EyeAngles</span><span class="p">().</span><span class="nv">y</span><span class="p">)</span>

<span class="w">    </span><span class="nv">draw</span><span class="p">.</span><span class="nf">RoundedBox</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="nv">mx</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nv">my</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nv">MAP_SIZE</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="nv">MAP_SIZE</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">200</span><span class="p">))</span>
<span class="w">    </span><span class="nv">draw</span><span class="p">.</span><span class="nf">RoundedBox</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nv">mx</span><span class="p">,</span><span class="w"> </span><span class="nv">my</span><span class="p">,</span><span class="w"> </span><span class="nv">MAP_SIZE</span><span class="p">,</span><span class="w"> </span><span class="nv">MAP_SIZE</span><span class="p">,</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="mi">35</span><span class="p">,</span><span class="mi">220</span><span class="p">))</span>

<span class="w">    </span><span class="nv">render</span><span class="p">.</span><span class="nf">SetScissorRect</span><span class="p">(</span><span class="nv">mx</span><span class="p">,</span><span class="w"> </span><span class="nv">my</span><span class="p">,</span><span class="w"> </span><span class="nv">mx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">MAP_SIZE</span><span class="p">,</span><span class="w"> </span><span class="nv">my</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">MAP_SIZE</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>

<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">ply</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">player</span><span class="p">.</span><span class="nf">GetAll</span><span class="p">())</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">ply</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">lp</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">Alive</span><span class="p">()</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="nv">continue</span><span class="w"> </span><span class="kr">end</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">diff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">GetPos</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">myPos</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">rx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">diff</span><span class="p">.</span><span class="py">x</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nv">MAP_SCALE</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">ry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nv">diff</span><span class="p">.</span><span class="py">y</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nv">MAP_SCALE</span>
<span class="w">        </span><span class="c1">-- Rotar seg√∫n vista</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">nx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">rx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">math.cos</span><span class="p">(</span><span class="o">-</span><span class="nv">myAng</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">ry</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">math.sin</span><span class="p">(</span><span class="o">-</span><span class="nv">myAng</span><span class="p">)</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">ny</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">rx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">math.sin</span><span class="p">(</span><span class="o">-</span><span class="nv">myAng</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">ry</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">math.cos</span><span class="p">(</span><span class="o">-</span><span class="nv">myAng</span><span class="p">)</span>
<span class="w">        </span><span class="nv">draw</span><span class="p">.</span><span class="nf">RoundedBox</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="nv">mx</span><span class="o">+</span><span class="nv">center</span><span class="o">+</span><span class="nv">nx</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="nv">my</span><span class="o">+</span><span class="nv">center</span><span class="o">+</span><span class="nv">ny</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">220</span><span class="p">,</span><span class="mi">60</span><span class="p">,</span><span class="mi">60</span><span class="p">))</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="nv">render</span><span class="p">.</span><span class="nf">SetScissorRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">    </span><span class="nv">draw</span><span class="p">.</span><span class="nf">RoundedBox</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="nv">mx</span><span class="o">+</span><span class="nv">center</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="nv">my</span><span class="o">+</span><span class="nv">center</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">255</span><span class="p">))</span>
<span class="w">    </span><span class="nv">surface</span><span class="p">.</span><span class="nf">SetDrawColor</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">120</span><span class="p">,</span><span class="mi">160</span><span class="p">,</span><span class="mi">120</span><span class="p">)</span>
<span class="w">    </span><span class="nv">surface</span><span class="p">.</span><span class="nf">DrawOutlinedRect</span><span class="p">(</span><span class="nv">mx</span><span class="p">,</span><span class="w"> </span><span class="nv">my</span><span class="p">,</span><span class="w"> </span><span class="nv">MAP_SIZE</span><span class="p">,</span><span class="w"> </span><span class="nv">MAP_SIZE</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="kr">end</span><span class="p">)</span>
</pre></div>
</pre></div>

</div>
</details>
<h3 id="ejercicio-75-disenar-este-hud-intermedio">Ejercicio 7.5 ‚Äî Dise√±ar este HUD <span class="badge medium">‚≠ê‚≠ê Intermedio</span></h3>
<p>Replic√° este dise√±o de HUD lo m√°s fiel posible usando <code>surface</code> y <code>draw</code>:</p>
<div class="highlight"><pre><span></span><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ‚ô• ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë  85/100              ‚îÇ
‚îÇ  üõ° ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë  45/100              ‚îÇ
‚îÇ                                           ‚îÇ
‚îÇ  üî´ PISTOL        30 / 120               ‚îÇ
‚îÇ                                           ‚îÇ
‚îÇ                              $12,500      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre></div>

<p>Barras con gradiente, texto con sombra, fondo con transparencia, √≠conos usando caracteres o materiales de <code>icon16/</code>.</p>
<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- CLIENT</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">matHeart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Material</span><span class="p">(</span><span class="s2">&quot;icon16/heart.png&quot;</span><span class="p">)</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">matShield</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Material</span><span class="p">(</span><span class="s2">&quot;icon16/shield.png&quot;</span><span class="p">)</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">matGun</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Material</span><span class="p">(</span><span class="s2">&quot;icon16/gun.png&quot;</span><span class="p">)</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">matMoney</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Material</span><span class="p">(</span><span class="s2">&quot;icon16/coins.png&quot;</span><span class="p">)</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">colBG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="mi">18</span><span class="p">,</span><span class="w"> </span><span class="mi">25</span><span class="p">,</span><span class="w"> </span><span class="mi">210</span><span class="p">)</span>

<span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;HUDPaint&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;MiHUD_Completo&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">ply</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">LocalPlayer</span><span class="p">()</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nf">IsValid</span><span class="p">(</span><span class="nv">ply</span><span class="p">)</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">Alive</span><span class="p">()</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">x</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="nf">ScrH</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">140</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">w</span><span class="p">,</span><span class="w"> </span><span class="nv">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">360</span><span class="p">,</span><span class="w"> </span><span class="mi">120</span>

<span class="w">    </span><span class="nv">draw</span><span class="p">.</span><span class="nf">RoundedBox</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="nv">x</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="p">,</span><span class="w"> </span><span class="nv">w</span><span class="p">,</span><span class="w"> </span><span class="nv">h</span><span class="p">,</span><span class="w"> </span><span class="nv">colBG</span><span class="p">)</span>

<span class="w">    </span><span class="c1">-- VIDA</span>
<span class="w">    </span><span class="nv">surface</span><span class="p">.</span><span class="nf">SetDrawColor</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">)</span>
<span class="w">    </span><span class="nv">surface</span><span class="p">.</span><span class="nf">SetMaterial</span><span class="p">(</span><span class="nv">matHeart</span><span class="p">)</span>
<span class="w">    </span><span class="nv">surface</span><span class="p">.</span><span class="nf">DrawTexturedRect</span><span class="p">(</span><span class="nv">x</span><span class="o">+</span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="o">+</span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">vidaPct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">math</span><span class="p">.</span><span class="nf">Clamp</span><span class="p">(</span><span class="nv">ply</span><span class="p">:</span><span class="nf">Health</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">GetMaxHealth</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="nv">draw</span><span class="p">.</span><span class="nf">RoundedBox</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="nv">x</span><span class="o">+</span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="o">+</span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">40</span><span class="p">))</span>
<span class="w">    </span><span class="nv">draw</span><span class="p">.</span><span class="nf">RoundedBox</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="nv">x</span><span class="o">+</span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="o">+</span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span><span class="o">*</span><span class="nv">vidaPct</span><span class="p">,</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span><span class="mi">60</span><span class="p">,</span><span class="mi">60</span><span class="p">))</span>
<span class="w">    </span><span class="nv">draw</span><span class="p">.</span><span class="nf">SimpleText</span><span class="p">(</span><span class="nv">ply</span><span class="p">:</span><span class="nf">Health</span><span class="p">()</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;/100&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;DermaDefault&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">x</span><span class="o">+</span><span class="mi">250</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="o">+</span><span class="mi">22</span><span class="p">,</span><span class="w"> </span><span class="nv">color_white</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">    </span><span class="c1">-- ARMADURA</span>
<span class="w">    </span><span class="nv">surface</span><span class="p">.</span><span class="nf">SetMaterial</span><span class="p">(</span><span class="nv">matShield</span><span class="p">)</span>
<span class="w">    </span><span class="nv">surface</span><span class="p">.</span><span class="nf">DrawTexturedRect</span><span class="p">(</span><span class="nv">x</span><span class="o">+</span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="o">+</span><span class="mi">38</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">armPct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">math</span><span class="p">.</span><span class="nf">Clamp</span><span class="p">(</span><span class="nv">ply</span><span class="p">:</span><span class="nf">Armor</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="nv">draw</span><span class="p">.</span><span class="nf">RoundedBox</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="nv">x</span><span class="o">+</span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="o">+</span><span class="mi">39</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">40</span><span class="p">))</span>
<span class="w">    </span><span class="nv">draw</span><span class="p">.</span><span class="nf">RoundedBox</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="nv">x</span><span class="o">+</span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="o">+</span><span class="mi">39</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span><span class="o">*</span><span class="nv">armPct</span><span class="p">,</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="mi">120</span><span class="p">,</span><span class="mi">220</span><span class="p">))</span>
<span class="w">    </span><span class="nv">draw</span><span class="p">.</span><span class="nf">SimpleText</span><span class="p">(</span><span class="nv">ply</span><span class="p">:</span><span class="nf">Armor</span><span class="p">()</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;/100&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;DermaDefault&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">x</span><span class="o">+</span><span class="mi">250</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="o">+</span><span class="mi">46</span><span class="p">,</span><span class="w"> </span><span class="nv">color_white</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">    </span><span class="c1">-- ARMA + MUNICION</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">wep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">GetActiveWeapon</span><span class="p">()</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nf">IsValid</span><span class="p">(</span><span class="nv">wep</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="nv">surface</span><span class="p">.</span><span class="nf">SetMaterial</span><span class="p">(</span><span class="nv">matGun</span><span class="p">)</span>
<span class="w">        </span><span class="nv">surface</span><span class="p">.</span><span class="nf">DrawTexturedRect</span><span class="p">(</span><span class="nv">x</span><span class="o">+</span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="o">+</span><span class="mi">68</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span>
<span class="w">        </span><span class="nv">draw</span><span class="p">.</span><span class="nf">SimpleText</span><span class="p">(</span><span class="nb">string.upper</span><span class="p">(</span><span class="nv">wep</span><span class="p">:</span><span class="nf">GetPrintName</span><span class="p">()),</span><span class="w"> </span><span class="s2">&quot;DermaDefaultBold&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">x</span><span class="o">+</span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="o">+</span><span class="mi">76</span><span class="p">,</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">200</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">wep</span><span class="p">:</span><span class="nf">Clip1</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="nv">draw</span><span class="p">.</span><span class="nf">SimpleText</span><span class="p">(</span><span class="nv">wep</span><span class="p">:</span><span class="nf">Clip1</span><span class="p">()</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; / &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">GetAmmoCount</span><span class="p">(</span><span class="nv">wep</span><span class="p">:</span><span class="nf">GetPrimaryAmmoType</span><span class="p">()),</span>
<span class="w">                </span><span class="s2">&quot;DermaDefault&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">x</span><span class="o">+</span><span class="mi">300</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="o">+</span><span class="mi">76</span><span class="p">,</span><span class="w"> </span><span class="nv">color_white</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="c1">-- DINERO</span>
<span class="w">    </span><span class="nv">surface</span><span class="p">.</span><span class="nf">SetMaterial</span><span class="p">(</span><span class="nv">matMoney</span><span class="p">)</span>
<span class="w">    </span><span class="nv">surface</span><span class="p">.</span><span class="nf">DrawTexturedRect</span><span class="p">(</span><span class="nv">x</span><span class="o">+</span><span class="nv">w</span><span class="o">-</span><span class="mi">110</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="o">+</span><span class="mi">96</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span>
<span class="w">    </span><span class="nv">draw</span><span class="p">.</span><span class="nf">SimpleText</span><span class="p">(</span><span class="s2">&quot;$12,500&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;DermaDefaultBold&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">x</span><span class="o">+</span><span class="nv">w</span><span class="o">-</span><span class="mi">88</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="o">+</span><span class="mi">104</span><span class="p">,</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">220</span><span class="p">,</span><span class="mi">100</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="kr">end</span><span class="p">)</span>

<span class="kd">local</span><span class="w"> </span><span class="nv">ocultar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="nv">CHudHealth</span><span class="o">=</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nv">CHudBattery</span><span class="o">=</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nv">CHudAmmo</span><span class="o">=</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nv">CHudSecondaryAmmo</span><span class="o">=</span><span class="kc">true</span><span class="p">}</span>
<span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;HUDShouldDraw&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;MiHUD_Ocultar&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">n</span><span class="p">)</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span><span class="nv">ocultar</span><span class="p">[</span><span class="nv">n</span><span class="p">]</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="kr">end</span><span class="w"> </span><span class="kr">end</span><span class="p">)</span>
</pre></div>
</pre></div>

</div>
</details>

<hr />
<h2 id="8-vgui-y-derma"><span class="num">08</span> VGUI y Derma</h2>
<h3 id="ejercicio-81-panel-de-informacion-de-jugador-facil">Ejercicio 8.1 ‚Äî Panel de Informaci√≥n de Jugador <span class="badge easy">‚≠ê F√°cil</span></h3>
<p>Cre√° un <code>DFrame</code> que muestre la informaci√≥n del jugador local: nombre, SteamID, vida, armadura, equipo, arma actual. Us√° <code>DLabel</code> para cada dato. Abrilo con un comando de consola.</p>

<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- CLIENT</span>
<span class="nv">concommand</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;mi_info&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">ply</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">LocalPlayer</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DFrame&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">frame</span><span class="p">:</span><span class="nf">SetSize</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span><span class="w"> </span><span class="mi">250</span><span class="p">)</span>
<span class="w">    </span><span class="nv">frame</span><span class="p">:</span><span class="nf">Center</span><span class="p">()</span>
<span class="w">    </span><span class="nv">frame</span><span class="p">:</span><span class="nf">SetTitle</span><span class="p">(</span><span class="s2">&quot;Info del Jugador&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">frame</span><span class="p">:</span><span class="nf">MakePopup</span><span class="p">()</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">datos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">{</span><span class="s2">&quot;Nombre&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">Nick</span><span class="p">()},</span>
<span class="w">        </span><span class="p">{</span><span class="s2">&quot;SteamID&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">SteamID</span><span class="p">()},</span>
<span class="w">        </span><span class="p">{</span><span class="s2">&quot;Vida&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">Health</span><span class="p">()</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;/&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">GetMaxHealth</span><span class="p">()},</span>
<span class="w">        </span><span class="p">{</span><span class="s2">&quot;Armadura&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">ply</span><span class="p">:</span><span class="nf">Armor</span><span class="p">())},</span>
<span class="w">        </span><span class="p">{</span><span class="s2">&quot;Equipo&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">team</span><span class="p">.</span><span class="nf">GetName</span><span class="p">(</span><span class="nv">ply</span><span class="p">:</span><span class="nf">Team</span><span class="p">())},</span>
<span class="w">        </span><span class="p">{</span><span class="s2">&quot;Arma&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">IsValid</span><span class="p">(</span><span class="nv">ply</span><span class="p">:</span><span class="nf">GetActiveWeapon</span><span class="p">())</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">GetActiveWeapon</span><span class="p">():</span><span class="nf">GetPrintName</span><span class="p">()</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s2">&quot;Ninguna&quot;</span><span class="p">},</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">d</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">datos</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DPanel&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">frame</span><span class="p">)</span>
<span class="w">        </span><span class="nv">p</span><span class="p">:</span><span class="nf">Dock</span><span class="p">(</span><span class="nv">TOP</span><span class="p">)</span>
<span class="w">        </span><span class="nv">p</span><span class="p">:</span><span class="nf">SetTall</span><span class="p">(</span><span class="mi">28</span><span class="p">)</span>
<span class="w">        </span><span class="nv">p</span><span class="p">:</span><span class="nf">DockMargin</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="nv">p</span><span class="p">.</span><span class="py">Paint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">s</span><span class="p">,</span><span class="w"> </span><span class="nv">w</span><span class="p">,</span><span class="w"> </span><span class="nv">h</span><span class="p">)</span><span class="w"> </span><span class="nv">draw</span><span class="p">.</span><span class="nf">RoundedBox</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">w</span><span class="p">,</span><span class="w"> </span><span class="nv">h</span><span class="p">,</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">100</span><span class="p">))</span><span class="w"> </span><span class="kr">end</span>

<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DLabel&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">p</span><span class="p">)</span>
<span class="w">        </span><span class="nv">k</span><span class="p">:</span><span class="nf">SetPos</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span>
<span class="w">        </span><span class="nv">k</span><span class="p">:</span><span class="nf">SetFont</span><span class="p">(</span><span class="s2">&quot;DermaDefaultBold&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nv">k</span><span class="p">:</span><span class="nf">SetText</span><span class="p">(</span><span class="nv">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nv">k</span><span class="p">:</span><span class="nf">SizeToContents</span><span class="p">()</span>

<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DLabel&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">p</span><span class="p">)</span>
<span class="w">        </span><span class="nv">v</span><span class="p">:</span><span class="nf">SetPos</span><span class="p">(</span><span class="mi">120</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span>
<span class="w">        </span><span class="nv">v</span><span class="p">:</span><span class="nf">SetText</span><span class="p">(</span><span class="nv">d</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="w">        </span><span class="nv">v</span><span class="p">:</span><span class="nf">SizeToContents</span><span class="p">()</span>
<span class="w">    </span><span class="kr">end</span>
<span class="kr">end</span><span class="p">)</span>
</pre></div>
</pre></div>

</div>
</details>
<h3 id="ejercicio-82-menu-de-configuracion-con-guardado-intermedio">Ejercicio 8.2 ‚Äî Men√∫ de Configuraci√≥n con Guardado <span class="badge medium">‚≠ê‚≠ê Intermedio</span></h3>
<p>Dise√±√° un men√∫ de configuraci√≥n con:
- Un <code>DCheckBoxLabel</code> para activar/desactivar tu HUD.
- Un <code>DNumSlider</code> para el tama√±o del HUD.
- Un <code>DComboBox</code> para elegir el color del tema (Rojo, Azul, Verde, Morado).
- Un bot√≥n "Guardar" que almacene las preferencias en ConVars del cliente.
- Un bot√≥n "Resetear" que vuelva todo a los valores por defecto.</p>
<p><strong>Objetivos:</strong> <code>CreateClientConVar</code>, <code>GetConVar</code>, <code>DFrame</code> con <code>DPropertySheet</code> o layout vertical</p>

<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- CLIENT</span>
<span class="nf">CreateClientConVar</span><span class="p">(</span><span class="s2">&quot;miaddon_hud_on&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="nf">CreateClientConVar</span><span class="p">(</span><span class="s2">&quot;miaddon_hud_scale&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="nf">CreateClientConVar</span><span class="p">(</span><span class="s2">&quot;miaddon_hud_color&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;blue&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>

<span class="nv">concommand</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;mi_config&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DFrame&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">frame</span><span class="p">:</span><span class="nf">SetSize</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span><span class="w"> </span><span class="mi">300</span><span class="p">)</span>
<span class="w">    </span><span class="nv">frame</span><span class="p">:</span><span class="nf">Center</span><span class="p">()</span>
<span class="w">    </span><span class="nv">frame</span><span class="p">:</span><span class="nf">SetTitle</span><span class="p">(</span><span class="s2">&quot;Configuraci√≥n&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">frame</span><span class="p">:</span><span class="nf">MakePopup</span><span class="p">()</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">chk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DCheckBoxLabel&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">frame</span><span class="p">)</span>
<span class="w">    </span><span class="nv">chk</span><span class="p">:</span><span class="nf">SetPos</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">)</span>
<span class="w">    </span><span class="nv">chk</span><span class="p">:</span><span class="nf">SetText</span><span class="p">(</span><span class="s2">&quot;Activar HUD personalizado&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">chk</span><span class="p">:</span><span class="nf">SetConVar</span><span class="p">(</span><span class="s2">&quot;miaddon_hud_on&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">chk</span><span class="p">:</span><span class="nf">SizeToContents</span><span class="p">()</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">slider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DNumSlider&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">frame</span><span class="p">)</span>
<span class="w">    </span><span class="nv">slider</span><span class="p">:</span><span class="nf">SetPos</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">80</span><span class="p">)</span>
<span class="w">    </span><span class="nv">slider</span><span class="p">:</span><span class="nf">SetSize</span><span class="p">(</span><span class="mi">360</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">)</span>
<span class="w">    </span><span class="nv">slider</span><span class="p">:</span><span class="nf">SetText</span><span class="p">(</span><span class="s2">&quot;Tama√±o del HUD&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">slider</span><span class="p">:</span><span class="nf">SetMin</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
<span class="w">    </span><span class="nv">slider</span><span class="p">:</span><span class="nf">SetMax</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="w">    </span><span class="nv">slider</span><span class="p">:</span><span class="nf">SetDecimals</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="nv">slider</span><span class="p">:</span><span class="nf">SetConVar</span><span class="p">(</span><span class="s2">&quot;miaddon_hud_scale&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">combo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DComboBox&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">frame</span><span class="p">)</span>
<span class="w">    </span><span class="nv">combo</span><span class="p">:</span><span class="nf">SetPos</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">155</span><span class="p">)</span>
<span class="w">    </span><span class="nv">combo</span><span class="p">:</span><span class="nf">SetSize</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">)</span>
<span class="w">    </span><span class="nv">combo</span><span class="p">:</span><span class="nf">AddChoice</span><span class="p">(</span><span class="s2">&quot;Rojo&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">combo</span><span class="p">:</span><span class="nf">AddChoice</span><span class="p">(</span><span class="s2">&quot;Azul&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;blue&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">combo</span><span class="p">:</span><span class="nf">AddChoice</span><span class="p">(</span><span class="s2">&quot;Verde&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;green&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">combo</span><span class="p">:</span><span class="nf">AddChoice</span><span class="p">(</span><span class="s2">&quot;Morado&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;purple&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">combo</span><span class="p">:</span><span class="nf">SetValue</span><span class="p">(</span><span class="nf">GetConVar</span><span class="p">(</span><span class="s2">&quot;miaddon_hud_color&quot;</span><span class="p">):</span><span class="nf">GetString</span><span class="p">())</span>
<span class="w">    </span><span class="nv">combo</span><span class="p">.</span><span class="py">OnSelect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">s</span><span class="p">,</span><span class="w"> </span><span class="nv">i</span><span class="p">,</span><span class="w"> </span><span class="nv">v</span><span class="p">,</span><span class="w"> </span><span class="nv">data</span><span class="p">)</span><span class="w"> </span><span class="nf">RunConsoleCommand</span><span class="p">(</span><span class="s2">&quot;miaddon_hud_color&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">data</span><span class="p">)</span><span class="w"> </span><span class="kr">end</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">btnReset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DButton&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">frame</span><span class="p">)</span>
<span class="w">    </span><span class="nv">btnReset</span><span class="p">:</span><span class="nf">SetPos</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">220</span><span class="p">)</span>
<span class="w">    </span><span class="nv">btnReset</span><span class="p">:</span><span class="nf">SetSize</span><span class="p">(</span><span class="mi">170</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">)</span>
<span class="w">    </span><span class="nv">btnReset</span><span class="p">:</span><span class="nf">SetText</span><span class="p">(</span><span class="s2">&quot;Resetear&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">btnReset</span><span class="p">.</span><span class="py">DoClick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span>
<span class="w">        </span><span class="nf">RunConsoleCommand</span><span class="p">(</span><span class="s2">&quot;miaddon_hud_on&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nf">RunConsoleCommand</span><span class="p">(</span><span class="s2">&quot;miaddon_hud_scale&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nf">RunConsoleCommand</span><span class="p">(</span><span class="s2">&quot;miaddon_hud_color&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;blue&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kr">end</span>
<span class="kr">end</span><span class="p">)</span>
</pre></div>
</pre></div>

</div>
</details>
<h3 id="ejercicio-83-disenar-una-tienda-con-ui-completa-avanzado">Ejercicio 8.3 ‚Äî Dise√±ar una Tienda con UI Completa <span class="badge advanced">‚≠ê‚≠ê‚≠ê Avanzado</span></h3>
<p>Cre√° la UI completa de una tienda con estas caracter√≠sticas:
- <code>DFrame</code> principal con t√≠tulo personalizado (paint custom).
- Sidebar izquierda con categor√≠as (Armas, Comida, Veh√≠culos) usando <code>DButton</code> con paint custom.
- Panel principal con <code>DScrollPanel</code> mostrando los items de la categor√≠a seleccionada.
- Cada item: √≠cono (material), nombre, descripci√≥n, precio, y bot√≥n "Comprar".
- Footer con el dinero actual del jugador.
- Animaci√≥n de hover en los items.</p>
<p>No necesit√°s implementar la l√≥gica de compra server-side ‚Äî solo la UI.</p>

<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<p>UI de tienda completa con sidebar de categor√≠as, panel de items con scroll, y paint custom en todos los elementos.</p>
<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- CLIENT</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">CATS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">{</span><span class="nv">nombre</span><span class="o">=</span><span class="s2">&quot;Armas&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">items</span><span class="o">=</span><span class="p">{</span>
<span class="w">        </span><span class="p">{</span><span class="nv">nombre</span><span class="o">=</span><span class="s2">&quot;Pistola&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">desc</span><span class="o">=</span><span class="s2">&quot;Arma b√°sica&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">precio</span><span class="o">=</span><span class="mi">500</span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="nv">nombre</span><span class="o">=</span><span class="s2">&quot;SMG&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">desc</span><span class="o">=</span><span class="s2">&quot;Subfusil&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">precio</span><span class="o">=</span><span class="mi">1200</span><span class="p">},</span>
<span class="w">    </span><span class="p">}},</span>
<span class="w">    </span><span class="p">{</span><span class="nv">nombre</span><span class="o">=</span><span class="s2">&quot;Comida&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">items</span><span class="o">=</span><span class="p">{</span>
<span class="w">        </span><span class="p">{</span><span class="nv">nombre</span><span class="o">=</span><span class="s2">&quot;Manzana&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">desc</span><span class="o">=</span><span class="s2">&quot;Cura 10 HP&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">precio</span><span class="o">=</span><span class="mi">50</span><span class="p">},</span>
<span class="w">    </span><span class="p">}},</span>
<span class="p">}</span>

<span class="nv">concommand</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;mi_tienda&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DFrame&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">f</span><span class="p">:</span><span class="nf">SetSize</span><span class="p">(</span><span class="mi">600</span><span class="p">,</span><span class="w"> </span><span class="mi">400</span><span class="p">)</span>
<span class="w">    </span><span class="nv">f</span><span class="p">:</span><span class="nf">Center</span><span class="p">()</span>
<span class="w">    </span><span class="nv">f</span><span class="p">:</span><span class="nf">SetTitle</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">f</span><span class="p">:</span><span class="nf">MakePopup</span><span class="p">()</span>
<span class="w">    </span><span class="nv">f</span><span class="p">.</span><span class="py">Paint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">s</span><span class="p">,</span><span class="nv">w</span><span class="p">,</span><span class="nv">h</span><span class="p">)</span>
<span class="w">        </span><span class="nv">draw</span><span class="p">.</span><span class="nf">RoundedBox</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">w</span><span class="p">,</span><span class="w"> </span><span class="nv">h</span><span class="p">,</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">22</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="mi">35</span><span class="p">))</span>
<span class="w">        </span><span class="nv">draw</span><span class="p">.</span><span class="nf">RoundedBox</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">w</span><span class="p">,</span><span class="w"> </span><span class="mi">36</span><span class="p">,</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="mi">35</span><span class="p">,</span><span class="mi">50</span><span class="p">))</span>
<span class="w">        </span><span class="nv">draw</span><span class="p">.</span><span class="nf">SimpleText</span><span class="p">(</span><span class="s2">&quot;TIENDA&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;DermaDefaultBold&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="mi">18</span><span class="p">,</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">215</span><span class="p">,</span><span class="mi">80</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">sb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DPanel&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">f</span><span class="p">)</span>
<span class="w">    </span><span class="nv">sb</span><span class="p">:</span><span class="nf">Dock</span><span class="p">(</span><span class="nv">LEFT</span><span class="p">)</span>
<span class="w">    </span><span class="nv">sb</span><span class="p">:</span><span class="nf">SetWide</span><span class="p">(</span><span class="mi">130</span><span class="p">)</span>
<span class="w">    </span><span class="nv">sb</span><span class="p">.</span><span class="py">Paint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">s</span><span class="p">,</span><span class="nv">w</span><span class="p">,</span><span class="nv">h</span><span class="p">)</span><span class="w"> </span><span class="nv">draw</span><span class="p">.</span><span class="nf">RoundedBox</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">w</span><span class="p">,</span><span class="w"> </span><span class="nv">h</span><span class="p">,</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">28</span><span class="p">))</span><span class="w"> </span><span class="kr">end</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DScrollPanel&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">f</span><span class="p">)</span>
<span class="w">    </span><span class="nv">content</span><span class="p">:</span><span class="nf">Dock</span><span class="p">(</span><span class="nv">FILL</span><span class="p">)</span>
<span class="w">    </span><span class="nv">content</span><span class="p">:</span><span class="nf">DockMargin</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">)</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">activeCat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">nil</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">ShowCat</span><span class="p">(</span><span class="nv">cat</span><span class="p">)</span>
<span class="w">        </span><span class="nv">content</span><span class="p">:</span><span class="nf">Clear</span><span class="p">()</span>
<span class="w">        </span><span class="nv">activeCat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">cat</span><span class="p">.</span><span class="py">nombre</span>
<span class="w">        </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">item</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">cat</span><span class="p">.</span><span class="py">items</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">            </span><span class="kd">local</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">content</span><span class="p">:</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;DPanel&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="nv">p</span><span class="p">:</span><span class="nf">Dock</span><span class="p">(</span><span class="nv">TOP</span><span class="p">)</span>
<span class="w">            </span><span class="nv">p</span><span class="p">:</span><span class="nf">SetTall</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
<span class="w">            </span><span class="nv">p</span><span class="p">:</span><span class="nf">DockMargin</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">            </span><span class="nv">p</span><span class="p">.</span><span class="py">hov</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">            </span><span class="nv">p</span><span class="p">.</span><span class="py">Paint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">s</span><span class="p">,</span><span class="nv">w</span><span class="p">,</span><span class="nv">h</span><span class="p">)</span>
<span class="w">                </span><span class="nv">s</span><span class="p">.</span><span class="py">hov</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Lerp</span><span class="p">(</span><span class="nf">FrameTime</span><span class="p">()</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="nv">s</span><span class="p">.</span><span class="py">hov</span><span class="p">,</span><span class="w"> </span><span class="nv">s</span><span class="p">:</span><span class="nf">IsHovered</span><span class="p">()</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">                </span><span class="nv">draw</span><span class="p">.</span><span class="nf">RoundedBox</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">w</span><span class="p">,</span><span class="w"> </span><span class="nv">h</span><span class="p">,</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">32</span><span class="o">+</span><span class="mi">10</span><span class="o">*</span><span class="nv">s</span><span class="p">.</span><span class="py">hov</span><span class="p">,</span><span class="w"> </span><span class="mi">36</span><span class="o">+</span><span class="mi">10</span><span class="o">*</span><span class="nv">s</span><span class="p">.</span><span class="py">hov</span><span class="p">,</span><span class="w"> </span><span class="mi">48</span><span class="o">+</span><span class="mi">10</span><span class="o">*</span><span class="nv">s</span><span class="p">.</span><span class="py">hov</span><span class="p">))</span>
<span class="w">            </span><span class="kr">end</span>
<span class="w">            </span><span class="kd">local</span><span class="w"> </span><span class="nv">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DLabel&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">p</span><span class="p">)</span>
<span class="w">            </span><span class="nv">l</span><span class="p">:</span><span class="nf">SetPos</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span>
<span class="w">            </span><span class="nv">l</span><span class="p">:</span><span class="nf">SetFont</span><span class="p">(</span><span class="s2">&quot;DermaDefaultBold&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="nv">l</span><span class="p">:</span><span class="nf">SetText</span><span class="p">(</span><span class="nv">item</span><span class="p">.</span><span class="py">nombre</span><span class="p">)</span>
<span class="w">            </span><span class="nv">l</span><span class="p">:</span><span class="nf">SizeToContents</span><span class="p">()</span>
<span class="w">            </span><span class="kd">local</span><span class="w"> </span><span class="nv">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DLabel&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">p</span><span class="p">)</span>
<span class="w">            </span><span class="nv">d</span><span class="p">:</span><span class="nf">SetPos</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="mi">26</span><span class="p">)</span>
<span class="w">            </span><span class="nv">d</span><span class="p">:</span><span class="nf">SetText</span><span class="p">(</span><span class="nv">item</span><span class="p">.</span><span class="py">desc</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; ‚Äî $&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">item</span><span class="p">.</span><span class="py">precio</span><span class="p">)</span>
<span class="w">            </span><span class="nv">d</span><span class="p">:</span><span class="nf">SetColor</span><span class="p">(</span><span class="nf">Color</span><span class="p">(</span><span class="mi">180</span><span class="p">,</span><span class="mi">180</span><span class="p">,</span><span class="mi">180</span><span class="p">))</span>
<span class="w">            </span><span class="nv">d</span><span class="p">:</span><span class="nf">SizeToContents</span><span class="p">()</span>
<span class="w">            </span><span class="kd">local</span><span class="w"> </span><span class="nv">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DButton&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">p</span><span class="p">)</span>
<span class="w">            </span><span class="nv">b</span><span class="p">:</span><span class="nf">SetPos</span><span class="p">(</span><span class="mi">370</span><span class="p">,</span><span class="w"> </span><span class="mi">14</span><span class="p">)</span>
<span class="w">            </span><span class="nv">b</span><span class="p">:</span><span class="nf">SetSize</span><span class="p">(</span><span class="mi">70</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span>
<span class="w">            </span><span class="nv">b</span><span class="p">:</span><span class="nf">SetText</span><span class="p">(</span><span class="s2">&quot;Comprar&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="nv">b</span><span class="p">.</span><span class="py">DoClick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span><span class="w"> </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comprar: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">item</span><span class="p">.</span><span class="py">nombre</span><span class="p">)</span><span class="w"> </span><span class="kr">end</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">cat</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">CATS</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">btn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DButton&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">sb</span><span class="p">)</span>
<span class="w">        </span><span class="nv">btn</span><span class="p">:</span><span class="nf">Dock</span><span class="p">(</span><span class="nv">TOP</span><span class="p">)</span>
<span class="w">        </span><span class="nv">btn</span><span class="p">:</span><span class="nf">SetTall</span><span class="p">(</span><span class="mi">36</span><span class="p">)</span>
<span class="w">        </span><span class="nv">btn</span><span class="p">:</span><span class="nf">DockMargin</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="nv">btn</span><span class="p">:</span><span class="nf">SetText</span><span class="p">(</span><span class="nv">cat</span><span class="p">.</span><span class="py">nombre</span><span class="p">)</span>
<span class="w">        </span><span class="nv">btn</span><span class="p">.</span><span class="py">DoClick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span><span class="w"> </span><span class="nf">ShowCat</span><span class="p">(</span><span class="nv">cat</span><span class="p">)</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="nf">ShowCat</span><span class="p">(</span><span class="nv">CATS</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="kr">end</span><span class="p">)</span>
</pre></div>
</pre></div>

</div>
</details>
<h3 id="ejercicio-84-encontrar-el-bug-panel-que-no-cierra-facil">Ejercicio 8.4 ‚Äî Encontrar el Bug: Panel que No Cierra <span class="badge easy">‚≠ê F√°cil</span></h3>
<p>¬øPor qu√© este men√∫ no se puede cerrar con Escape y el mouse queda atrapado?</p>
<div class="highlight"><pre><span></span><code><span class="nv">concommand</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;abrir_menu&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DPanel&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">frame</span><span class="p">:</span><span class="nf">SetSize</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span><span class="w"> </span><span class="mi">300</span><span class="p">)</span>
<span class="w">    </span><span class="nv">frame</span><span class="p">:</span><span class="nf">Center</span><span class="p">()</span>
<span class="w">    </span><span class="nv">frame</span><span class="p">:</span><span class="nf">MakePopup</span><span class="p">()</span>

<span class="w">    </span><span class="nv">frame</span><span class="p">.</span><span class="py">Paint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">self</span><span class="p">,</span><span class="w"> </span><span class="nv">w</span><span class="p">,</span><span class="w"> </span><span class="nv">h</span><span class="p">)</span>
<span class="w">        </span><span class="nv">draw</span><span class="p">.</span><span class="nf">RoundedBox</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">w</span><span class="p">,</span><span class="w"> </span><span class="nv">h</span><span class="p">,</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span><span class="p">))</span>
<span class="w">        </span><span class="nv">draw</span><span class="p">.</span><span class="nf">SimpleText</span><span class="p">(</span><span class="s2">&quot;Mi Men√∫&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;DermaLarge&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">w</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="nv">color_white</span><span class="p">,</span><span class="w"> </span><span class="nv">TEXT_ALIGN_CENTER</span><span class="p">)</span>
<span class="w">    </span><span class="kr">end</span>
<span class="kr">end</span><span class="p">)</span>
</code></pre></div>


<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<p><strong>El problema:</strong> Se usa <code>DPanel</code> en vez de <code>DFrame</code>. <code>DPanel</code> no tiene l√≥gica de cerrar con Escape ni bot√≥n de cierre. <code>MakePopup()</code> captura el input pero no hay forma de liberarlo.</p>
<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- SOLUCI√ìN: Usar DFrame</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DFrame&quot;</span><span class="p">)</span><span class="w">  </span><span class="c1">-- No DPanel</span>
<span class="nv">frame</span><span class="p">:</span><span class="nf">SetSize</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span><span class="w"> </span><span class="mi">300</span><span class="p">)</span>
<span class="nv">frame</span><span class="p">:</span><span class="nf">Center</span><span class="p">()</span>
<span class="nv">frame</span><span class="p">:</span><span class="nf">SetTitle</span><span class="p">(</span><span class="s2">&quot;Mi Men√∫&quot;</span><span class="p">)</span>
<span class="nv">frame</span><span class="p">:</span><span class="nf">ShowCloseButton</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="nv">frame</span><span class="p">:</span><span class="nf">MakePopup</span><span class="p">()</span>
</pre></div>
</pre></div>

</div>
</details>
<h3 id="ejercicio-85-sistema-de-tabs-personalizado-intermedio">Ejercicio 8.5 ‚Äî Sistema de Tabs Personalizado <span class="badge medium">‚≠ê‚≠ê Intermedio</span></h3>
<p>Cre√° un sistema de pesta√±as (tabs) personalizado sin usar <code>DPropertySheet</code>. Debe tener:
- Una fila de botones en la parte superior con paint custom (la tab activa resaltada).
- Un panel de contenido que cambia seg√∫n la tab seleccionada.
- Animaci√≥n suave de transici√≥n al cambiar de tab (fade o slide).</p>

<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- CLIENT</span>
<span class="nv">concommand</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;mi_tabs&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DFrame&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">frame</span><span class="p">:</span><span class="nf">SetSize</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span><span class="w"> </span><span class="mi">400</span><span class="p">)</span>
<span class="w">    </span><span class="nv">frame</span><span class="p">:</span><span class="nf">Center</span><span class="p">()</span>
<span class="w">    </span><span class="nv">frame</span><span class="p">:</span><span class="nf">SetTitle</span><span class="p">(</span><span class="s2">&quot;Panel con Tabs&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">frame</span><span class="p">:</span><span class="nf">MakePopup</span><span class="p">()</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">tabBar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DPanel&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">frame</span><span class="p">)</span>
<span class="w">    </span><span class="nv">tabBar</span><span class="p">:</span><span class="nf">Dock</span><span class="p">(</span><span class="nv">TOP</span><span class="p">)</span>
<span class="w">    </span><span class="nv">tabBar</span><span class="p">:</span><span class="nf">SetTall</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span>
<span class="w">    </span><span class="nv">tabBar</span><span class="p">.</span><span class="py">Paint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">s</span><span class="p">,</span><span class="nv">w</span><span class="p">,</span><span class="nv">h</span><span class="p">)</span><span class="w"> </span><span class="nv">draw</span><span class="p">.</span><span class="nf">RoundedBox</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">w</span><span class="p">,</span><span class="w"> </span><span class="nv">h</span><span class="p">,</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">38</span><span class="p">))</span><span class="w"> </span><span class="kr">end</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DPanel&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">frame</span><span class="p">)</span>
<span class="w">    </span><span class="nv">content</span><span class="p">:</span><span class="nf">Dock</span><span class="p">(</span><span class="nv">FILL</span><span class="p">)</span>
<span class="w">    </span><span class="nv">content</span><span class="p">.</span><span class="py">Paint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span><span class="w"> </span><span class="kr">end</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">activeTab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">tabs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;General&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Jugadores&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Opciones&quot;</span><span class="p">}</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">SetTab</span><span class="p">(</span><span class="nv">nombre</span><span class="p">)</span>
<span class="w">        </span><span class="nv">activeTab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">nombre</span>
<span class="w">        </span><span class="nv">content</span><span class="p">:</span><span class="nf">Clear</span><span class="p">()</span>
<span class="w">        </span><span class="nv">content</span><span class="p">:</span><span class="nf">SetAlpha</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="nv">content</span><span class="p">:</span><span class="nf">AlphaTo</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mf">0.15</span><span class="p">)</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">lbl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DLabel&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">content</span><span class="p">)</span>
<span class="w">        </span><span class="nv">lbl</span><span class="p">:</span><span class="nf">Dock</span><span class="p">(</span><span class="nv">FILL</span><span class="p">)</span>
<span class="w">        </span><span class="nv">lbl</span><span class="p">:</span><span class="nf">SetContentAlignment</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="w">        </span><span class="nv">lbl</span><span class="p">:</span><span class="nf">SetFont</span><span class="p">(</span><span class="s2">&quot;DermaLarge&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nv">lbl</span><span class="p">:</span><span class="nf">SetText</span><span class="p">(</span><span class="s2">&quot;Contenido: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">nombre</span><span class="p">)</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">nombre</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">tabs</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">btn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DButton&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">tabBar</span><span class="p">)</span>
<span class="w">        </span><span class="nv">btn</span><span class="p">:</span><span class="nf">Dock</span><span class="p">(</span><span class="nv">LEFT</span><span class="p">)</span>
<span class="w">        </span><span class="nv">btn</span><span class="p">:</span><span class="nf">SetWide</span><span class="p">(</span><span class="mi">140</span><span class="p">)</span>
<span class="w">        </span><span class="nv">btn</span><span class="p">:</span><span class="nf">SetText</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nv">btn</span><span class="p">.</span><span class="py">Paint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">s</span><span class="p">,</span><span class="nv">w</span><span class="p">,</span><span class="nv">h</span><span class="p">)</span>
<span class="w">            </span><span class="kd">local</span><span class="w"> </span><span class="nv">act</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">activeTab</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">nombre</span>
<span class="w">            </span><span class="kd">local</span><span class="w"> </span><span class="nv">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">act</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">200</span><span class="p">)</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nv">s</span><span class="p">:</span><span class="nf">IsHovered</span><span class="p">()</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span><span class="mi">45</span><span class="p">,</span><span class="mi">60</span><span class="p">)</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="mi">33</span><span class="p">,</span><span class="mi">45</span><span class="p">)</span>
<span class="w">            </span><span class="nv">draw</span><span class="p">.</span><span class="nf">RoundedBoxEx</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">w</span><span class="p">,</span><span class="w"> </span><span class="nv">h</span><span class="p">,</span><span class="w"> </span><span class="nv">c</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">            </span><span class="nv">draw</span><span class="p">.</span><span class="nf">SimpleText</span><span class="p">(</span><span class="nv">nombre</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;DermaDefaultBold&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">w</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nv">h</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
<span class="w">                </span><span class="nv">act</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">color_white</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">160</span><span class="p">,</span><span class="mi">165</span><span class="p">,</span><span class="mi">180</span><span class="p">),</span><span class="w"> </span><span class="nv">TEXT_ALIGN_CENTER</span><span class="p">,</span><span class="w"> </span><span class="nv">TEXT_ALIGN_CENTER</span><span class="p">)</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">        </span><span class="nv">btn</span><span class="p">.</span><span class="py">DoClick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span><span class="w"> </span><span class="nf">SetTab</span><span class="p">(</span><span class="nv">nombre</span><span class="p">)</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="nf">SetTab</span><span class="p">(</span><span class="nv">tabs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="kr">end</span><span class="p">)</span>
</pre></div>
</pre></div>

</div>
</details>
<h3 id="ejercicio-86-popup-de-confirmacion-reutilizable-intermedio">Ejercicio 8.6 ‚Äî Popup de Confirmaci√≥n Reutilizable <span class="badge medium">‚≠ê‚≠ê Intermedio</span></h3>
<p>Cre√° una funci√≥n <code>MostrarConfirmacion(titulo, mensaje, callbackSi, callbackNo)</code> que abra un popup centrado con el mensaje, y dos botones "Confirmar" y "Cancelar". Debe ser reutilizable desde cualquier parte del c√≥digo. Inclu√≠ animaci√≥n de apertura (scale o fade in).</p>
<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- CLIENT</span>
<span class="kr">function</span><span class="w"> </span><span class="nf">MostrarConfirmacion</span><span class="p">(</span><span class="nv">titulo</span><span class="p">,</span><span class="w"> </span><span class="nv">mensaje</span><span class="p">,</span><span class="w"> </span><span class="nv">callbackSi</span><span class="p">,</span><span class="w"> </span><span class="nv">callbackNo</span><span class="p">)</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DFrame&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">f</span><span class="p">:</span><span class="nf">SetSize</span><span class="p">(</span><span class="mi">350</span><span class="p">,</span><span class="w"> </span><span class="mi">180</span><span class="p">)</span>
<span class="w">    </span><span class="nv">f</span><span class="p">:</span><span class="nf">Center</span><span class="p">()</span>
<span class="w">    </span><span class="nv">f</span><span class="p">:</span><span class="nf">SetTitle</span><span class="p">(</span><span class="nv">titulo</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s2">&quot;Confirmaci√≥n&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">f</span><span class="p">:</span><span class="nf">MakePopup</span><span class="p">()</span>
<span class="w">    </span><span class="nv">f</span><span class="p">:</span><span class="nf">SetAlpha</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="nv">f</span><span class="p">:</span><span class="nf">AlphaTo</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mf">0.15</span><span class="p">)</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">lbl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DLabel&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">f</span><span class="p">)</span>
<span class="w">    </span><span class="nv">lbl</span><span class="p">:</span><span class="nf">Dock</span><span class="p">(</span><span class="nv">TOP</span><span class="p">)</span>
<span class="w">    </span><span class="nv">lbl</span><span class="p">:</span><span class="nf">DockMargin</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span>
<span class="w">    </span><span class="nv">lbl</span><span class="p">:</span><span class="nf">SetText</span><span class="p">(</span><span class="nv">mensaje</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s2">&quot;¬øEst√°s seguro?&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">lbl</span><span class="p">:</span><span class="nf">SetWrap</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">    </span><span class="nv">lbl</span><span class="p">:</span><span class="nf">SetAutoStretchVertical</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">    </span><span class="nv">lbl</span><span class="p">:</span><span class="nf">SetContentAlignment</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">bp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DPanel&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">f</span><span class="p">)</span>
<span class="w">    </span><span class="nv">bp</span><span class="p">:</span><span class="nf">Dock</span><span class="p">(</span><span class="nv">BOTTOM</span><span class="p">)</span>
<span class="w">    </span><span class="nv">bp</span><span class="p">:</span><span class="nf">SetTall</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
<span class="w">    </span><span class="nv">bp</span><span class="p">:</span><span class="nf">DockMargin</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span>
<span class="w">    </span><span class="nv">bp</span><span class="p">.</span><span class="py">Paint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span><span class="w"> </span><span class="kr">end</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">btnSi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DButton&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">bp</span><span class="p">)</span>
<span class="w">    </span><span class="nv">btnSi</span><span class="p">:</span><span class="nf">Dock</span><span class="p">(</span><span class="nv">LEFT</span><span class="p">)</span>
<span class="w">    </span><span class="nv">btnSi</span><span class="p">:</span><span class="nf">SetWide</span><span class="p">(</span><span class="mi">155</span><span class="p">)</span>
<span class="w">    </span><span class="nv">btnSi</span><span class="p">:</span><span class="nf">SetText</span><span class="p">(</span><span class="s2">&quot;Confirmar&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">btnSi</span><span class="p">.</span><span class="py">DoClick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span><span class="w"> </span><span class="nv">f</span><span class="p">:</span><span class="nf">Close</span><span class="p">()</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span><span class="nv">callbackSi</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="nf">callbackSi</span><span class="p">()</span><span class="w"> </span><span class="kr">end</span><span class="w"> </span><span class="kr">end</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">btnNo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DButton&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">bp</span><span class="p">)</span>
<span class="w">    </span><span class="nv">btnNo</span><span class="p">:</span><span class="nf">Dock</span><span class="p">(</span><span class="nv">RIGHT</span><span class="p">)</span>
<span class="w">    </span><span class="nv">btnNo</span><span class="p">:</span><span class="nf">SetWide</span><span class="p">(</span><span class="mi">155</span><span class="p">)</span>
<span class="w">    </span><span class="nv">btnNo</span><span class="p">:</span><span class="nf">SetText</span><span class="p">(</span><span class="s2">&quot;Cancelar&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">btnNo</span><span class="p">.</span><span class="py">DoClick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span><span class="w"> </span><span class="nv">f</span><span class="p">:</span><span class="nf">Close</span><span class="p">()</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span><span class="nv">callbackNo</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="nf">callbackNo</span><span class="p">()</span><span class="w"> </span><span class="kr">end</span><span class="w"> </span><span class="kr">end</span>
<span class="kr">end</span>

<span class="c1">-- Uso: MostrarConfirmacion(&quot;Eliminar&quot;, &quot;¬øSeguro?&quot;, function() print(&quot;S√≠&quot;) end)</span>
</pre></div>
</pre></div>

</div>
</details>

<hr />
<h2 id="9-renderizado-3d"><span class="num">09</span> Renderizado 3D</h2>
<h3 id="ejercicio-91-letrero-3d-sobre-entidad-facil">Ejercicio 9.1 ‚Äî Letrero 3D sobre Entidad <span class="badge easy">‚≠ê F√°cil</span></h3>
<p>Cre√° una entidad (SENT) que muestre un texto 3D flotante sobre ella, legible desde cualquier √°ngulo (que siempre mire al jugador). El texto debe ser configurable v√≠a <code>SetupDataTables</code>.</p>

<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- shared.lua</span>
<span class="nv">ENT</span><span class="p">.</span><span class="py">Type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;anim&quot;</span>
<span class="nv">ENT</span><span class="p">.</span><span class="py">Base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;base_gmodentity&quot;</span>
<span class="nv">ENT</span><span class="p">.</span><span class="py">PrintName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Letrero 3D&quot;</span>
<span class="nv">ENT</span><span class="p">.</span><span class="py">Spawnable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">ENT</span><span class="p">:</span><span class="nf">SetupDataTables</span><span class="p">()</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">NetworkVar</span><span class="p">(</span><span class="s2">&quot;String&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Texto&quot;</span><span class="p">)</span>
<span class="kr">end</span>

<span class="c1">-- init.lua (SERVER)</span>
<span class="nf">AddCSLuaFile</span><span class="p">(</span><span class="s2">&quot;shared.lua&quot;</span><span class="p">)</span>
<span class="nf">AddCSLuaFile</span><span class="p">(</span><span class="s2">&quot;cl_init.lua&quot;</span><span class="p">)</span>
<span class="nf">include</span><span class="p">(</span><span class="s2">&quot;shared.lua&quot;</span><span class="p">)</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">ENT</span><span class="p">:</span><span class="nf">Initialize</span><span class="p">()</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">SetModel</span><span class="p">(</span><span class="s2">&quot;models/props_junk/wood_crate001a_chunk09.mdl&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">PhysicsInit</span><span class="p">(</span><span class="nv">SOLID_VPHYSICS</span><span class="p">)</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">SetMoveType</span><span class="p">(</span><span class="nv">MOVETYPE_VPHYSICS</span><span class="p">)</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">SetSolid</span><span class="p">(</span><span class="nv">SOLID_VPHYSICS</span><span class="p">)</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">SetTexto</span><span class="p">(</span><span class="s2">&quot;Mi Letrero&quot;</span><span class="p">)</span>
<span class="kr">end</span>

<span class="c1">-- cl_init.lua (CLIENT)</span>
<span class="nf">include</span><span class="p">(</span><span class="s2">&quot;shared.lua&quot;</span><span class="p">)</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">ENT</span><span class="p">:</span><span class="nf">Draw</span><span class="p">()</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">DrawModel</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">self</span><span class="p">:</span><span class="nf">GetPos</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">Vector</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">)</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">ang</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Angle</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nf">LocalPlayer</span><span class="p">():</span><span class="nf">EyeAngles</span><span class="p">().</span><span class="nv">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">90</span><span class="p">,</span><span class="w"> </span><span class="mi">90</span><span class="p">)</span>
<span class="w">    </span><span class="nv">cam</span><span class="p">.</span><span class="nf">Start3D2D</span><span class="p">(</span><span class="nv">pos</span><span class="p">,</span><span class="w"> </span><span class="nv">ang</span><span class="p">,</span><span class="w"> </span><span class="mf">0.12</span><span class="p">)</span>
<span class="w">        </span><span class="nv">draw</span><span class="p">.</span><span class="nf">RoundedBox</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">120</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">240</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">200</span><span class="p">))</span>
<span class="w">        </span><span class="nv">draw</span><span class="p">.</span><span class="nf">SimpleText</span><span class="p">(</span><span class="nv">self</span><span class="p">:</span><span class="nf">GetTexto</span><span class="p">(),</span><span class="w"> </span><span class="s2">&quot;DermaLarge&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">            </span><span class="nv">color_white</span><span class="p">,</span><span class="w"> </span><span class="nv">TEXT_ALIGN_CENTER</span><span class="p">,</span><span class="w"> </span><span class="nv">TEXT_ALIGN_CENTER</span><span class="p">)</span>
<span class="w">    </span><span class="nv">cam</span><span class="p">.</span><span class="nf">End3D2D</span><span class="p">()</span>
<span class="kr">end</span>
</pre></div>
</pre></div>

</div>
</details>
<h3 id="ejercicio-92-panel-3d-interactivo-avanzado">Ejercicio 9.2 ‚Äî Panel 3D Interactivo <span class="badge advanced">‚≠ê‚≠ê‚≠ê Avanzado</span></h3>
<p>Cre√° un SENT que renderice un "panel" en 3D2D mostrando:
- Una barra de progreso que se llena con el tiempo.
- Texto con el porcentaje actual.
- Un borde que cambia de color seg√∫n el progreso.
- Que sea visible solo a menos de 500 unidades.
- Bonus: que el brillo del texto pulse suavemente.</p>
<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- shared.lua</span>
<span class="nv">ENT</span><span class="p">.</span><span class="py">Type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;anim&quot;</span>
<span class="nv">ENT</span><span class="p">.</span><span class="py">Base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;base_gmodentity&quot;</span>
<span class="nv">ENT</span><span class="p">.</span><span class="py">PrintName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Panel 3D&quot;</span>
<span class="nv">ENT</span><span class="p">.</span><span class="py">Spawnable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">ENT</span><span class="p">:</span><span class="nf">SetupDataTables</span><span class="p">()</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">NetworkVar</span><span class="p">(</span><span class="s2">&quot;Float&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Progreso&quot;</span><span class="p">)</span>
<span class="kr">end</span>

<span class="c1">-- init.lua (SERVER)</span>
<span class="kr">function</span><span class="w"> </span><span class="nc">ENT</span><span class="p">:</span><span class="nf">Initialize</span><span class="p">()</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">SetModel</span><span class="p">(</span><span class="s2">&quot;models/props_lab/monitor02.mdl&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">PhysicsInit</span><span class="p">(</span><span class="nv">SOLID_VPHYSICS</span><span class="p">)</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">SetProgreso</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="kr">end</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">ENT</span><span class="p">:</span><span class="nf">Think</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">self</span><span class="p">:</span><span class="nf">GetProgreso</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">FrameTime</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">SetProgreso</span><span class="p">(</span><span class="nv">p</span><span class="p">)</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">NextThink</span><span class="p">(</span><span class="nf">CurTime</span><span class="p">())</span>
<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="kc">true</span>
<span class="kr">end</span>

<span class="c1">-- cl_init.lua (CLIENT)</span>
<span class="kr">function</span><span class="w"> </span><span class="nc">ENT</span><span class="p">:</span><span class="nf">Draw</span><span class="p">()</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">DrawModel</span><span class="p">()</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nf">LocalPlayer</span><span class="p">():</span><span class="nf">GetPos</span><span class="p">():</span><span class="nf">Distance</span><span class="p">(</span><span class="nv">self</span><span class="p">:</span><span class="nf">GetPos</span><span class="p">())</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">500</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">self</span><span class="p">:</span><span class="nf">GetPos</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">self</span><span class="p">:</span><span class="nf">GetUp</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">25</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">ang</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">self</span><span class="p">:</span><span class="nf">GetAngles</span><span class="p">()</span>
<span class="w">    </span><span class="nv">ang</span><span class="p">:</span><span class="nf">RotateAroundAxis</span><span class="p">(</span><span class="nv">ang</span><span class="p">:</span><span class="nf">Up</span><span class="p">(),</span><span class="w"> </span><span class="mi">90</span><span class="p">)</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">prog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">self</span><span class="p">:</span><span class="nf">GetProgreso</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">100</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">pulse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">180</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">math.sin</span><span class="p">(</span><span class="nf">CurTime</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">75</span>

<span class="w">    </span><span class="nv">cam</span><span class="p">.</span><span class="nf">Start3D2D</span><span class="p">(</span><span class="nv">pos</span><span class="p">,</span><span class="w"> </span><span class="nv">ang</span><span class="p">,</span><span class="w"> </span><span class="mf">0.08</span><span class="p">)</span>
<span class="w">        </span><span class="nv">draw</span><span class="p">.</span><span class="nf">RoundedBox</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">60</span><span class="p">,</span><span class="w"> </span><span class="mi">400</span><span class="p">,</span><span class="w"> </span><span class="mi">120</span><span class="p">,</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">230</span><span class="p">))</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">bc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">255</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="nv">prog</span><span class="p">),</span><span class="w"> </span><span class="mi">255</span><span class="o">*</span><span class="nv">prog</span><span class="p">,</span><span class="w"> </span><span class="mi">80</span><span class="p">)</span>
<span class="w">        </span><span class="nv">surface</span><span class="p">.</span><span class="nf">SetDrawColor</span><span class="p">(</span><span class="nv">bc</span><span class="p">)</span>
<span class="w">        </span><span class="nv">surface</span><span class="p">.</span><span class="nf">DrawOutlinedRect</span><span class="p">(</span><span class="o">-</span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">60</span><span class="p">,</span><span class="w"> </span><span class="mi">400</span><span class="p">,</span><span class="w"> </span><span class="mi">120</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">        </span><span class="nv">draw</span><span class="p">.</span><span class="nf">RoundedBox</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">180</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">360</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="mi">33</span><span class="p">,</span><span class="mi">45</span><span class="p">))</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">prog</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="nv">draw</span><span class="p">.</span><span class="nf">RoundedBox</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">180</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">360</span><span class="o">*</span><span class="nv">prog</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="nv">bc</span><span class="p">)</span><span class="w"> </span><span class="kr">end</span>
<span class="w">        </span><span class="nv">draw</span><span class="p">.</span><span class="nf">SimpleText</span><span class="p">(</span><span class="nb">math.floor</span><span class="p">(</span><span class="nv">self</span><span class="p">:</span><span class="nf">GetProgreso</span><span class="p">())</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;%&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;DermaLarge&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">35</span><span class="p">,</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="nv">pulse</span><span class="p">),</span><span class="w"> </span><span class="nv">TEXT_ALIGN_CENTER</span><span class="p">,</span><span class="w"> </span><span class="nv">TEXT_ALIGN_CENTER</span><span class="p">)</span>
<span class="w">    </span><span class="nv">cam</span><span class="p">.</span><span class="nf">End3D2D</span><span class="p">()</span>
<span class="kr">end</span>
</pre></div>
</pre></div>

</div>
</details>

<hr />
<h2 id="10-sweps-armas-scripteadas"><span class="num">10</span> SWEPs (Armas Scripteadas)</h2>
<h3 id="ejercicio-101-arma-de-gravedad-simple-intermedio">Ejercicio 10.1 ‚Äî Arma de Gravedad Simple <span class="badge medium">‚≠ê‚≠ê Intermedio</span></h3>
<p>Cre√° una SWEP que:
- <strong>Click izquierdo:</strong> Si no ten√©s una entidad agarrada, agarra la entidad que est√°s mirando (si est√° a menos de 300u). Si ya ten√©s una, soltala.
- <strong>Click derecho:</strong> Lanz√° la entidad agarrada hacia adelante con fuerza.
- La entidad agarrada debe seguir la posici√≥n frente al jugador (a 200u de distancia).
- Mostr√° en el HUD del arma "Agarrando: [clase]" o "Vac√≠o".</p>
<p><strong>Pista:</strong> Guard√° una referencia a la entidad, us√° <code>SetPos</code> o <code>PhysObj:SetVelocity</code> en <code>Think</code>.</p>

<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="nv">SWEP</span><span class="p">.</span><span class="py">PrintName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Gravity Lite&quot;</span>
<span class="nv">SWEP</span><span class="p">.</span><span class="py">Spawnable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="nv">SWEP</span><span class="p">.</span><span class="py">ViewModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;models/weapons/c_pistol.mdl&quot;</span>
<span class="nv">SWEP</span><span class="p">.</span><span class="py">WorldModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;models/weapons/w_pistol.mdl&quot;</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">SWEP</span><span class="p">:</span><span class="nf">SetupDataTables</span><span class="p">()</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">NetworkVar</span><span class="p">(</span><span class="s2">&quot;Entity&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;HeldEnt&quot;</span><span class="p">)</span>
<span class="kr">end</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">SWEP</span><span class="p">:</span><span class="nf">PrimaryAttack</span><span class="p">()</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">SetNextPrimaryFire</span><span class="p">(</span><span class="nf">CurTime</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.3</span><span class="p">)</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">CLIENT</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">held</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">self</span><span class="p">:</span><span class="nf">GetHeldEnt</span><span class="p">()</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nf">IsValid</span><span class="p">(</span><span class="nv">held</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">ph</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">held</span><span class="p">:</span><span class="nf">GetPhysicsObject</span><span class="p">()</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nf">IsValid</span><span class="p">(</span><span class="nv">ph</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="nv">ph</span><span class="p">:</span><span class="nf">EnableMotion</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="kr">end</span>
<span class="w">        </span><span class="nv">self</span><span class="p">:</span><span class="nf">SetHeldEnt</span><span class="p">(</span><span class="nv">NULL</span><span class="p">)</span>
<span class="w">    </span><span class="kr">else</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">tr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">self</span><span class="p">:</span><span class="nf">GetOwner</span><span class="p">():</span><span class="nf">GetEyeTrace</span><span class="p">()</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nf">IsValid</span><span class="p">(</span><span class="nv">tr</span><span class="p">.</span><span class="py">Entity</span><span class="p">)</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">tr</span><span class="p">.</span><span class="py">Entity</span><span class="p">:</span><span class="nf">IsPlayer</span><span class="p">()</span>
<span class="w">           </span><span class="ow">and</span><span class="w"> </span><span class="nv">self</span><span class="p">:</span><span class="nf">GetOwner</span><span class="p">():</span><span class="nf">GetPos</span><span class="p">():</span><span class="nf">Distance</span><span class="p">(</span><span class="nv">tr</span><span class="p">.</span><span class="py">Entity</span><span class="p">:</span><span class="nf">GetPos</span><span class="p">())</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">300</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="nv">self</span><span class="p">:</span><span class="nf">SetHeldEnt</span><span class="p">(</span><span class="nv">tr</span><span class="p">.</span><span class="py">Entity</span><span class="p">)</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">end</span>
<span class="kr">end</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">SWEP</span><span class="p">:</span><span class="nf">SecondaryAttack</span><span class="p">()</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">SetNextSecondaryFire</span><span class="p">(</span><span class="nf">CurTime</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.5</span><span class="p">)</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">CLIENT</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">held</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">self</span><span class="p">:</span><span class="nf">GetHeldEnt</span><span class="p">()</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nf">IsValid</span><span class="p">(</span><span class="nv">held</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">ph</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">held</span><span class="p">:</span><span class="nf">GetPhysicsObject</span><span class="p">()</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nf">IsValid</span><span class="p">(</span><span class="nv">ph</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="nv">ph</span><span class="p">:</span><span class="nf">EnableMotion</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">        </span><span class="nv">ph</span><span class="p">:</span><span class="nf">SetVelocity</span><span class="p">(</span><span class="nv">self</span><span class="p">:</span><span class="nf">GetOwner</span><span class="p">():</span><span class="nf">GetAimVector</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2000</span><span class="p">)</span>
<span class="w">    </span><span class="kr">end</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">SetHeldEnt</span><span class="p">(</span><span class="nv">NULL</span><span class="p">)</span>
<span class="kr">end</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">SWEP</span><span class="p">:</span><span class="nf">Think</span><span class="p">()</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">CLIENT</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">held</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">self</span><span class="p">:</span><span class="nf">GetHeldEnt</span><span class="p">()</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nf">IsValid</span><span class="p">(</span><span class="nv">held</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">ph</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">held</span><span class="p">:</span><span class="nf">GetPhysicsObject</span><span class="p">()</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nf">IsValid</span><span class="p">(</span><span class="nv">ph</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="nv">ph</span><span class="p">:</span><span class="nf">EnableMotion</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
<span class="w">        </span><span class="nv">held</span><span class="p">:</span><span class="nf">SetPos</span><span class="p">(</span><span class="nv">self</span><span class="p">:</span><span class="nf">GetOwner</span><span class="p">():</span><span class="nf">EyePos</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">self</span><span class="p">:</span><span class="nf">GetOwner</span><span class="p">():</span><span class="nf">GetAimVector</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">200</span><span class="p">)</span>
<span class="w">    </span><span class="kr">end</span>
<span class="kr">end</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">SWEP</span><span class="p">:</span><span class="nf">DrawHUD</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">self</span><span class="p">:</span><span class="nf">GetHeldEnt</span><span class="p">()</span>
<span class="w">    </span><span class="nv">draw</span><span class="p">.</span><span class="nf">SimpleText</span><span class="p">(</span><span class="nf">IsValid</span><span class="p">(</span><span class="nv">h</span><span class="p">)</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="p">(</span><span class="s2">&quot;Agarrando: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">h</span><span class="p">:</span><span class="nf">GetClass</span><span class="p">())</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s2">&quot;Vac√≠o&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;DermaLarge&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">ScrW</span><span class="p">()</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nf">ScrH</span><span class="p">()</span><span class="o">-</span><span class="mi">80</span><span class="p">,</span><span class="w"> </span><span class="nv">color_white</span><span class="p">,</span><span class="w"> </span><span class="nv">TEXT_ALIGN_CENTER</span><span class="p">)</span>
<span class="kr">end</span>
</pre></div>
</pre></div>

</div>
</details>
<h3 id="ejercicio-102-arma-de-curacion-por-area-intermedio">Ejercicio 10.2 ‚Äî Arma de Curaci√≥n por √Årea <span class="badge medium">‚≠ê‚≠ê Intermedio</span></h3>
<p>Cre√° una SWEP que:
- <strong>Click izquierdo:</strong> Cura a todos los jugadores en un radio de 300 unidades por 15 HP, con cooldown de 2 segundos.
- <strong>Click derecho:</strong> Autocuraci√≥n de 5 HP con cooldown de 3 segundos.
- Mostr√° un efecto visual (c√≠rculo en el piso) usando <code>cam.Start3D2D</code> cuando se use.
- Sonido al curar (usa sonidos del motor como <code>"items/medshot4.wav"</code>).</p>

<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="nv">SWEP</span><span class="p">.</span><span class="py">PrintName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Curador de √Årea&quot;</span>
<span class="nv">SWEP</span><span class="p">.</span><span class="py">Spawnable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="nv">SWEP</span><span class="p">.</span><span class="py">ViewModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;models/weapons/c_medkit.mdl&quot;</span>
<span class="nv">SWEP</span><span class="p">.</span><span class="py">WorldModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;models/weapons/w_medkit.mdl&quot;</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">SWEP</span><span class="p">:</span><span class="nf">SetupDataTables</span><span class="p">()</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">NetworkVar</span><span class="p">(</span><span class="s2">&quot;Float&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;LastHeal&quot;</span><span class="p">)</span>
<span class="kr">end</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">SWEP</span><span class="p">:</span><span class="nf">PrimaryAttack</span><span class="p">()</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">SetNextPrimaryFire</span><span class="p">(</span><span class="nf">CurTime</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">CLIENT</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">ply</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">ents</span><span class="p">.</span><span class="nf">FindInSphere</span><span class="p">(</span><span class="nv">self</span><span class="p">:</span><span class="nf">GetOwner</span><span class="p">():</span><span class="nf">GetPos</span><span class="p">(),</span><span class="w"> </span><span class="mi">300</span><span class="p">))</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nf">IsValid</span><span class="p">(</span><span class="nv">ply</span><span class="p">)</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">IsPlayer</span><span class="p">()</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">Alive</span><span class="p">()</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="nv">ply</span><span class="p">:</span><span class="nf">SetHealth</span><span class="p">(</span><span class="nb">math.min</span><span class="p">(</span><span class="nv">ply</span><span class="p">:</span><span class="nf">Health</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">GetMaxHealth</span><span class="p">()))</span>
<span class="w">            </span><span class="nv">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">count</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">end</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">SetLastHeal</span><span class="p">(</span><span class="nf">CurTime</span><span class="p">())</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">GetOwner</span><span class="p">():</span><span class="nf">EmitSound</span><span class="p">(</span><span class="s2">&quot;items/medshot4.wav&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">GetOwner</span><span class="p">():</span><span class="nf">ChatPrint</span><span class="p">(</span><span class="s2">&quot;Curaste &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">count</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; jugadores&quot;</span><span class="p">)</span>
<span class="kr">end</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">SWEP</span><span class="p">:</span><span class="nf">SecondaryAttack</span><span class="p">()</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">SetNextSecondaryFire</span><span class="p">(</span><span class="nf">CurTime</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">CLIENT</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">self</span><span class="p">:</span><span class="nf">GetOwner</span><span class="p">()</span>
<span class="w">    </span><span class="nv">o</span><span class="p">:</span><span class="nf">SetHealth</span><span class="p">(</span><span class="nb">math.min</span><span class="p">(</span><span class="nv">o</span><span class="p">:</span><span class="nf">Health</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="nv">o</span><span class="p">:</span><span class="nf">GetMaxHealth</span><span class="p">()))</span>
<span class="w">    </span><span class="nv">o</span><span class="p">:</span><span class="nf">EmitSound</span><span class="p">(</span><span class="s2">&quot;items/smallmedkit1.wav&quot;</span><span class="p">)</span>
<span class="kr">end</span>
</pre></div>
</pre></div>

</div>
</details>
<h3 id="ejercicio-103-encontrar-el-bug-arma-que-no-funciona-en-multiplayer-intermedio">Ejercicio 10.3 ‚Äî Encontrar el Bug: Arma que No Funciona en Multiplayer <span class="badge medium">‚≠ê‚≠ê Intermedio</span></h3>
<p>Este arma funciona perfecto en singleplayer pero no hace nada en un server dedicado. ¬øPor qu√©?</p>
<div class="highlight"><pre><span></span><code><span class="nv">SWEP</span><span class="p">.</span><span class="py">PrintName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Pistola R√°pida&quot;</span>
<span class="nv">SWEP</span><span class="p">.</span><span class="py">Spawnable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="nv">SWEP</span><span class="p">.</span><span class="py">ViewModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;models/weapons/c_pistol.mdl&quot;</span>
<span class="nv">SWEP</span><span class="p">.</span><span class="py">WorldModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;models/weapons/w_pistol.mdl&quot;</span>
<span class="nv">SWEP</span><span class="p">.</span><span class="py">Primary</span><span class="p">.</span><span class="py">Automatic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="nv">SWEP</span><span class="p">.</span><span class="py">Primary</span><span class="p">.</span><span class="py">Ammo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;pistol&quot;</span>
<span class="nv">SWEP</span><span class="p">.</span><span class="py">Primary</span><span class="p">.</span><span class="py">ClipSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">30</span>
<span class="nv">SWEP</span><span class="p">.</span><span class="py">Primary</span><span class="p">.</span><span class="py">DefaultClip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">300</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">SWEP</span><span class="p">:</span><span class="nf">PrimaryAttack</span><span class="p">()</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">SetNextPrimaryFire</span><span class="p">(</span><span class="nf">CurTime</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.08</span><span class="p">)</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">EmitSound</span><span class="p">(</span><span class="s2">&quot;Weapon_Pistol.Single&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">ShootBullet</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mf">0.02</span><span class="p">)</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">TakePrimaryAmmo</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="kr">end</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">SWEP</span><span class="p">:</span><span class="nf">ShootBullet</span><span class="p">(</span><span class="nv">damage</span><span class="p">,</span><span class="w"> </span><span class="nv">num</span><span class="p">,</span><span class="w"> </span><span class="nv">spread</span><span class="p">)</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">bullet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
<span class="w">    </span><span class="nv">bullet</span><span class="p">.</span><span class="py">Num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">num</span>
<span class="w">    </span><span class="nv">bullet</span><span class="p">.</span><span class="py">Src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">self</span><span class="p">.</span><span class="py">Owner</span><span class="p">:</span><span class="nf">GetShootPos</span><span class="p">()</span>
<span class="w">    </span><span class="nv">bullet</span><span class="p">.</span><span class="py">Dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">self</span><span class="p">.</span><span class="py">Owner</span><span class="p">:</span><span class="nf">GetAimVector</span><span class="p">()</span>
<span class="w">    </span><span class="nv">bullet</span><span class="p">.</span><span class="py">Spread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Vector</span><span class="p">(</span><span class="nv">spread</span><span class="p">,</span><span class="w"> </span><span class="nv">spread</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="nv">bullet</span><span class="p">.</span><span class="py">Damage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">damage</span>
<span class="w">    </span><span class="nv">bullet</span><span class="p">.</span><span class="py">Force</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span>
<span class="w">    </span><span class="nv">self</span><span class="p">.</span><span class="py">Owner</span><span class="p">:</span><span class="nf">FireBullets</span><span class="p">(</span><span class="nv">bullet</span><span class="p">)</span>
<span class="kr">end</span>
</code></pre></div>

<p><strong>Pista:</strong> <code>self.Owner</code> est√° deprecated.</p>

<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<p><strong>El problema:</strong> <code>self.Owner</code> est√° <strong>deprecated</strong> y no funciona en servidores dedicados. En singleplayer funciona por compatibilidad legacy.</p>
<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- SOLUCI√ìN: Reemplazar self.Owner por self:GetOwner()</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">self</span><span class="p">:</span><span class="nf">GetOwner</span><span class="p">()</span>
<span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nf">IsValid</span><span class="p">(</span><span class="nv">owner</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>
<span class="c1">-- ... usar owner en vez de self.Owner</span>
</pre></div>
</pre></div>
<p><strong>Regla:</strong> SIEMPRE us√° <code>self:GetOwner()</code> en SWEPs.</p>

</div>
</details>
<h3 id="ejercicio-104-swep-con-modos-alternables-avanzado">Ejercicio 10.4 ‚Äî SWEP con Modos Alternables <span class="badge advanced">‚≠ê‚≠ê‚≠ê Avanzado</span></h3>
<p>Cre√° una SWEP con 3 modos que se alternan con Reload:
1. <strong>Modo Curaci√≥n</strong> ‚Äî Click izq cura al target.
2. <strong>Modo Empuje</strong> ‚Äî Click izq empuja a la entidad mirando.
3. <strong>Modo Info</strong> ‚Äî Click izq muestra informaci√≥n de la entidad en chat.</p>
<p>Us√° <code>SetupDataTables</code> para sincronizar el modo actual. Mostr√° el modo en el HUD del arma con un √≠cono/texto diferente para cada uno.</p>
<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="nv">SWEP</span><span class="p">.</span><span class="py">PrintName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Multitool&quot;</span>
<span class="nv">SWEP</span><span class="p">.</span><span class="py">Spawnable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="nv">SWEP</span><span class="p">.</span><span class="py">ViewModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;models/weapons/c_toolgun.mdl&quot;</span>
<span class="nv">SWEP</span><span class="p">.</span><span class="py">WorldModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;models/weapons/w_toolgun.mdl&quot;</span>

<span class="kd">local</span><span class="w"> </span><span class="nv">MODOS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">{</span><span class="nv">nombre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Curaci√≥n&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span><span class="mi">220</span><span class="p">,</span><span class="mi">80</span><span class="p">)},</span>
<span class="w">    </span><span class="p">{</span><span class="nv">nombre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Empuje&quot;</span><span class="p">,</span><span class="w">   </span><span class="nv">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span><span class="mi">150</span><span class="p">,</span><span class="mi">255</span><span class="p">)},</span>
<span class="w">    </span><span class="p">{</span><span class="nv">nombre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Info&quot;</span><span class="p">,</span><span class="w">     </span><span class="nv">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">50</span><span class="p">)},</span>
<span class="p">}</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">SWEP</span><span class="p">:</span><span class="nf">SetupDataTables</span><span class="p">()</span><span class="w"> </span><span class="nv">self</span><span class="p">:</span><span class="nf">NetworkVar</span><span class="p">(</span><span class="s2">&quot;Int&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Modo&quot;</span><span class="p">)</span><span class="w"> </span><span class="kr">end</span>
<span class="kr">function</span><span class="w"> </span><span class="nc">SWEP</span><span class="p">:</span><span class="nf">Initialize</span><span class="p">()</span><span class="w"> </span><span class="nv">self</span><span class="p">:</span><span class="nf">SetHoldType</span><span class="p">(</span><span class="s2">&quot;pistol&quot;</span><span class="p">)</span><span class="w"> </span><span class="nv">self</span><span class="p">:</span><span class="nf">SetModo</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="kr">end</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">SWEP</span><span class="p">:</span><span class="nf">Reload</span><span class="p">()</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">self</span><span class="p">:</span><span class="nf">GetNextSecondaryFire</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nf">CurTime</span><span class="p">()</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">SetNextSecondaryFire</span><span class="p">(</span><span class="nf">CurTime</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.5</span><span class="p">)</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">SetModo</span><span class="p">((</span><span class="nv">self</span><span class="p">:</span><span class="nf">GetModo</span><span class="p">()</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="o">#</span><span class="nv">MODOS</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">SERVER</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="nv">self</span><span class="p">:</span><span class="nf">GetOwner</span><span class="p">():</span><span class="nf">ChatPrint</span><span class="p">(</span><span class="s2">&quot;Modo: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">MODOS</span><span class="p">[</span><span class="nv">self</span><span class="p">:</span><span class="nf">GetModo</span><span class="p">()].</span><span class="nv">nombre</span><span class="p">)</span><span class="w"> </span><span class="kr">end</span>
<span class="kr">end</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">SWEP</span><span class="p">:</span><span class="nf">PrimaryAttack</span><span class="p">()</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">SetNextPrimaryFire</span><span class="p">(</span><span class="nf">CurTime</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.5</span><span class="p">)</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">CLIENT</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">self</span><span class="p">:</span><span class="nf">GetOwner</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">tr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">o</span><span class="p">:</span><span class="nf">GetEyeTrace</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">self</span><span class="p">:</span><span class="nf">GetModo</span><span class="p">()</span>

<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">m</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nf">IsValid</span><span class="p">(</span><span class="nv">tr</span><span class="p">.</span><span class="py">Entity</span><span class="p">)</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">tr</span><span class="p">.</span><span class="py">Entity</span><span class="p">:</span><span class="nf">IsPlayer</span><span class="p">()</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="nv">tr</span><span class="p">.</span><span class="py">Entity</span><span class="p">:</span><span class="nf">SetHealth</span><span class="p">(</span><span class="nb">math.min</span><span class="p">(</span><span class="nv">tr</span><span class="p">.</span><span class="py">Entity</span><span class="p">:</span><span class="nf">Health</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="nv">tr</span><span class="p">.</span><span class="py">Entity</span><span class="p">:</span><span class="nf">GetMaxHealth</span><span class="p">()))</span>
<span class="w">        </span><span class="nv">o</span><span class="p">:</span><span class="nf">ChatPrint</span><span class="p">(</span><span class="s2">&quot;Curaste a &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">tr</span><span class="p">.</span><span class="py">Entity</span><span class="p">:</span><span class="nf">Nick</span><span class="p">())</span>
<span class="w">    </span><span class="kr">elseif</span><span class="w"> </span><span class="nv">m</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nf">IsValid</span><span class="p">(</span><span class="nv">tr</span><span class="p">.</span><span class="py">Entity</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">ph</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">tr</span><span class="p">.</span><span class="py">Entity</span><span class="p">:</span><span class="nf">GetPhysicsObject</span><span class="p">()</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nf">IsValid</span><span class="p">(</span><span class="nv">ph</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="nv">ph</span><span class="p">:</span><span class="nf">ApplyForceCenter</span><span class="p">(</span><span class="nv">o</span><span class="p">:</span><span class="nf">GetAimVector</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">5000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">ph</span><span class="p">:</span><span class="nf">GetMass</span><span class="p">())</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">elseif</span><span class="w"> </span><span class="nv">m</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nf">IsValid</span><span class="p">(</span><span class="nv">tr</span><span class="p">.</span><span class="py">Entity</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="nv">o</span><span class="p">:</span><span class="nf">ChatPrint</span><span class="p">(</span><span class="s2">&quot;Clase: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">tr</span><span class="p">.</span><span class="py">Entity</span><span class="p">:</span><span class="nf">GetClass</span><span class="p">()</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; | HP: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">tr</span><span class="p">.</span><span class="py">Entity</span><span class="p">:</span><span class="nf">Health</span><span class="p">())</span>
<span class="w">    </span><span class="kr">end</span>
<span class="kr">end</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">SWEP</span><span class="p">:</span><span class="nf">DrawHUD</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">MODOS</span><span class="p">[</span><span class="nv">self</span><span class="p">:</span><span class="nf">GetModo</span><span class="p">()]</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nv">MODOS</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="w">    </span><span class="nv">draw</span><span class="p">.</span><span class="nf">RoundedBox</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="nf">ScrW</span><span class="p">()</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="mi">80</span><span class="p">,</span><span class="w"> </span><span class="nf">ScrH</span><span class="p">()</span><span class="o">-</span><span class="mi">80</span><span class="p">,</span><span class="w"> </span><span class="mi">160</span><span class="p">,</span><span class="w"> </span><span class="mi">36</span><span class="p">,</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">180</span><span class="p">))</span>
<span class="w">    </span><span class="nv">draw</span><span class="p">.</span><span class="nf">SimpleText</span><span class="p">(</span><span class="nv">m</span><span class="p">.</span><span class="py">nombre</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;DermaDefaultBold&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">ScrW</span><span class="p">()</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nf">ScrH</span><span class="p">()</span><span class="o">-</span><span class="mi">62</span><span class="p">,</span>
<span class="w">        </span><span class="nv">m</span><span class="p">.</span><span class="py">color</span><span class="p">,</span><span class="w"> </span><span class="nv">TEXT_ALIGN_CENTER</span><span class="p">,</span><span class="w"> </span><span class="nv">TEXT_ALIGN_CENTER</span><span class="p">)</span>
<span class="kr">end</span>
</pre></div>
</pre></div>

</div>
</details>

<hr />
<h2 id="11-sents-entidades-scripteadas"><span class="num">11</span> SENTs (Entidades Scripteadas)</h2>
<h3 id="ejercicio-111-trampa-explosiva-intermedio">Ejercicio 11.1 ‚Äî Trampa Explosiva <span class="badge medium">‚≠ê‚≠ê Intermedio</span></h3>
<p>Cre√° un SENT que:
- Se activa 3 segundos despu√©s de ser spawneado.
- Una vez activo, si un jugador se acerca a menos de 100 unidades, explota.
- La explosi√≥n hace 50 de da√±o en un radio de 200u.
- Mostr√° un texto 3D "‚ö† ARMADA" cuando est√° activa, "PREPARANDO..." cuando no.</p>
<p><strong>Objetivos:</strong> <code>ENT:Think()</code>, <code>ents.FindInSphere</code>, <code>util.BlastDamage</code>, <code>SetupDataTables</code></p>

<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- shared.lua</span>
<span class="nv">ENT</span><span class="p">.</span><span class="py">Type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;anim&quot;</span>
<span class="nv">ENT</span><span class="p">.</span><span class="py">Base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;base_gmodentity&quot;</span>
<span class="nv">ENT</span><span class="p">.</span><span class="py">PrintName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Trampa Explosiva&quot;</span>
<span class="nv">ENT</span><span class="p">.</span><span class="py">Spawnable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="kr">function</span><span class="w"> </span><span class="nc">ENT</span><span class="p">:</span><span class="nf">SetupDataTables</span><span class="p">()</span><span class="w"> </span><span class="nv">self</span><span class="p">:</span><span class="nf">NetworkVar</span><span class="p">(</span><span class="s2">&quot;Bool&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Armed&quot;</span><span class="p">)</span><span class="w"> </span><span class="kr">end</span>

<span class="c1">-- init.lua (SERVER)</span>
<span class="kr">function</span><span class="w"> </span><span class="nc">ENT</span><span class="p">:</span><span class="nf">Initialize</span><span class="p">()</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">SetModel</span><span class="p">(</span><span class="s2">&quot;models/props_junk/cardboard_box003a.mdl&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">PhysicsInit</span><span class="p">(</span><span class="nv">SOLID_VPHYSICS</span><span class="p">)</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">SetMoveType</span><span class="p">(</span><span class="nv">MOVETYPE_VPHYSICS</span><span class="p">)</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">SetSolid</span><span class="p">(</span><span class="nv">SOLID_VPHYSICS</span><span class="p">)</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">SetArmed</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
<span class="w">    </span><span class="nv">timer</span><span class="p">.</span><span class="nf">Simple</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span><span class="nf">IsValid</span><span class="p">(</span><span class="nv">self</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="nv">self</span><span class="p">:</span><span class="nf">SetArmed</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="kr">end</span><span class="w"> </span><span class="kr">end</span><span class="p">)</span>
<span class="kr">end</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">ENT</span><span class="p">:</span><span class="nf">Think</span><span class="p">()</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">self</span><span class="p">:</span><span class="nf">GetArmed</span><span class="p">()</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">ply</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">ents</span><span class="p">.</span><span class="nf">FindInSphere</span><span class="p">(</span><span class="nv">self</span><span class="p">:</span><span class="nf">GetPos</span><span class="p">(),</span><span class="w"> </span><span class="mi">100</span><span class="p">))</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nf">IsValid</span><span class="p">(</span><span class="nv">ply</span><span class="p">)</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">IsPlayer</span><span class="p">()</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">Alive</span><span class="p">()</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="kd">local</span><span class="w"> </span><span class="nv">ed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">EffectData</span><span class="p">()</span>
<span class="w">            </span><span class="nv">ed</span><span class="p">:</span><span class="nf">SetOrigin</span><span class="p">(</span><span class="nv">self</span><span class="p">:</span><span class="nf">GetPos</span><span class="p">())</span>
<span class="w">            </span><span class="nv">util</span><span class="p">.</span><span class="nf">Effect</span><span class="p">(</span><span class="s2">&quot;Explosion&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">ed</span><span class="p">)</span>
<span class="w">            </span><span class="nv">util</span><span class="p">.</span><span class="nf">BlastDamage</span><span class="p">(</span><span class="nv">self</span><span class="p">,</span><span class="w"> </span><span class="nv">self</span><span class="p">,</span><span class="w"> </span><span class="nv">self</span><span class="p">:</span><span class="nf">GetPos</span><span class="p">(),</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">)</span>
<span class="w">            </span><span class="nv">self</span><span class="p">:</span><span class="nf">Remove</span><span class="p">()</span>
<span class="w">            </span><span class="kr">return</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">end</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">NextThink</span><span class="p">(</span><span class="nf">CurTime</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.1</span><span class="p">)</span>
<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="kc">true</span>
<span class="kr">end</span>

<span class="c1">-- cl_init.lua (CLIENT)</span>
<span class="kr">function</span><span class="w"> </span><span class="nc">ENT</span><span class="p">:</span><span class="nf">Draw</span><span class="p">()</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">DrawModel</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">ang</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Angle</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nf">LocalPlayer</span><span class="p">():</span><span class="nf">EyeAngles</span><span class="p">().</span><span class="nv">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">90</span><span class="p">,</span><span class="w"> </span><span class="mi">90</span><span class="p">)</span>
<span class="w">    </span><span class="nv">cam</span><span class="p">.</span><span class="nf">Start3D2D</span><span class="p">(</span><span class="nv">self</span><span class="p">:</span><span class="nf">GetPos</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">Vector</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">25</span><span class="p">),</span><span class="w"> </span><span class="nv">ang</span><span class="p">,</span><span class="w"> </span><span class="mf">0.1</span><span class="p">)</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">self</span><span class="p">:</span><span class="nf">GetArmed</span><span class="p">()</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="nv">draw</span><span class="p">.</span><span class="nf">SimpleText</span><span class="p">(</span><span class="s2">&quot;ARMADA&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;DermaLarge&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">60</span><span class="p">,</span><span class="mi">60</span><span class="p">),</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="kr">else</span>
<span class="w">            </span><span class="nv">draw</span><span class="p">.</span><span class="nf">SimpleText</span><span class="p">(</span><span class="s2">&quot;PREPARANDO...&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;DermaDefault&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">50</span><span class="p">),</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">    </span><span class="nv">cam</span><span class="p">.</span><span class="nf">End3D2D</span><span class="p">()</span>
<span class="kr">end</span>
</pre></div>
</pre></div>

</div>
</details>
<h3 id="ejercicio-112-maquina-expendedora-avanzado">Ejercicio 11.2 ‚Äî M√°quina Expendedora <span class="badge advanced">‚≠ê‚≠ê‚≠ê Avanzado</span></h3>
<p>Cre√° un SENT que funcione como m√°quina expendedora:
- Presionar E abre un men√∫ VGUI en el cliente con una lista de productos.
- Los productos tienen nombre, precio, y efecto (curar, dar armadura, dar arma).
- El servidor valida la compra (dinero, disponibilidad).
- Mostr√° un texto 3D con "M√°quina Expendedora ‚Äî Presion√° E" flotando encima.
- Bonus: stock limitado que se muestra en el men√∫.</p>

<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- === SENT: M√°quina Expendedora ===</span>
<span class="c1">-- shared.lua</span>
<span class="nv">ENT</span><span class="p">.</span><span class="py">Type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;anim&quot;</span>
<span class="nv">ENT</span><span class="p">.</span><span class="py">Base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;base_gmodentity&quot;</span>
<span class="nv">ENT</span><span class="p">.</span><span class="py">PrintName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;M√°quina Expendedora&quot;</span>
<span class="nv">ENT</span><span class="p">.</span><span class="py">Spawnable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>

<span class="c1">-- init.lua (SERVER)</span>
<span class="nv">util</span><span class="p">.</span><span class="nf">AddNetworkString</span><span class="p">(</span><span class="s2">&quot;Vending_Open&quot;</span><span class="p">)</span>
<span class="nv">util</span><span class="p">.</span><span class="nf">AddNetworkString</span><span class="p">(</span><span class="s2">&quot;Vending_Buy&quot;</span><span class="p">)</span>

<span class="nv">ENT</span><span class="p">.</span><span class="py">Products</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">{</span><span class="nv">id</span><span class="o">=</span><span class="s2">&quot;medkit&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">nombre</span><span class="o">=</span><span class="s2">&quot;Kit M√©dico&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">precio</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="nv">efecto</span><span class="o">=</span><span class="s2">&quot;heal25&quot;</span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="nv">id</span><span class="o">=</span><span class="s2">&quot;armor&quot;</span><span class="p">,</span><span class="w">  </span><span class="nv">nombre</span><span class="o">=</span><span class="s2">&quot;Armadura&quot;</span><span class="p">,</span><span class="w">   </span><span class="nv">precio</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span><span class="w"> </span><span class="nv">efecto</span><span class="o">=</span><span class="s2">&quot;armor50&quot;</span><span class="p">},</span>
<span class="p">}</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">ENT</span><span class="p">:</span><span class="nf">Initialize</span><span class="p">()</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">SetModel</span><span class="p">(</span><span class="s2">&quot;models/props_interiors/VendingMachineSoda01a.mdl&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">PhysicsInit</span><span class="p">(</span><span class="nv">SOLID_VPHYSICS</span><span class="p">)</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">SetUseType</span><span class="p">(</span><span class="nv">SIMPLE_USE</span><span class="p">)</span>
<span class="kr">end</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">ENT</span><span class="p">:</span><span class="nf">Use</span><span class="p">(</span><span class="nv">activator</span><span class="p">)</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">activator</span><span class="p">:</span><span class="nf">IsPlayer</span><span class="p">()</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="nv">net</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="s2">&quot;Vending_Open&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nv">net</span><span class="p">.</span><span class="nf">WriteEntity</span><span class="p">(</span><span class="nv">self</span><span class="p">)</span>
<span class="w">        </span><span class="nv">net</span><span class="p">.</span><span class="nf">WriteTable</span><span class="p">(</span><span class="nv">self</span><span class="p">.</span><span class="py">Products</span><span class="p">)</span>
<span class="w">    </span><span class="nv">net</span><span class="p">.</span><span class="nf">Send</span><span class="p">(</span><span class="nv">activator</span><span class="p">)</span>
<span class="kr">end</span>

<span class="nv">net</span><span class="p">.</span><span class="nf">Receive</span><span class="p">(</span><span class="s2">&quot;Vending_Buy&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">len</span><span class="p">,</span><span class="w"> </span><span class="nv">ply</span><span class="p">)</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">ent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">net</span><span class="p">.</span><span class="nf">ReadEntity</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">productId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">net</span><span class="p">.</span><span class="nf">ReadString</span><span class="p">()</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nf">IsValid</span><span class="p">(</span><span class="nv">ent</span><span class="p">)</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">GetPos</span><span class="p">():</span><span class="nf">Distance</span><span class="p">(</span><span class="nv">ent</span><span class="p">:</span><span class="nf">GetPos</span><span class="p">())</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="c1">-- Encontrar producto y aplicar efecto (validar dinero aqu√≠)</span>
<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">ent</span><span class="p">.</span><span class="py">Products</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">p</span><span class="p">.</span><span class="py">id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">productId</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="kr">if</span><span class="w"> </span><span class="nv">p</span><span class="p">.</span><span class="py">efecto</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;heal25&quot;</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">SetHealth</span><span class="p">(</span><span class="nb">math.min</span><span class="p">(</span><span class="nv">ply</span><span class="p">:</span><span class="nf">Health</span><span class="p">()</span><span class="o">+</span><span class="mi">25</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">))</span><span class="w"> </span><span class="kr">end</span>
<span class="w">            </span><span class="kr">if</span><span class="w"> </span><span class="nv">p</span><span class="p">.</span><span class="py">efecto</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;armor50&quot;</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">SetArmor</span><span class="p">(</span><span class="nb">math.min</span><span class="p">(</span><span class="nv">ply</span><span class="p">:</span><span class="nf">Armor</span><span class="p">()</span><span class="o">+</span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">))</span><span class="w"> </span><span class="kr">end</span>
<span class="w">            </span><span class="nv">ply</span><span class="p">:</span><span class="nf">ChatPrint</span><span class="p">(</span><span class="s2">&quot;Compraste &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">p</span><span class="p">.</span><span class="py">nombre</span><span class="p">)</span>
<span class="w">            </span><span class="kr">return</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">end</span>
<span class="kr">end</span><span class="p">)</span>

<span class="c1">-- cl_init.lua (CLIENT)</span>
<span class="nv">net</span><span class="p">.</span><span class="nf">Receive</span><span class="p">(</span><span class="s2">&quot;Vending_Open&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">ent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">net</span><span class="p">.</span><span class="nf">ReadEntity</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">products</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">net</span><span class="p">.</span><span class="nf">ReadTable</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DFrame&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">f</span><span class="p">:</span><span class="nf">SetSize</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span><span class="w"> </span><span class="mi">250</span><span class="p">)</span>
<span class="w">    </span><span class="nv">f</span><span class="p">:</span><span class="nf">Center</span><span class="p">()</span>
<span class="w">    </span><span class="nv">f</span><span class="p">:</span><span class="nf">SetTitle</span><span class="p">(</span><span class="s2">&quot;M√°quina Expendedora&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">f</span><span class="p">:</span><span class="nf">MakePopup</span><span class="p">()</span>
<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">products</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DButton&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">f</span><span class="p">)</span>
<span class="w">        </span><span class="nv">b</span><span class="p">:</span><span class="nf">Dock</span><span class="p">(</span><span class="nv">TOP</span><span class="p">)</span>
<span class="w">        </span><span class="nv">b</span><span class="p">:</span><span class="nf">SetTall</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span>
<span class="w">        </span><span class="nv">b</span><span class="p">:</span><span class="nf">DockMargin</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="nv">b</span><span class="p">:</span><span class="nf">SetText</span><span class="p">(</span><span class="nv">p</span><span class="p">.</span><span class="py">nombre</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; - $&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">p</span><span class="p">.</span><span class="py">precio</span><span class="p">)</span>
<span class="w">        </span><span class="nv">b</span><span class="p">.</span><span class="py">DoClick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span>
<span class="w">            </span><span class="nv">net</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="s2">&quot;Vending_Buy&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="nv">net</span><span class="p">.</span><span class="nf">WriteEntity</span><span class="p">(</span><span class="nv">ent</span><span class="p">)</span>
<span class="w">                </span><span class="nv">net</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="nv">p</span><span class="p">.</span><span class="py">id</span><span class="p">)</span>
<span class="w">            </span><span class="nv">net</span><span class="p">.</span><span class="nf">SendToServer</span><span class="p">()</span>
<span class="w">            </span><span class="nv">f</span><span class="p">:</span><span class="nf">Close</span><span class="p">()</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">end</span>
<span class="kr">end</span><span class="p">)</span>
</pre></div>
</pre></div>

</div>
</details>
<h3 id="ejercicio-113-checkpoint-persistente-intermedio">Ejercicio 11.3 ‚Äî Checkpoint Persistente <span class="badge medium">‚≠ê‚≠ê Intermedio</span></h3>
<p>Cre√° un SENT que sirva como checkpoint:
- Cuando un jugador pasa por encima, se guarda su posici√≥n (server-side, asociada a SteamID).
- Cuando el jugador muere, respawnea en su √∫ltimo checkpoint en vez del spawn normal.
- Mostr√° un efecto visual diferente si el jugador ya activ√≥ ese checkpoint o no.</p>
<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- SERVER</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">checkpoints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w">  </span><span class="c1">-- [SteamID64] = Vector pos</span>

<span class="nv">ENT</span><span class="p">.</span><span class="py">Type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;anim&quot;</span>
<span class="nv">ENT</span><span class="p">.</span><span class="py">Base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;base_gmodentity&quot;</span>
<span class="nv">ENT</span><span class="p">.</span><span class="py">PrintName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Checkpoint&quot;</span>
<span class="nv">ENT</span><span class="p">.</span><span class="py">Spawnable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">ENT</span><span class="p">:</span><span class="nf">SetupDataTables</span><span class="p">()</span><span class="w"> </span><span class="nv">self</span><span class="p">:</span><span class="nf">NetworkVar</span><span class="p">(</span><span class="s2">&quot;Bool&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Activated&quot;</span><span class="p">)</span><span class="w"> </span><span class="kr">end</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">ENT</span><span class="p">:</span><span class="nf">Initialize</span><span class="p">()</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">SetModel</span><span class="p">(</span><span class="s2">&quot;models/props_trainstation/trainstation_column001.mdl&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">PhysicsInit</span><span class="p">(</span><span class="nv">SOLID_VPHYSICS</span><span class="p">)</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">SetTrigger</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="kr">end</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">ENT</span><span class="p">:</span><span class="nf">Touch</span><span class="p">(</span><span class="nv">ent</span><span class="p">)</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">ent</span><span class="p">:</span><span class="nf">IsPlayer</span><span class="p">()</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">ent</span><span class="p">:</span><span class="nf">Alive</span><span class="p">()</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">sid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ent</span><span class="p">:</span><span class="nf">SteamID64</span><span class="p">()</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">checkpoints</span><span class="p">[</span><span class="nv">sid</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">self</span><span class="p">:</span><span class="nf">GetPos</span><span class="p">()</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span><span class="w"> </span><span class="c1">-- Ya activado</span>
<span class="w">    </span><span class="nv">checkpoints</span><span class="p">[</span><span class="nv">sid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">self</span><span class="p">:</span><span class="nf">GetPos</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">Vector</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="nv">ent</span><span class="p">:</span><span class="nf">ChatPrint</span><span class="p">(</span><span class="s2">&quot;Checkpoint activado!&quot;</span><span class="p">)</span>
<span class="kr">end</span>

<span class="c1">-- Respawnear en checkpoint</span>
<span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;PlayerSpawn&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Checkpoint_Spawn&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">ply</span><span class="p">)</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">sid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">SteamID64</span><span class="p">()</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">checkpoints</span><span class="p">[</span><span class="nv">sid</span><span class="p">]</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="nv">timer</span><span class="p">.</span><span class="nf">Simple</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nf">IsValid</span><span class="p">(</span><span class="nv">ply</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">SetPos</span><span class="p">(</span><span class="nv">checkpoints</span><span class="p">[</span><span class="nv">sid</span><span class="p">])</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">end</span><span class="p">)</span>
<span class="kr">end</span><span class="p">)</span>
</pre></div>
</pre></div>

</div>
</details>

<hr />
<h2 id="12-seguridad-y-debugging"><span class="num">12</span> Seguridad y Debugging</h2>
<h3 id="ejercicio-121-encontrar-todas-las-vulnerabilidades-avanzado">Ejercicio 12.1 ‚Äî Encontrar Todas las Vulnerabilidades <span class="badge advanced">‚≠ê‚≠ê‚≠ê Avanzado</span></h3>
<p>Este addon tiene <strong>al menos 6 vulnerabilidades</strong>. Encontralas todas y explic√° c√≥mo explotarlas.</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- SERVER</span>
<span class="nv">util</span><span class="p">.</span><span class="nf">AddNetworkString</span><span class="p">(</span><span class="s2">&quot;Admin_Panel&quot;</span><span class="p">)</span>
<span class="nv">util</span><span class="p">.</span><span class="nf">AddNetworkString</span><span class="p">(</span><span class="s2">&quot;Admin_Accion&quot;</span><span class="p">)</span>

<span class="nv">net</span><span class="p">.</span><span class="nf">Receive</span><span class="p">(</span><span class="s2">&quot;Admin_Accion&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">len</span><span class="p">,</span><span class="w"> </span><span class="nv">ply</span><span class="p">)</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">accion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">net</span><span class="p">.</span><span class="nf">ReadString</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">target_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">net</span><span class="p">.</span><span class="nf">ReadString</span><span class="p">()</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">player</span><span class="p">.</span><span class="nf">GetAll</span><span class="p">())</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">p</span><span class="p">:</span><span class="nf">Nick</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">target_name</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="nv">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">p</span>
<span class="w">            </span><span class="kr">break</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">accion</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;kick&quot;</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="nv">target</span><span class="p">:</span><span class="nf">Kick</span><span class="p">(</span><span class="s2">&quot;Expulsado por &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">Nick</span><span class="p">())</span>
<span class="w">    </span><span class="kr">elseif</span><span class="w"> </span><span class="nv">accion</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;dinero&quot;</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">cantidad</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">net</span><span class="p">.</span><span class="nf">ReadInt</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
<span class="w">        </span><span class="nv">ply</span><span class="p">:</span><span class="nf">addMoney</span><span class="p">(</span><span class="nv">cantidad</span><span class="p">)</span>
<span class="w">    </span><span class="kr">elseif</span><span class="w"> </span><span class="nv">accion</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;god&quot;</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="nv">target</span><span class="p">:</span><span class="nf">GodEnable</span><span class="p">()</span>
<span class="w">    </span><span class="kr">elseif</span><span class="w"> </span><span class="nv">accion</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;ejecutar&quot;</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">codigo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">net</span><span class="p">.</span><span class="nf">ReadString</span><span class="p">()</span>
<span class="w">        </span><span class="nf">RunString</span><span class="p">(</span><span class="nv">codigo</span><span class="p">)</span>
<span class="w">    </span><span class="kr">end</span>
<span class="kr">end</span><span class="p">)</span>
</code></pre></div>

<p><strong>Vulnerabilidades a buscar:</strong> Falta de verificaci√≥n de admin, inyecci√≥n de c√≥digo remota, cantidad de dinero negativa/arbitraria, crash por target nil, b√∫squeda por nombre (no es √∫nico), falta de rate limiting.</p>

<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<p><strong>6 vulnerabilidades encontradas:</strong></p>
<p>1. <strong>Sin verificaci√≥n de admin</strong> ‚Äî Cualquier jugador puede ejecutar acciones.</p>
<p>2. <strong>RunString con input del cliente</strong> ‚Äî Backdoor remota total.</p>
<p>3. <strong>Cantidad de dinero arbitraria</strong> ‚Äî Puede ser negativa o gigante.</p>
<p>4. <strong>Crash por target nil</strong> ‚Äî Si el nombre no se encuentra, <code>target:Kick()</code> crashea.</p>
<p>5. <strong>B√∫squeda por nombre</strong> ‚Äî No es √∫nico, deber√≠a ser SteamID.</p>
<p>6. <strong>Sin rate limiting</strong> ‚Äî Spam de net messages.</p>
<p><strong>Versi√≥n corregida:</strong></p>
<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="kd">local</span><span class="w"> </span><span class="nv">cooldowns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>

<span class="nv">net</span><span class="p">.</span><span class="nf">Receive</span><span class="p">(</span><span class="s2">&quot;Admin_Accion&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">len</span><span class="p">,</span><span class="w"> </span><span class="nv">ply</span><span class="p">)</span>
<span class="w">    </span><span class="c1">-- 1. Verificar admin</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">IsSuperAdmin</span><span class="p">()</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>

<span class="w">    </span><span class="c1">-- 6. Rate limiting</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">sid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">SteamID64</span><span class="p">()</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">cooldowns</span><span class="p">[</span><span class="nv">sid</span><span class="p">]</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nf">CurTime</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">cooldowns</span><span class="p">[</span><span class="nv">sid</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="nv">cooldowns</span><span class="p">[</span><span class="nv">sid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">CurTime</span><span class="p">()</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">accion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">net</span><span class="p">.</span><span class="nf">ReadString</span><span class="p">()</span>
<span class="w">    </span><span class="c1">-- 5. Buscar por SteamID, no por nombre</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">targetSID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">net</span><span class="p">.</span><span class="nf">ReadString</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">player</span><span class="p">.</span><span class="nf">GetBySteamID64</span><span class="p">(</span><span class="nv">targetSID</span><span class="p">)</span>

<span class="w">    </span><span class="c1">-- 4. Verificar que target existe</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">accion</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="s2">&quot;dinero&quot;</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nf">IsValid</span><span class="p">(</span><span class="nv">target</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>

<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">accion</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;kick&quot;</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="nv">target</span><span class="p">:</span><span class="nf">Kick</span><span class="p">(</span><span class="s2">&quot;Expulsado por &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">Nick</span><span class="p">())</span>
<span class="w">    </span><span class="kr">elseif</span><span class="w"> </span><span class="nv">accion</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;dinero&quot;</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="c1">-- 3. Limitar cantidad</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">cantidad</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">math</span><span class="p">.</span><span class="nf">Clamp</span><span class="p">(</span><span class="nv">net</span><span class="p">.</span><span class="nf">ReadInt</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">10000</span><span class="p">)</span>
<span class="w">        </span><span class="nv">ply</span><span class="p">:</span><span class="nf">addMoney</span><span class="p">(</span><span class="nv">cantidad</span><span class="p">)</span>
<span class="w">    </span><span class="kr">elseif</span><span class="w"> </span><span class="nv">accion</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;god&quot;</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="nv">target</span><span class="p">:</span><span class="nf">GodEnable</span><span class="p">()</span>
<span class="w">    </span><span class="kr">end</span>
<span class="w">    </span><span class="c1">-- 2. ELIMINADO: Nunca usar RunString con input del cliente</span>
<span class="kr">end</span><span class="p">)</span>
</pre></div>
</pre></div>

</div>
</details>
<h3 id="ejercicio-122-blindar-un-net-receive-intermedio">Ejercicio 12.2 ‚Äî Blindar un Net Receive <span class="badge medium">‚≠ê‚≠ê Intermedio</span></h3>
<p>Tom√° este <code>net.Receive</code> vulnerable y reescribilo con todas las protecciones necesarias:</p>
<div class="highlight"><pre><span></span><code><span class="nv">net</span><span class="p">.</span><span class="nf">Receive</span><span class="p">(</span><span class="s2">&quot;Tienda_Comprar&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">len</span><span class="p">,</span><span class="w"> </span><span class="nv">ply</span><span class="p">)</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">net</span><span class="p">.</span><span class="nf">ReadString</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">cantidad</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">net</span><span class="p">.</span><span class="nf">ReadInt</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
<span class="w">    </span><span class="nv">ply</span><span class="p">:</span><span class="nf">addMoney</span><span class="p">(</span><span class="o">-</span><span class="nv">ITEMS</span><span class="p">[</span><span class="nv">item</span><span class="p">].</span><span class="nv">precio</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">cantidad</span><span class="p">)</span>
<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nv">cantidad</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="nv">ply</span><span class="p">:</span><span class="nf">Give</span><span class="p">(</span><span class="nv">ITEMS</span><span class="p">[</span><span class="nv">item</span><span class="p">].</span><span class="nv">arma</span><span class="p">)</span>
<span class="w">    </span><span class="kr">end</span>
<span class="w">    </span><span class="nv">ply</span><span class="p">:</span><span class="nf">ChatPrint</span><span class="p">(</span><span class="s2">&quot;Compraste &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">cantidad</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;x &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">item</span><span class="p">)</span>
<span class="kr">end</span><span class="p">)</span>
</code></pre></div>

<p>Debe incluir: verificaci√≥n de existencia del item, validaci√≥n de cantidad (positiva, m√°ximo razonable), verificaci√≥n de dinero suficiente, rate limiting, verificaci√≥n de que el jugador est√° vivo, y manejo de errores.</p>

<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="kd">local</span><span class="w"> </span><span class="nv">cooldowns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{}}</span>

<span class="nv">net</span><span class="p">.</span><span class="nf">Receive</span><span class="p">(</span><span class="s2">&quot;Tienda_Comprar&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">len</span><span class="p">,</span><span class="w"> </span><span class="nv">ply</span><span class="p">)</span>
<span class="w">    </span><span class="c1">-- Rate limiting</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">sid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">SteamID64</span><span class="p">()</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">cooldowns</span><span class="p">[</span><span class="nv">sid</span><span class="p">]</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nf">CurTime</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">cooldowns</span><span class="p">[</span><span class="nv">sid</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="nv">cooldowns</span><span class="p">[</span><span class="nv">sid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">CurTime</span><span class="p">()</span>

<span class="w">    </span><span class="c1">-- Verificar que est√° vivo</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">Alive</span><span class="p">()</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>

<span class="w">    </span><span class="c1">-- Leer y validar datos</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">net</span><span class="p">.</span><span class="nf">ReadString</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">cantidad</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">net</span><span class="p">.</span><span class="nf">ReadInt</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>

<span class="w">    </span><span class="c1">-- Verificar existencia del item</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">ITEMS</span><span class="p">[</span><span class="nv">item</span><span class="p">]</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>

<span class="w">    </span><span class="c1">-- Validar cantidad</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">cantidad</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nv">cantidad</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nv">cantidad</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>

<span class="w">    </span><span class="c1">-- Verificar dinero suficiente</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">costoTotal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ITEMS</span><span class="p">[</span><span class="nv">item</span><span class="p">].</span><span class="nv">precio</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">cantidad</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">getDarkRPVar</span><span class="p">(</span><span class="s2">&quot;money&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nv">costoTotal</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>

<span class="w">    </span><span class="c1">-- Todo validado, ejecutar</span>
<span class="w">    </span><span class="nv">ply</span><span class="p">:</span><span class="nf">addMoney</span><span class="p">(</span><span class="o">-</span><span class="nv">costoTotal</span><span class="p">)</span>
<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nv">cantidad</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="nv">ply</span><span class="p">:</span><span class="nf">Give</span><span class="p">(</span><span class="nv">ITEMS</span><span class="p">[</span><span class="nv">item</span><span class="p">].</span><span class="nv">arma</span><span class="p">)</span>
<span class="w">    </span><span class="kr">end</span>
<span class="w">    </span><span class="nv">ply</span><span class="p">:</span><span class="nf">ChatPrint</span><span class="p">(</span><span class="s2">&quot;Compraste &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">cantidad</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;x &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">item</span><span class="p">)</span>
<span class="kr">end</span><span class="p">)</span>
</pre></div>
</pre></div>

</div>
</details>
<h3 id="ejercicio-123-debug-logger-intermedio">Ejercicio 12.3 ‚Äî Debug Logger <span class="badge medium">‚≠ê‚≠ê Intermedio</span></h3>
<p>Cre√° un m√≥dulo de debug reutilizable con las siguientes funciones:
- <code>Debug.Log(modulo, mensaje)</code> ‚Äî Imprime con colores usando <code>MsgC</code>.
- <code>Debug.Warn(modulo, mensaje)</code> ‚Äî En amarillo.
- <code>Debug.Error(modulo, mensaje)</code> ‚Äî En rojo, con <code>debug.traceback()</code>.
- <code>Debug.Table(modulo, tabla)</code> ‚Äî Imprime una tabla formateada.
- ConVar <code>mi_addon_debug</code> para activar/desactivar los logs globalmente.</p>
<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- SHARED (o server-only seg√∫n necesidad)</span>
<span class="nv">Debug</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">Debug</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="p">{}</span>

<span class="nf">CreateConVar</span><span class="p">(</span><span class="s2">&quot;mi_addon_debug&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;0&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">FCVAR_REPLICATED</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Toggle debug mode&quot;</span><span class="p">)</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="nv">modulo</span><span class="p">,</span><span class="w"> </span><span class="nv">msg</span><span class="p">)</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nf">GetConVar</span><span class="p">(</span><span class="s2">&quot;mi_addon_debug&quot;</span><span class="p">):</span><span class="nf">GetBool</span><span class="p">()</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="nf">MsgC</span><span class="p">(</span><span class="nf">Color</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;[&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">modulo</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;] &quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">),</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">msg</span><span class="p">)</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="kr">end</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">Debug</span><span class="p">.</span><span class="nf">Warn</span><span class="p">(</span><span class="nv">modulo</span><span class="p">,</span><span class="w"> </span><span class="nv">msg</span><span class="p">)</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nf">GetConVar</span><span class="p">(</span><span class="s2">&quot;mi_addon_debug&quot;</span><span class="p">):</span><span class="nf">GetBool</span><span class="p">()</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="nf">MsgC</span><span class="p">(</span><span class="nf">Color</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">220</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;[WARN:&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">modulo</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;] &quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">200</span><span class="p">),</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">msg</span><span class="p">)</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="kr">end</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">Debug</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nv">modulo</span><span class="p">,</span><span class="w"> </span><span class="nv">msg</span><span class="p">)</span>
<span class="w">    </span><span class="nf">MsgC</span><span class="p">(</span><span class="nf">Color</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">60</span><span class="p">,</span><span class="w"> </span><span class="mi">60</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;[ERROR:&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">modulo</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;] &quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">180</span><span class="p">,</span><span class="mi">180</span><span class="p">),</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">msg</span><span class="p">)</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nf">MsgC</span><span class="p">(</span><span class="nf">Color</span><span class="p">(</span><span class="mi">180</span><span class="p">,</span><span class="w"> </span><span class="mi">180</span><span class="p">,</span><span class="w"> </span><span class="mi">180</span><span class="p">),</span><span class="w"> </span><span class="nb">debug.traceback</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="kr">end</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">Debug</span><span class="p">.</span><span class="nf">Table</span><span class="p">(</span><span class="nv">modulo</span><span class="p">,</span><span class="w"> </span><span class="nv">tbl</span><span class="p">)</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nf">GetConVar</span><span class="p">(</span><span class="s2">&quot;mi_addon_debug&quot;</span><span class="p">):</span><span class="nf">GetBool</span><span class="p">()</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="nf">MsgC</span><span class="p">(</span><span class="nf">Color</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;[&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">modulo</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;] Table:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nf">PrintTable</span><span class="p">(</span><span class="nv">tbl</span><span class="p">)</span>
<span class="kr">end</span>

<span class="c1">-- Uso:</span>
<span class="c1">-- Debug.Log(&quot;Tienda&quot;, &quot;Jugador compr√≥ item X&quot;)</span>
<span class="c1">-- Debug.Error(&quot;Net&quot;, &quot;Mensaje inv√°lido recibido&quot;)</span>
</pre></div>
</pre></div>

</div>
</details>

<hr />
<h2 id="13-optimizacion"><span class="num">13</span> Optimizaci√≥n</h2>
<h3 id="ejercicio-131-encontrar-los-problemas-de-performance-intermedio">Ejercicio 13.1 ‚Äî Encontrar los Problemas de Performance <span class="badge medium">‚≠ê‚≠ê Intermedio</span></h3>
<p>Este c√≥digo de HUD tiene al menos 5 problemas de rendimiento. Identificalos y reescrib√≠ el c√≥digo optimizado.</p>
<div class="highlight"><pre><span></span><code><span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;HUDPaint&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;MiHUD&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">fuente</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">surface</span><span class="p">.</span><span class="nf">CreateFont</span><span class="p">(</span><span class="s2">&quot;MiFuente&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nv">font</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Arial&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">24</span><span class="p">,</span><span class="w"> </span><span class="nv">weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">700</span><span class="p">})</span>

<span class="w">    </span><span class="nv">surface</span><span class="p">.</span><span class="nf">SetMaterial</span><span class="p">(</span><span class="nf">Material</span><span class="p">(</span><span class="s2">&quot;icon16/heart.png&quot;</span><span class="p">))</span>
<span class="w">    </span><span class="nv">surface</span><span class="p">.</span><span class="nf">SetDrawColor</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="nv">surface</span><span class="p">.</span><span class="nf">DrawTexturedRect</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="nf">ScrH</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">60</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span>

<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">ply</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">pairs</span><span class="p">(</span><span class="nv">ents</span><span class="p">.</span><span class="nf">GetAll</span><span class="p">())</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">IsPlayer</span><span class="p">()</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">ply</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="nf">LocalPlayer</span><span class="p">()</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="kd">local</span><span class="w"> </span><span class="nv">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">GetPos</span><span class="p">():</span><span class="nf">ToScreen</span><span class="p">()</span>
<span class="w">            </span><span class="nv">draw</span><span class="p">.</span><span class="nf">SimpleText</span><span class="p">(</span><span class="nv">ply</span><span class="p">:</span><span class="nf">Nick</span><span class="p">(),</span><span class="w"> </span><span class="s2">&quot;MiFuente&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">pos</span><span class="p">.</span><span class="py">x</span><span class="p">,</span><span class="w"> </span><span class="nv">pos</span><span class="p">.</span><span class="py">y</span><span class="p">,</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">))</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nf">LocalPlayer</span><span class="p">():</span><span class="nf">GetNWString</span><span class="p">(</span><span class="s2">&quot;trabajo&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;Polic√≠a&quot;</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="nv">draw</span><span class="p">.</span><span class="nf">RoundedBox</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="nf">ScrW</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span><span class="p">))</span>
<span class="w">        </span><span class="nv">draw</span><span class="p">.</span><span class="nf">SimpleText</span><span class="p">(</span><span class="s2">&quot;POLIC√çA&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;MiFuente&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">ScrW</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">25</span><span class="p">,</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">),</span><span class="w"> </span><span class="nv">TEXT_ALIGN_CENTER</span><span class="p">,</span><span class="w"> </span><span class="nv">TEXT_ALIGN_CENTER</span><span class="p">)</span>
<span class="w">    </span><span class="kr">end</span>
<span class="kr">end</span><span class="p">)</span>
</code></pre></div>


<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<p><strong>5 problemas identificados:</strong></p>
<p>1. <code>surface.CreateFont</code> dentro de HUDPaint (debe ir fuera, se ejecuta solo una vez).</p>
<p>2. <code>Material()</code> sin cachear (crear fuera del hook).</p>
<p>3. <code>ents.GetAll()</code> cuando solo necesit√°s jugadores (usar <code>player.GetAll()</code>).</p>
<p>4. <code>pairs</code> en vez de <code>ipairs</code> para tablas secuenciales.</p>
<p>5. <code>Color()</code> creado cada frame (cachear fuera del hook).</p>
<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- OPTIMIZADO</span>
<span class="nv">surface</span><span class="p">.</span><span class="nf">CreateFont</span><span class="p">(</span><span class="s2">&quot;MiFuente&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nv">font</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Arial&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">24</span><span class="p">,</span><span class="w"> </span><span class="nv">weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">700</span><span class="p">})</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">matHeart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Material</span><span class="p">(</span><span class="s2">&quot;icon16/heart.png&quot;</span><span class="p">)</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">colWhite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">)</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">colBlue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span><span class="p">)</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">cachedJob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">jobUpdateTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>

<span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;HUDPaint&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;MiHUD&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span>
<span class="w">    </span><span class="nv">surface</span><span class="p">.</span><span class="nf">SetMaterial</span><span class="p">(</span><span class="nv">matHeart</span><span class="p">)</span>
<span class="w">    </span><span class="nv">surface</span><span class="p">.</span><span class="nf">SetDrawColor</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="nv">surface</span><span class="p">.</span><span class="nf">DrawTexturedRect</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="nf">ScrH</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">60</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span>

<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">ply</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">player</span><span class="p">.</span><span class="nf">GetAll</span><span class="p">())</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">ply</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="nf">LocalPlayer</span><span class="p">()</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="kd">local</span><span class="w"> </span><span class="nv">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">GetPos</span><span class="p">():</span><span class="nf">ToScreen</span><span class="p">()</span>
<span class="w">            </span><span class="nv">draw</span><span class="p">.</span><span class="nf">SimpleText</span><span class="p">(</span><span class="nv">ply</span><span class="p">:</span><span class="nf">Nick</span><span class="p">(),</span><span class="w"> </span><span class="s2">&quot;MiFuente&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">pos</span><span class="p">.</span><span class="py">x</span><span class="p">,</span><span class="w"> </span><span class="nv">pos</span><span class="p">.</span><span class="py">y</span><span class="p">,</span><span class="w"> </span><span class="nv">colWhite</span><span class="p">)</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="c1">-- Cachear NWString (no leer cada frame)</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nf">CurTime</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nv">jobUpdateTime</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="nv">cachedJob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">LocalPlayer</span><span class="p">():</span><span class="nf">GetNWString</span><span class="p">(</span><span class="s2">&quot;trabajo&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nv">jobUpdateTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">CurTime</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">cachedJob</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;Polic√≠a&quot;</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="nv">draw</span><span class="p">.</span><span class="nf">RoundedBox</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="nf">ScrW</span><span class="p">()</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="nv">colBlue</span><span class="p">)</span>
<span class="w">        </span><span class="nv">draw</span><span class="p">.</span><span class="nf">SimpleText</span><span class="p">(</span><span class="s2">&quot;POLIC√çA&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;MiFuente&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">ScrW</span><span class="p">()</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">25</span><span class="p">,</span><span class="w"> </span><span class="nv">colWhite</span><span class="p">,</span><span class="w"> </span><span class="nv">TEXT_ALIGN_CENTER</span><span class="p">,</span><span class="w"> </span><span class="nv">TEXT_ALIGN_CENTER</span><span class="p">)</span>
<span class="w">    </span><span class="kr">end</span>
<span class="kr">end</span><span class="p">)</span>
</pre></div>
</pre></div>

</div>
</details>
<h3 id="ejercicio-132-benchmark-de-metodos-intermedio">Ejercicio 13.2 ‚Äî Benchmark de M√©todos <span class="badge medium">‚≠ê‚≠ê Intermedio</span></h3>
<p>Escrib√≠ un script que compare el rendimiento de:
1. <code>ents.GetAll()</code> + filtro manual vs <code>ents.FindByClass("prop_physics")</code>
2. <code>table.insert(t, val)</code> vs <code>t[#t + 1] = val</code>
3. Acceso global <code>CurTime()</code> vs localizado <code>local CT = CurTime</code></p>
<p>Med√≠ cada uno con <code>SysTime()</code> en 100,000 iteraciones y mostr√° los resultados.</p>
<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- Ejecutar en cliente con lua_run_cl</span>
<span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">Bench</span><span class="p">(</span><span class="nv">nombre</span><span class="p">,</span><span class="w"> </span><span class="nv">func</span><span class="p">,</span><span class="w"> </span><span class="nv">iters</span><span class="p">)</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">SysTime</span><span class="p">()</span>
<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nv">iters</span><span class="w"> </span><span class="kr">do</span><span class="w"> </span><span class="nf">func</span><span class="p">()</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">elapsed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">SysTime</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">t</span>
<span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="nb">string.format</span><span class="p">(</span><span class="s2">&quot;%s: %.4f ms (%d iters)&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">nombre</span><span class="p">,</span><span class="w"> </span><span class="nv">elapsed</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w"> </span><span class="nv">iters</span><span class="p">))</span>
<span class="kr">end</span>

<span class="kd">local</span><span class="w"> </span><span class="nv">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100000</span>

<span class="c1">-- Test 1: ents.GetAll + filter vs FindByClass</span>
<span class="nf">Bench</span><span class="p">(</span><span class="s2">&quot;ents.GetAll + filter&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span>
<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">e</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">ents</span><span class="p">.</span><span class="nf">GetAll</span><span class="p">())</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">e</span><span class="p">:</span><span class="nf">GetClass</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;prop_physics&quot;</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">end</span>
<span class="kr">end</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">)</span>

<span class="nf">Bench</span><span class="p">(</span><span class="s2">&quot;ents.FindByClass&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span>
<span class="w">    </span><span class="nv">ents</span><span class="p">.</span><span class="nf">FindByClass</span><span class="p">(</span><span class="s2">&quot;prop_physics&quot;</span><span class="p">)</span>
<span class="kr">end</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">)</span>

<span class="c1">-- Test 2: table.insert vs [#t+1]</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">t1</span><span class="p">,</span><span class="w"> </span><span class="nv">t2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="p">{}</span>
<span class="nf">Bench</span><span class="p">(</span><span class="s2">&quot;table.insert&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span><span class="w"> </span><span class="nb">table.insert</span><span class="p">(</span><span class="nv">t1</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="kr">end</span><span class="p">,</span><span class="w"> </span><span class="nv">N</span><span class="p">)</span>
<span class="nf">Bench</span><span class="p">(</span><span class="s2">&quot;t[#t+1]&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span><span class="w"> </span><span class="nv">t2</span><span class="p">[</span><span class="o">#</span><span class="nv">t2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="kr">end</span><span class="p">,</span><span class="w"> </span><span class="nv">N</span><span class="p">)</span>

<span class="c1">-- Test 3: Global vs Local CurTime</span>
<span class="nf">Bench</span><span class="p">(</span><span class="s2">&quot;Global CurTime()&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span><span class="w"> </span><span class="kd">local</span><span class="w"> </span><span class="nv">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">CurTime</span><span class="p">()</span><span class="w"> </span><span class="kr">end</span><span class="p">,</span><span class="w"> </span><span class="nv">N</span><span class="p">)</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">CT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">CurTime</span>
<span class="nf">Bench</span><span class="p">(</span><span class="s2">&quot;Local CurTime&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span><span class="w"> </span><span class="kd">local</span><span class="w"> </span><span class="nv">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">CT</span><span class="p">()</span><span class="w"> </span><span class="kr">end</span><span class="p">,</span><span class="w"> </span><span class="nv">N</span><span class="p">)</span>
</pre></div>
</pre></div>

</div>
</details>

<h3 id="ejercicio-133-cache-inteligente-de-entidades-avanzado">Ejercicio 13.3 ‚Äî Cach√© Inteligente de Entidades <span class="badge advanced">‚≠ê‚≠ê‚≠ê Avanzado</span></h3>
<p>En vez de usar <code>ents.FindByClass()</code> cada vez que necesit√°s una lista de entidades, cre√° un sistema de cach√© que mantenga listas actualizadas usando hooks. Implement√°:</p>
<ul>
<li>Una tabla global <code>EntCache</code> que almacene entidades por clase.</li>
<li>Usar <code>OnEntityCreated</code> y <code>EntityRemoved</code> para mantener la cach√© actualizada.</li>
<li>Una funci√≥n <code>EntCache.GetByClass(clase)</code> que retorne la lista cacheada.</li>
<li>Comparar el rendimiento con <code>ents.FindByClass()</code> en un benchmark.</li>
</ul>
<p><strong>Objetivos:</strong> Cach√© de datos, hooks de entidades, optimizaci√≥n, benchmarking</p>
<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<div class="highlight"><pre><span></span><code>-- SHARED: Sistema de cach√© de entidades
EntCache = EntCache or {}
EntCache.cache = EntCache.cache or {}

-- Mantener cach√© actualizada con hooks
hook.Add("OnEntityCreated", "EntCache_Add", function(ent)
    timer.Simple(0, function()  -- Esperar a que la entidad se inicialice
        if not IsValid(ent) then return end
        local clase = ent:GetClass()
        EntCache.cache[clase] = EntCache.cache[clase] or {}
        table.insert(EntCache.cache[clase], ent)
    end)
end)

hook.Add("EntityRemoved", "EntCache_Remove", function(ent)
    local clase = ent:GetClass()
    if not EntCache.cache[clase] then return end

    for i, cached in ipairs(EntCache.cache[clase]) do
        if cached == ent then
            table.remove(EntCache.cache[clase], i)
            break
        end
    end
end)

-- Funci√≥n de acceso r√°pido
function EntCache.GetByClass(clase)
    return EntCache.cache[clase] or {}
end

-- Benchmark comparativo
local function BenchmarkCache()
    local N = 10000
    local t1 = SysTime()
    for i = 1, N do
        ents.FindByClass("prop_physics")
    end
    local tiempo1 = SysTime() - t1

    local t2 = SysTime()
    for i = 1, N do
        EntCache.GetByClass("prop_physics")
    end
    local tiempo2 = SysTime() - t2

    print(string.format("FindByClass: %.2fms | Cache: %.2fms | Speedup: %.1fx",
        tiempo1 * 1000, tiempo2 * 1000, tiempo1 / tiempo2))
end
</code></pre></div>

</div>
</details>

<hr />
<h2 id="135-metatables-y-oop"><span class="num">13.5</span> Metatables y OOP</h2>

<h3 id="ejercicio-135-1-sistema-de-inventario-con-oop-intermedio">Ejercicio 13.5.1 ‚Äî Sistema de Inventario con OOP <span class="badge medium">‚≠ê‚≠ê Intermedio</span></h3>
<p>Cre√° una clase <code>Inventario</code> usando metatables que permita:</p>
<ul>
<li>Crear un nuevo inventario con <code>Inventario:New(maxSlots)</code></li>
<li>Agregar items con <code>inv:AddItem(nombre, cantidad)</code> (respetar el m√°ximo de slots)</li>
<li>Remover items con <code>inv:RemoveItem(nombre, cantidad)</code></li>
<li>Verificar si tiene un item con <code>inv:HasItem(nombre, cantidadMinima)</code></li>
<li>Obtener la cantidad usada de slots con <code>inv:GetUsedSlots()</code></li>
<li>Serializar a JSON con <code>inv:ToJSON()</code> y restaurar con <code>Inventario:FromJSON(json)</code></li>
</ul>
<p><strong>Objetivos:</strong> Metatables, <code>__index</code>, OOP en Lua, serializaci√≥n JSON</p>
<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<div class="highlight"><pre><span></span><code>local Inventario = {}
Inventario.__index = Inventario

function Inventario:New(maxSlots)
    local inv = setmetatable({}, Inventario)
    inv.items = {}
    inv.maxSlots = maxSlots or 20
    return inv
end

function Inventario:AddItem(nombre, cantidad)
    cantidad = cantidad or 1

    -- Si ya tiene el item, sumar cantidad
    if self.items[nombre] then
        self.items[nombre] = self.items[nombre] + cantidad
        return true
    end

    -- Verificar si hay espacio
    if self:GetUsedSlots() >= self.maxSlots then
        return false, "Inventario lleno"
    end

    self.items[nombre] = cantidad
    return true
end

function Inventario:RemoveItem(nombre, cantidad)
    cantidad = cantidad or 1
    if not self.items[nombre] then return false, "No ten√©s ese item" end
    if self.items[nombre] < cantidad then return false, "Cantidad insuficiente" end

    self.items[nombre] = self.items[nombre] - cantidad
    if self.items[nombre] <= 0 then
        self.items[nombre] = nil
    end
    return true
end

function Inventario:HasItem(nombre, cantidadMinima)
    cantidadMinima = cantidadMinima or 1
    return (self.items[nombre] or 0) >= cantidadMinima
end

function Inventario:GetUsedSlots()
    local count = 0
    for _ in pairs(self.items) do count = count + 1 end
    return count
end

function Inventario:ToJSON()
    return util.TableToJSON({
        items = self.items,
        maxSlots = self.maxSlots
    }, true)
end

function Inventario.FromJSON(json)
    local data = util.JSONToTable(json)
    if not data then return nil end

    local inv = Inventario:New(data.maxSlots)
    inv.items = data.items or {}
    return inv
end

-- Uso:
local inv = Inventario:New(10)
inv:AddItem("espada", 1)
inv:AddItem("pocion", 5)
print(inv:HasItem("pocion", 3))  -- true
inv:RemoveItem("pocion", 2)
print(inv:GetUsedSlots())        -- 2

local json = inv:ToJSON()
local inv2 = Inventario.FromJSON(json)
print(inv2:HasItem("espada"))    -- true
</code></pre></div>

</div>
</details>

<h3 id="ejercicio-135-2-extender-metatable-de-player-intermedio">Ejercicio 13.5.2 ‚Äî Extender la Metatable de Player <span class="badge medium">‚≠ê‚≠ê Intermedio</span></h3>
<p>Usando <code>FindMetaTable("Player")</code>, agreg√° estos m√©todos personalizados a todos los jugadores:</p>
<ul>
<li><code>ply:GetPlayTime()</code> ‚Äî retorna los segundos que lleva jugando en esta sesi√≥n.</li>
<li><code>ply:GetFormattedPlayTime()</code> ‚Äî retorna el tiempo formateado como "2h 15m 30s".</li>
<li><code>ply:IsNearby(otroJugador, distancia)</code> ‚Äî retorna true si est√° dentro de la distancia especificada.</li>
<li><code>ply:Notify(texto, tipo)</code> ‚Äî env√≠a una notificaci√≥n al jugador (server-side, usa net messages).</li>
</ul>
<p><strong>Objetivos:</strong> <code>FindMetaTable</code>, extender tipos del engine, metatables en la pr√°ctica</p>
<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<div class="highlight"><pre><span></span><code>-- SHARED
local PLAYER = FindMetaTable("Player")

function PLAYER:GetPlayTime()
    return CurTime() - (self.JoinTime or CurTime())
end

function PLAYER:GetFormattedPlayTime()
    local secs = self:GetPlayTime()
    local h = math.floor(secs / 3600)
    local m = math.floor((secs % 3600) / 60)
    local s = math.floor(secs % 60)

    if h > 0 then
        return string.format("%dh %dm %ds", h, m, s)
    elseif m > 0 then
        return string.format("%dm %ds", m, s)
    end
    return string.format("%ds", s)
end

function PLAYER:IsNearby(otro, distancia)
    if not IsValid(otro) then return false end
    return self:GetPos():DistToSqr(otro:GetPos()) <= distancia * distancia
end

-- SERVER: Registrar tiempo de conexi√≥n
hook.Add("PlayerInitialSpawn", "PlayTime_Init", function(ply)
    ply.JoinTime = CurTime()
end)

-- SERVER: Notificaci√≥n
util.AddNetworkString("Notificar")

function PLAYER:Notify(texto, tipo)
    tipo = tipo or "info"  -- "info", "error", "success"
    net.Start("Notificar")
        net.WriteString(texto)
        net.WriteString(tipo)
    net.Send(self)
end

-- CLIENT: Recibir notificaci√≥n
net.Receive("Notificar", function()
    local texto = net.ReadString()
    local tipo = net.ReadString()
    local colores = {
        info = Color(100, 180, 255),
        error = Color(255, 80, 80),
        success = Color(80, 255, 80)
    }
    chat.AddText(colores[tipo] or colores.info, "[Server] ", Color(255,255,255), texto)
end)
</code></pre></div>

</div>
</details>

<hr />
<h2 id="14-desafios-integradores"><span class="num">14</span> Desaf√≠os Integradores</h2>
<h3 id="desafio-141-sistema-de-duelos-avanzado">Desaf√≠o 14.1 ‚Äî Sistema de Duelos <span class="badge advanced">‚≠ê‚≠ê‚≠ê Avanzado</span></h3>
<p>Implement√° un sistema completo de duelos entre jugadores:
- <code>!duelo &lt;nombre&gt;</code> env√≠a una solicitud al jugador.
- El otro jugador recibe un popup VGUI para aceptar o rechazar.
- Si acepta, ambos son teletransportados a posiciones enfrentadas, se les da vida completa y un arma espec√≠fica.
- El primero en morir pierde. El ganador recibe $500.
- Timeout de 2 minutos: si nadie muere, es empate.
- No se puede iniciar un duelo si ya hay uno activo.
- Stats de duelos ganados/perdidos en SQLite.</p>
<p><strong>Sistemas involucrados:</strong> Net, VGUI, Hooks (PlayerDeath), Timers, SQL, validaci√≥n server-side.</p>

<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<p>Esqueleto funcional del sistema de duelos:</p>
<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- === SERVER ===</span>
<span class="nv">util</span><span class="p">.</span><span class="nf">AddNetworkString</span><span class="p">(</span><span class="s2">&quot;Duelo_Solicitar&quot;</span><span class="p">)</span>
<span class="nv">util</span><span class="p">.</span><span class="nf">AddNetworkString</span><span class="p">(</span><span class="s2">&quot;Duelo_Responder&quot;</span><span class="p">)</span>
<span class="nv">util</span><span class="p">.</span><span class="nf">AddNetworkString</span><span class="p">(</span><span class="s2">&quot;Duelo_Popup&quot;</span><span class="p">)</span>

<span class="kd">local</span><span class="w"> </span><span class="nv">duelos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w">  </span><span class="c1">-- {retador, retado, activo, inicio}</span>

<span class="nv">sql</span><span class="p">.</span><span class="nf">Query</span><span class="p">([[</span><span class="nv">CREATE</span><span class="w"> </span><span class="nv">TABLE</span><span class="w"> </span><span class="nv">IF</span><span class="w"> </span><span class="nv">NOT</span><span class="w"> </span><span class="nv">EXISTS</span><span class="w"> </span><span class="nf">duelos_stats</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="nv">steamid</span><span class="w"> </span><span class="nv">TEXT</span><span class="w"> </span><span class="nv">PRIMARY</span><span class="w"> </span><span class="nv">KEY</span><span class="p">,</span><span class="w"> </span><span class="nv">ganados</span><span class="w"> </span><span class="nv">INTEGER</span><span class="w"> </span><span class="nv">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">perdidos</span><span class="w"> </span><span class="nv">INTEGER</span><span class="w"> </span><span class="nv">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">)]])</span>

<span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;PlayerSay&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Duelo_Cmd&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">ply</span><span class="p">,</span><span class="w"> </span><span class="nv">text</span><span class="p">)</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">string</span><span class="p">.</span><span class="nf">StartWith</span><span class="p">(</span><span class="nv">text</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;!duelo &quot;</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">targetName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">string.sub</span><span class="p">(</span><span class="nv">text</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span>

<span class="w">    </span><span class="c1">-- Buscar target</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">target</span>
<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">player</span><span class="p">.</span><span class="nf">GetAll</span><span class="p">())</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nb">string.find</span><span class="p">(</span><span class="nb">string.lower</span><span class="p">(</span><span class="nv">p</span><span class="p">:</span><span class="nf">Nick</span><span class="p">()),</span><span class="w"> </span><span class="nb">string.lower</span><span class="p">(</span><span class="nv">targetName</span><span class="p">),</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="nv">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="kr">break</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">target</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nv">target</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">ply</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">ChatPrint</span><span class="p">(</span><span class="s2">&quot;Jugador no v√°lido&quot;</span><span class="p">)</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="kr">end</span>

<span class="w">    </span><span class="c1">-- Verificar no hay duelo activo</span>
<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">d</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">duelos</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">d</span><span class="p">.</span><span class="py">activo</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">ChatPrint</span><span class="p">(</span><span class="s2">&quot;Ya hay un duelo activo&quot;</span><span class="p">)</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">duelo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="nv">retador</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ply</span><span class="p">,</span><span class="w"> </span><span class="nv">retado</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">target</span><span class="p">,</span><span class="w"> </span><span class="nv">activo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">}</span>
<span class="w">    </span><span class="nb">table.insert</span><span class="p">(</span><span class="nv">duelos</span><span class="p">,</span><span class="w"> </span><span class="nv">duelo</span><span class="p">)</span>

<span class="w">    </span><span class="c1">-- Enviar popup al target</span>
<span class="w">    </span><span class="nv">net</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="s2">&quot;Duelo_Popup&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nv">net</span><span class="p">.</span><span class="nf">WriteEntity</span><span class="p">(</span><span class="nv">ply</span><span class="p">)</span>
<span class="w">    </span><span class="nv">net</span><span class="p">.</span><span class="nf">Send</span><span class="p">(</span><span class="nv">target</span><span class="p">)</span>

<span class="w">    </span><span class="nv">ply</span><span class="p">:</span><span class="nf">ChatPrint</span><span class="p">(</span><span class="s2">&quot;Solicitud enviada a &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">target</span><span class="p">:</span><span class="nf">Nick</span><span class="p">())</span>
<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="kr">end</span><span class="p">)</span>

<span class="nv">net</span><span class="p">.</span><span class="nf">Receive</span><span class="p">(</span><span class="s2">&quot;Duelo_Responder&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">len</span><span class="p">,</span><span class="w"> </span><span class="nv">ply</span><span class="p">)</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">acepta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">net</span><span class="p">.</span><span class="nf">ReadBool</span><span class="p">()</span>
<span class="w">    </span><span class="c1">-- Buscar duelo pendiente para este jugador</span>
<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">i</span><span class="p">,</span><span class="w"> </span><span class="nv">d</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">duelos</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">d</span><span class="p">.</span><span class="py">retado</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">ply</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">d</span><span class="p">.</span><span class="py">activo</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="kr">if</span><span class="w"> </span><span class="nv">acepta</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                </span><span class="nv">d</span><span class="p">.</span><span class="py">activo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">                </span><span class="nv">d</span><span class="p">.</span><span class="py">inicio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">CurTime</span><span class="p">()</span>
<span class="w">                </span><span class="c1">-- Preparar duelo</span>
<span class="w">                </span><span class="nv">d</span><span class="p">.</span><span class="py">retador</span><span class="p">:</span><span class="nf">SetHealth</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="w">                </span><span class="nv">d</span><span class="p">.</span><span class="py">retado</span><span class="p">:</span><span class="nf">SetHealth</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="w">                </span><span class="nv">d</span><span class="p">.</span><span class="py">retador</span><span class="p">:</span><span class="nf">StripWeapons</span><span class="p">()</span>
<span class="w">                </span><span class="nv">d</span><span class="p">.</span><span class="py">retado</span><span class="p">:</span><span class="nf">StripWeapons</span><span class="p">()</span>
<span class="w">                </span><span class="nv">d</span><span class="p">.</span><span class="py">retador</span><span class="p">:</span><span class="nf">Give</span><span class="p">(</span><span class="s2">&quot;weapon_pistol&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="nv">d</span><span class="p">.</span><span class="py">retado</span><span class="p">:</span><span class="nf">Give</span><span class="p">(</span><span class="s2">&quot;weapon_pistol&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="nf">PrintMessage</span><span class="p">(</span><span class="nv">HUD_PRINTTALK</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;DUELO: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">d</span><span class="p">.</span><span class="py">retador</span><span class="p">:</span><span class="nf">Nick</span><span class="p">()</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; vs &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">d</span><span class="p">.</span><span class="py">retado</span><span class="p">:</span><span class="nf">Nick</span><span class="p">())</span>

<span class="w">                </span><span class="c1">-- Timeout 2 min</span>
<span class="w">                </span><span class="nv">timer</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;Duelo_Timeout_&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">i</span><span class="p">,</span><span class="w"> </span><span class="mi">120</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span>
<span class="w">                    </span><span class="kr">if</span><span class="w"> </span><span class="nv">d</span><span class="p">.</span><span class="py">activo</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                        </span><span class="nv">d</span><span class="p">.</span><span class="py">activo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">                        </span><span class="nf">PrintMessage</span><span class="p">(</span><span class="nv">HUD_PRINTTALK</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Duelo termin√≥ en EMPATE&quot;</span><span class="p">)</span>
<span class="w">                        </span><span class="nb">table.remove</span><span class="p">(</span><span class="nv">duelos</span><span class="p">,</span><span class="w"> </span><span class="nv">i</span><span class="p">)</span>
<span class="w">                    </span><span class="kr">end</span>
<span class="w">                </span><span class="kr">end</span><span class="p">)</span>
<span class="w">            </span><span class="kr">else</span>
<span class="w">                </span><span class="nb">table.remove</span><span class="p">(</span><span class="nv">duelos</span><span class="p">,</span><span class="w"> </span><span class="nv">i</span><span class="p">)</span>
<span class="w">                </span><span class="nv">d</span><span class="p">.</span><span class="py">retador</span><span class="p">:</span><span class="nf">ChatPrint</span><span class="p">(</span><span class="nv">ply</span><span class="p">:</span><span class="nf">Nick</span><span class="p">()</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; rechaz√≥ el duelo&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="kr">end</span>
<span class="w">            </span><span class="kr">return</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">end</span>
<span class="kr">end</span><span class="p">)</span>

<span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;PlayerDeath&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Duelo_Muerte&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">victima</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">atacante</span><span class="p">)</span>
<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">i</span><span class="p">,</span><span class="w"> </span><span class="nv">d</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">duelos</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">d</span><span class="p">.</span><span class="py">activo</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="nv">continue</span><span class="w"> </span><span class="kr">end</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">victima</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">d</span><span class="p">.</span><span class="py">retador</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nv">victima</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">d</span><span class="p">.</span><span class="py">retado</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="kd">local</span><span class="w"> </span><span class="nv">ganador</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">victima</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">d</span><span class="p">.</span><span class="py">retador</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">d</span><span class="p">.</span><span class="py">retado</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nv">d</span><span class="p">.</span><span class="py">retador</span>
<span class="w">            </span><span class="nv">d</span><span class="p">.</span><span class="py">activo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">            </span><span class="nv">timer</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="s2">&quot;Duelo_Timeout_&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">i</span><span class="p">)</span>
<span class="w">            </span><span class="nf">PrintMessage</span><span class="p">(</span><span class="nv">HUD_PRINTTALK</span><span class="p">,</span><span class="w"> </span><span class="nv">ganador</span><span class="p">:</span><span class="nf">Nick</span><span class="p">()</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; gan√≥ el duelo!&quot;</span><span class="p">)</span>

<span class="w">            </span><span class="c1">-- Stats SQL</span>
<span class="w">            </span><span class="kd">local</span><span class="w"> </span><span class="nv">gs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">sql</span><span class="p">.</span><span class="nf">SQLStr</span><span class="p">(</span><span class="nv">ganador</span><span class="p">:</span><span class="nf">SteamID64</span><span class="p">())</span>
<span class="w">            </span><span class="kd">local</span><span class="w"> </span><span class="nv">ps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">sql</span><span class="p">.</span><span class="nf">SQLStr</span><span class="p">(</span><span class="nv">victima</span><span class="p">:</span><span class="nf">SteamID64</span><span class="p">())</span>
<span class="w">            </span><span class="nv">sql</span><span class="p">.</span><span class="nf">Query</span><span class="p">(</span><span class="s2">&quot;INSERT OR IGNORE INTO duelos_stats (steamid) VALUES (&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">gs</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;)&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="nv">sql</span><span class="p">.</span><span class="nf">Query</span><span class="p">(</span><span class="s2">&quot;INSERT OR IGNORE INTO duelos_stats (steamid) VALUES (&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">ps</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;)&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="nv">sql</span><span class="p">.</span><span class="nf">Query</span><span class="p">(</span><span class="s2">&quot;UPDATE duelos_stats SET ganados = ganados + 1 WHERE steamid = &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">gs</span><span class="p">)</span>
<span class="w">            </span><span class="nv">sql</span><span class="p">.</span><span class="nf">Query</span><span class="p">(</span><span class="s2">&quot;UPDATE duelos_stats SET perdidos = perdidos + 1 WHERE steamid = &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">ps</span><span class="p">)</span>

<span class="w">            </span><span class="nb">table.remove</span><span class="p">(</span><span class="nv">duelos</span><span class="p">,</span><span class="w"> </span><span class="nv">i</span><span class="p">)</span>
<span class="w">            </span><span class="kr">return</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">end</span>
<span class="kr">end</span><span class="p">)</span>
</pre></div>
</pre></div>
<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- === CLIENT ===</span>
<span class="nv">net</span><span class="p">.</span><span class="nf">Receive</span><span class="p">(</span><span class="s2">&quot;Duelo_Popup&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">retador</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">net</span><span class="p">.</span><span class="nf">ReadEntity</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DFrame&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">f</span><span class="p">:</span><span class="nf">SetSize</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span><span class="w"> </span><span class="mi">130</span><span class="p">)</span>
<span class="w">    </span><span class="nv">f</span><span class="p">:</span><span class="nf">Center</span><span class="p">()</span>
<span class="w">    </span><span class="nv">f</span><span class="p">:</span><span class="nf">SetTitle</span><span class="p">(</span><span class="s2">&quot;Solicitud de Duelo&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">f</span><span class="p">:</span><span class="nf">MakePopup</span><span class="p">()</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">lbl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DLabel&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">f</span><span class="p">)</span>
<span class="w">    </span><span class="nv">lbl</span><span class="p">:</span><span class="nf">Dock</span><span class="p">(</span><span class="nv">TOP</span><span class="p">)</span>
<span class="w">    </span><span class="nv">lbl</span><span class="p">:</span><span class="nf">DockMargin</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
<span class="w">    </span><span class="nv">lbl</span><span class="p">:</span><span class="nf">SetText</span><span class="p">(</span><span class="nf">IsValid</span><span class="p">(</span><span class="nv">retador</span><span class="p">)</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">retador</span><span class="p">:</span><span class="nf">Nick</span><span class="p">()</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; te desaf√≠a a un duelo!&quot;</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s2">&quot;Duelo solicitado&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">lbl</span><span class="p">:</span><span class="nf">SetContentAlignment</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">bp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DPanel&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">f</span><span class="p">)</span>
<span class="w">    </span><span class="nv">bp</span><span class="p">:</span><span class="nf">Dock</span><span class="p">(</span><span class="nv">BOTTOM</span><span class="p">)</span>
<span class="w">    </span><span class="nv">bp</span><span class="p">:</span><span class="nf">SetTall</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span>
<span class="w">    </span><span class="nv">bp</span><span class="p">:</span><span class="nf">DockMargin</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
<span class="w">    </span><span class="nv">bp</span><span class="p">.</span><span class="py">Paint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span><span class="w"> </span><span class="kr">end</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">Responder</span><span class="p">(</span><span class="nv">val</span><span class="p">)</span>
<span class="w">        </span><span class="nv">net</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="s2">&quot;Duelo_Responder&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="nv">net</span><span class="p">.</span><span class="nf">WriteBool</span><span class="p">(</span><span class="nv">val</span><span class="p">)</span>
<span class="w">        </span><span class="nv">net</span><span class="p">.</span><span class="nf">SendToServer</span><span class="p">()</span>
<span class="w">        </span><span class="nv">f</span><span class="p">:</span><span class="nf">Close</span><span class="p">()</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">bSi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DButton&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">bp</span><span class="p">)</span>
<span class="w">    </span><span class="nv">bSi</span><span class="p">:</span><span class="nf">Dock</span><span class="p">(</span><span class="nv">LEFT</span><span class="p">)</span>
<span class="w">    </span><span class="nv">bSi</span><span class="p">:</span><span class="nf">SetWide</span><span class="p">(</span><span class="mi">130</span><span class="p">)</span>
<span class="w">    </span><span class="nv">bSi</span><span class="p">:</span><span class="nf">SetText</span><span class="p">(</span><span class="s2">&quot;Aceptar&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">bSi</span><span class="p">.</span><span class="py">DoClick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span><span class="w"> </span><span class="nf">Responder</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="kr">end</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">bNo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DButton&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">bp</span><span class="p">)</span>
<span class="w">    </span><span class="nv">bNo</span><span class="p">:</span><span class="nf">Dock</span><span class="p">(</span><span class="nv">RIGHT</span><span class="p">)</span>
<span class="w">    </span><span class="nv">bNo</span><span class="p">:</span><span class="nf">SetWide</span><span class="p">(</span><span class="mi">130</span><span class="p">)</span>
<span class="w">    </span><span class="nv">bNo</span><span class="p">:</span><span class="nf">SetText</span><span class="p">(</span><span class="s2">&quot;Rechazar&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">bNo</span><span class="p">.</span><span class="py">DoClick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span><span class="w"> </span><span class="nf">Responder</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span><span class="w"> </span><span class="kr">end</span>
<span class="kr">end</span><span class="p">)</span>
</pre></div>
</pre></div>

</div>
</details>
<h3 id="desafio-142-addon-de-carteles-personalizados-avanzado">Desaf√≠o 14.2 ‚Äî Addon de Carteles Personalizados <span class="badge advanced">‚≠ê‚≠ê‚≠ê Avanzado</span></h3>
<p>Cre√° un addon que permita a los jugadores colocar carteles en el mundo:
- Entidad SENT con un texto personalizable (3D2D visible).
- Men√∫ VGUI para escribir el texto, elegir color, y tama√±o.
- Los admins pueden eliminar carteles de otros.
- Los carteles se guardan en SQLite y se restauran al reiniciar el server.
- L√≠mite de 3 carteles por jugador.</p>

<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- === SENT: Cartel Personalizado ===</span>
<span class="c1">-- shared.lua</span>
<span class="nv">ENT</span><span class="p">.</span><span class="py">Type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;anim&quot;</span>
<span class="nv">ENT</span><span class="p">.</span><span class="py">Base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;base_gmodentity&quot;</span>
<span class="nv">ENT</span><span class="p">.</span><span class="py">PrintName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Cartel&quot;</span>
<span class="nv">ENT</span><span class="p">.</span><span class="py">Spawnable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">ENT</span><span class="p">:</span><span class="nf">SetupDataTables</span><span class="p">()</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">NetworkVar</span><span class="p">(</span><span class="s2">&quot;String&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Texto&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">NetworkVar</span><span class="p">(</span><span class="s2">&quot;Vector&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;TextColor&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">NetworkVar</span><span class="p">(</span><span class="s2">&quot;String&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;OwnerSID&quot;</span><span class="p">)</span>
<span class="kr">end</span>

<span class="c1">-- init.lua (SERVER)</span>
<span class="nv">sql</span><span class="p">.</span><span class="nf">Query</span><span class="p">([[</span><span class="nv">CREATE</span><span class="w"> </span><span class="nv">TABLE</span><span class="w"> </span><span class="nv">IF</span><span class="w"> </span><span class="nv">NOT</span><span class="w"> </span><span class="nv">EXISTS</span><span class="w"> </span><span class="nf">carteles</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="nv">id</span><span class="w"> </span><span class="nv">INTEGER</span><span class="w"> </span><span class="nv">PRIMARY</span><span class="w"> </span><span class="nv">KEY</span><span class="w"> </span><span class="nv">AUTOINCREMENT</span><span class="p">,</span><span class="w"> </span><span class="nv">steamid</span><span class="w"> </span><span class="nv">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="nv">x</span><span class="w"> </span><span class="nv">REAL</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nv">REAL</span><span class="p">,</span><span class="w"> </span><span class="nv">z</span><span class="w"> </span><span class="nv">REAL</span><span class="p">,</span><span class="w"> </span><span class="nv">ax</span><span class="w"> </span><span class="nv">REAL</span><span class="p">,</span><span class="w"> </span><span class="nv">ay</span><span class="w"> </span><span class="nv">REAL</span><span class="p">,</span><span class="w"> </span><span class="nv">az</span><span class="w"> </span><span class="nv">REAL</span><span class="p">,</span>
<span class="w">    </span><span class="nv">texto</span><span class="w"> </span><span class="nv">TEXT</span><span class="p">,</span><span class="w"> </span><span class="nv">color_r</span><span class="w"> </span><span class="nv">INTEGER</span><span class="p">,</span><span class="w"> </span><span class="nv">color_g</span><span class="w"> </span><span class="nv">INTEGER</span><span class="p">,</span><span class="w"> </span><span class="nv">color_b</span><span class="w"> </span><span class="nv">INTEGER</span><span class="p">)]])</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">ENT</span><span class="p">:</span><span class="nf">Initialize</span><span class="p">()</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">SetModel</span><span class="p">(</span><span class="s2">&quot;models/props_junk/wood_crate001a_chunk09.mdl&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">PhysicsInit</span><span class="p">(</span><span class="nv">SOLID_VPHYSICS</span><span class="p">)</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">SetMoveType</span><span class="p">(</span><span class="nv">MOVETYPE_VPHYSICS</span><span class="p">)</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">SetSolid</span><span class="p">(</span><span class="nv">SOLID_VPHYSICS</span><span class="p">)</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">SetTexto</span><span class="p">(</span><span class="s2">&quot;Cartel&quot;</span><span class="p">)</span>
<span class="kr">end</span>

<span class="c1">-- Restaurar al iniciar servidor</span>
<span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;InitPostEntity&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Carteles_Restaurar&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">sql</span><span class="p">.</span><span class="nf">Query</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM carteles&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">res</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">row</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">res</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">ent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ents</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;mi_cartel&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nv">ent</span><span class="p">:</span><span class="nf">SetPos</span><span class="p">(</span><span class="nf">Vector</span><span class="p">(</span><span class="nb">tonumber</span><span class="p">(</span><span class="nv">row</span><span class="p">.</span><span class="py">x</span><span class="p">),</span><span class="w"> </span><span class="nb">tonumber</span><span class="p">(</span><span class="nv">row</span><span class="p">.</span><span class="py">y</span><span class="p">),</span><span class="w"> </span><span class="nb">tonumber</span><span class="p">(</span><span class="nv">row</span><span class="p">.</span><span class="py">z</span><span class="p">)))</span>
<span class="w">        </span><span class="nv">ent</span><span class="p">:</span><span class="nf">SetAngles</span><span class="p">(</span><span class="nf">Angle</span><span class="p">(</span><span class="nb">tonumber</span><span class="p">(</span><span class="nv">row</span><span class="p">.</span><span class="py">ax</span><span class="p">),</span><span class="w"> </span><span class="nb">tonumber</span><span class="p">(</span><span class="nv">row</span><span class="p">.</span><span class="py">ay</span><span class="p">),</span><span class="w"> </span><span class="nb">tonumber</span><span class="p">(</span><span class="nv">row</span><span class="p">.</span><span class="py">az</span><span class="p">)))</span>
<span class="w">        </span><span class="nv">ent</span><span class="p">:</span><span class="nf">Spawn</span><span class="p">()</span>
<span class="w">        </span><span class="nv">ent</span><span class="p">:</span><span class="nf">SetTexto</span><span class="p">(</span><span class="nv">row</span><span class="p">.</span><span class="py">texto</span><span class="p">)</span>
<span class="w">        </span><span class="nv">ent</span><span class="p">:</span><span class="nf">SetOwnerSID</span><span class="p">(</span><span class="nv">row</span><span class="p">.</span><span class="py">steamid</span><span class="p">)</span>
<span class="w">    </span><span class="kr">end</span>
<span class="kr">end</span><span class="p">)</span>

<span class="c1">-- cl_init.lua (CLIENT)</span>
<span class="kr">function</span><span class="w"> </span><span class="nc">ENT</span><span class="p">:</span><span class="nf">Draw</span><span class="p">()</span>
<span class="w">    </span><span class="nv">self</span><span class="p">:</span><span class="nf">DrawModel</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">ang</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Angle</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nf">LocalPlayer</span><span class="p">():</span><span class="nf">EyeAngles</span><span class="p">().</span><span class="nv">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">90</span><span class="p">,</span><span class="w"> </span><span class="mi">90</span><span class="p">)</span>
<span class="w">    </span><span class="nv">cam</span><span class="p">.</span><span class="nf">Start3D2D</span><span class="p">(</span><span class="nv">self</span><span class="p">:</span><span class="nf">GetPos</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">Vector</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">30</span><span class="p">),</span><span class="w"> </span><span class="nv">ang</span><span class="p">,</span><span class="w"> </span><span class="mf">0.12</span><span class="p">)</span>
<span class="w">        </span><span class="nv">draw</span><span class="p">.</span><span class="nf">RoundedBox</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">150</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">25</span><span class="p">,</span><span class="w"> </span><span class="mi">300</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">200</span><span class="p">))</span>
<span class="w">        </span><span class="nv">draw</span><span class="p">.</span><span class="nf">SimpleText</span><span class="p">(</span><span class="nv">self</span><span class="p">:</span><span class="nf">GetTexto</span><span class="p">(),</span><span class="w"> </span><span class="s2">&quot;DermaLarge&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">            </span><span class="nv">color_white</span><span class="p">,</span><span class="w"> </span><span class="nv">TEXT_ALIGN_CENTER</span><span class="p">,</span><span class="w"> </span><span class="nv">TEXT_ALIGN_CENTER</span><span class="p">)</span>
<span class="w">    </span><span class="nv">cam</span><span class="p">.</span><span class="nf">End3D2D</span><span class="p">()</span>
<span class="kr">end</span>
</pre></div>
</pre></div>

</div>
</details>
<h3 id="desafio-143-gamemode-rey-de-la-colina-experto">Desaf√≠o 14.3 ‚Äî Gamemode: Rey de la Colina <span class="badge expert">‚≠ê‚≠ê‚≠ê‚≠ê Experto</span></h3>
<p>Cre√° un gamemode simple de "Rey de la Colina":
- Un punto de captura marcado en el mapa (configurable).
- Los jugadores dentro del punto lo van capturando progresivamente.
- HUD mostrando: barra de captura, tiempo restante, puntaje.
- Al capturar, el jugador gana puntos por segundo.
- Primer jugador en llegar a 100 puntos gana la ronda.
- Sistema de rondas con countdown y respawn autom√°tico.
- Scoreboard personalizado (override de <code>GM:ScoreboardShow</code>).</p>

<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<p>Esqueleto del gamemode Rey de la Colina. Archivo <code>gamemodes/koth/gamemode/</code>:</p>
<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- shared.lua</span>
<span class="nv">GM</span><span class="p">.</span><span class="py">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Rey de la Colina&quot;</span>
<span class="nv">GM</span><span class="p">.</span><span class="py">Author</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;MiAddon&quot;</span>

<span class="c1">-- init.lua (SERVER)</span>
<span class="nf">AddCSLuaFile</span><span class="p">(</span><span class="s2">&quot;shared.lua&quot;</span><span class="p">)</span>
<span class="nf">AddCSLuaFile</span><span class="p">(</span><span class="s2">&quot;cl_init.lua&quot;</span><span class="p">)</span>
<span class="nf">include</span><span class="p">(</span><span class="s2">&quot;shared.lua&quot;</span><span class="p">)</span>

<span class="kd">local</span><span class="w"> </span><span class="nv">CAPTURE_POS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Vector</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">  </span><span class="c1">-- Configurar por mapa</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">CAPTURE_RADIUS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">300</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">WIN_SCORE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">scores</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">GM</span><span class="p">:</span><span class="nf">PlayerInitialSpawn</span><span class="p">(</span><span class="nv">ply</span><span class="p">)</span><span class="w"> </span><span class="nv">scores</span><span class="p">[</span><span class="nv">ply</span><span class="p">:</span><span class="nf">SteamID64</span><span class="p">()]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="kr">end</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">GM</span><span class="p">:</span><span class="nf">Think</span><span class="p">()</span>
<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">ply</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">player</span><span class="p">.</span><span class="nf">GetAll</span><span class="p">())</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">Alive</span><span class="p">()</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">GetPos</span><span class="p">():</span><span class="nf">Distance</span><span class="p">(</span><span class="nv">CAPTURE_POS</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nv">CAPTURE_RADIUS</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="kd">local</span><span class="w"> </span><span class="nv">sid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">SteamID64</span><span class="p">()</span>
<span class="w">            </span><span class="nv">scores</span><span class="p">[</span><span class="nv">sid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nv">scores</span><span class="p">[</span><span class="nv">sid</span><span class="p">]</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">FrameTime</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span>
<span class="w">            </span><span class="kr">if</span><span class="w"> </span><span class="nv">scores</span><span class="p">[</span><span class="nv">sid</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nv">WIN_SCORE</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                </span><span class="nf">PrintMessage</span><span class="p">(</span><span class="nv">HUD_PRINTTALK</span><span class="p">,</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">Nick</span><span class="p">()</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; gana la ronda!&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="c1">-- Reset ronda</span>
<span class="w">                </span><span class="kr">for</span><span class="w"> </span><span class="nv">k</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">pairs</span><span class="p">(</span><span class="nv">scores</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span><span class="w"> </span><span class="nv">scores</span><span class="p">[</span><span class="nv">k</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="kr">end</span>
<span class="w">            </span><span class="kr">end</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">end</span>
<span class="w">    </span><span class="nf">SetGlobalFloat</span><span class="p">(</span><span class="s2">&quot;CaptureProgress&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">scores</span><span class="p">[</span><span class="nv">LocalPlayer</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nf">LocalPlayer</span><span class="p">():</span><span class="nf">SteamID64</span><span class="p">()]</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="kr">end</span>

<span class="c1">-- cl_init.lua (CLIENT)</span>
<span class="nf">include</span><span class="p">(</span><span class="s2">&quot;shared.lua&quot;</span><span class="p">)</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">GM</span><span class="p">:</span><span class="nf">HUDPaint</span><span class="p">()</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">prog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">GetGlobalFloat</span><span class="p">(</span><span class="s2">&quot;CaptureProgress&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">100</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">w</span><span class="p">,</span><span class="w"> </span><span class="nv">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">300</span><span class="p">,</span><span class="w"> </span><span class="mi">25</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ScrW</span><span class="p">()</span><span class="o">/</span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">w</span><span class="o">/</span><span class="mi">2</span>
<span class="w">    </span><span class="nv">draw</span><span class="p">.</span><span class="nf">RoundedBox</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="nv">x</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="nv">w</span><span class="p">,</span><span class="w"> </span><span class="nv">h</span><span class="p">,</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">180</span><span class="p">))</span>
<span class="w">    </span><span class="nv">draw</span><span class="p">.</span><span class="nf">RoundedBox</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="nv">x</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="nv">w</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">math</span><span class="p">.</span><span class="nf">Clamp</span><span class="p">(</span><span class="nv">prog</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="nv">h</span><span class="p">,</span><span class="w"> </span><span class="nf">Color</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">255</span><span class="p">))</span>
<span class="w">    </span><span class="nv">draw</span><span class="p">.</span><span class="nf">SimpleText</span><span class="p">(</span><span class="nb">math.floor</span><span class="p">(</span><span class="nv">prog</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;%&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;DermaDefaultBold&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nf">ScrW</span><span class="p">()</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">62</span><span class="p">,</span><span class="w"> </span><span class="nv">color_white</span><span class="p">,</span><span class="w"> </span><span class="nv">TEXT_ALIGN_CENTER</span><span class="p">,</span><span class="w"> </span><span class="nv">TEXT_ALIGN_CENTER</span><span class="p">)</span>
<span class="kr">end</span>
</pre></div>
</pre></div>

</div>
</details>
<h3 id="desafio-144-dashboard-de-admin-experto">Desaf√≠o 14.4 ‚Äî Dashboard de Admin <span class="badge expert">‚≠ê‚≠ê‚≠ê‚≠ê Experto</span></h3>
<p>Cre√° un panel de administraci√≥n completo con VGUI:
- Tab "Jugadores": Lista de jugadores conectados con acciones (kick, ban, tp a, tp hacia, god, noclip).
- Tab "Server": Mapa actual, uptime, FPS del server, count de entidades.
- Tab "Bans": Lista de bans activos desde SQLite, con opci√≥n de desbanear.
- Tab "Logs": Las √∫ltimas 50 acciones (kills, conexiones, desconexiones, comandos admin).
- Dise√±o profesional con paint custom en todos los paneles.
- Solo accesible para admins/superadmins.</p>

<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- CLIENT (solo admins)</span>
<span class="nv">concommand</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;admin_panel&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nf">LocalPlayer</span><span class="p">():</span><span class="nf">IsAdmin</span><span class="p">()</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">end</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DFrame&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">f</span><span class="p">:</span><span class="nf">SetSize</span><span class="p">(</span><span class="mi">700</span><span class="p">,</span><span class="w"> </span><span class="mi">500</span><span class="p">)</span>
<span class="w">    </span><span class="nv">f</span><span class="p">:</span><span class="nf">Center</span><span class="p">()</span>
<span class="w">    </span><span class="nv">f</span><span class="p">:</span><span class="nf">SetTitle</span><span class="p">(</span><span class="s2">&quot;Panel de Admin&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">f</span><span class="p">:</span><span class="nf">MakePopup</span><span class="p">()</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">tabs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DPropertySheet&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">f</span><span class="p">)</span>
<span class="w">    </span><span class="nv">tabs</span><span class="p">:</span><span class="nf">Dock</span><span class="p">(</span><span class="nv">FILL</span><span class="p">)</span>

<span class="w">    </span><span class="c1">-- TAB: Jugadores</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">pJugadores</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DPanel&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">pJugadores</span><span class="p">.</span><span class="py">Paint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span><span class="w"> </span><span class="kr">end</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DListView&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">pJugadores</span><span class="p">)</span>
<span class="w">    </span><span class="nv">list</span><span class="p">:</span><span class="nf">Dock</span><span class="p">(</span><span class="nv">FILL</span><span class="p">)</span>
<span class="w">    </span><span class="nv">list</span><span class="p">:</span><span class="nf">AddColumn</span><span class="p">(</span><span class="s2">&quot;Nombre&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">list</span><span class="p">:</span><span class="nf">AddColumn</span><span class="p">(</span><span class="s2">&quot;SteamID&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">list</span><span class="p">:</span><span class="nf">AddColumn</span><span class="p">(</span><span class="s2">&quot;Ping&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">ply</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">player</span><span class="p">.</span><span class="nf">GetAll</span><span class="p">())</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="nv">list</span><span class="p">:</span><span class="nf">AddLine</span><span class="p">(</span><span class="nv">ply</span><span class="p">:</span><span class="nf">Nick</span><span class="p">(),</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">SteamID</span><span class="p">(),</span><span class="w"> </span><span class="nv">ply</span><span class="p">:</span><span class="nf">Ping</span><span class="p">())</span>
<span class="w">    </span><span class="kr">end</span>
<span class="w">    </span><span class="nv">tabs</span><span class="p">:</span><span class="nf">AddSheet</span><span class="p">(</span><span class="s2">&quot;Jugadores&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">pJugadores</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;icon16/user.png&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="c1">-- TAB: Server</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">pServer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DPanel&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">pServer</span><span class="p">.</span><span class="py">Paint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">s</span><span class="p">,</span><span class="w"> </span><span class="nv">w</span><span class="p">,</span><span class="w"> </span><span class="nv">h</span><span class="p">)</span>
<span class="w">        </span><span class="nv">draw</span><span class="p">.</span><span class="nf">SimpleText</span><span class="p">(</span><span class="s2">&quot;Mapa: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">game</span><span class="p">.</span><span class="nf">GetMap</span><span class="p">(),</span><span class="w"> </span><span class="s2">&quot;DermaDefault&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="nv">color_white</span><span class="p">)</span>
<span class="w">        </span><span class="nv">draw</span><span class="p">.</span><span class="nf">SimpleText</span><span class="p">(</span><span class="s2">&quot;Jugadores: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">player</span><span class="p">.</span><span class="nf">GetCount</span><span class="p">()</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;/&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">game</span><span class="p">.</span><span class="nf">MaxPlayers</span><span class="p">(),</span>
<span class="w">            </span><span class="s2">&quot;DermaDefault&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="nv">color_white</span><span class="p">)</span>
<span class="w">        </span><span class="nv">draw</span><span class="p">.</span><span class="nf">SimpleText</span><span class="p">(</span><span class="s2">&quot;Entidades: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="o">#</span><span class="nv">ents</span><span class="p">.</span><span class="nf">GetAll</span><span class="p">(),</span><span class="w"> </span><span class="s2">&quot;DermaDefault&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">60</span><span class="p">,</span><span class="w"> </span><span class="nv">color_white</span><span class="p">)</span>
<span class="w">    </span><span class="kr">end</span>
<span class="w">    </span><span class="nv">tabs</span><span class="p">:</span><span class="nf">AddSheet</span><span class="p">(</span><span class="s2">&quot;Server&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">pServer</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;icon16/server.png&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="c1">-- TAB: Bans (requiere net al server para obtener datos SQL)</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">pBans</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DPanel&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">lblBans</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">vgui</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s2">&quot;DLabel&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">pBans</span><span class="p">)</span>
<span class="w">    </span><span class="nv">lblBans</span><span class="p">:</span><span class="nf">Dock</span><span class="p">(</span><span class="nv">FILL</span><span class="p">)</span>
<span class="w">    </span><span class="nv">lblBans</span><span class="p">:</span><span class="nf">SetText</span><span class="p">(</span><span class="s2">&quot;  Solicitar datos de bans al servidor via net...&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">lblBans</span><span class="p">:</span><span class="nf">SetContentAlignment</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="w">    </span><span class="nv">tabs</span><span class="p">:</span><span class="nf">AddSheet</span><span class="p">(</span><span class="s2">&quot;Bans&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">pBans</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;icon16/lock.png&quot;</span><span class="p">)</span>
<span class="kr">end</span><span class="p">)</span>
</pre></div>
</pre></div>

</div>
</details>
<h3 id="desafio-145-sistema-de-misionesquests-experto">Desaf√≠o 14.5 ‚Äî Sistema de Misiones/Quests <span class="badge expert">‚≠ê‚≠ê‚≠ê‚≠ê Experto</span></h3>
<p>Implement√° un sistema de misiones:
- Definici√≥n de misiones con progreso (ej: "Mata 10 NPCs", "Camina 5000 unidades", "Compra 3 items").
- Progreso guardado en SQLite por jugador.
- HUD mostrando la misi√≥n activa y su progreso.
- Panel VGUI con lista de misiones disponibles y completadas.
- Recompensas al completar (dinero, items, t√≠tulos).
- Sistema modular: poder agregar nuevas misiones solo creando una tabla de configuraci√≥n.
- Misiones diarias que se resetean cada 24hs.</p>
<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">

<div class="highlight"><pre><div class="highlight"><pre><span></span><span class="c1">-- === SERVER: Sistema de Misiones ===</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">Quests</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>

<span class="nv">Quests</span><span class="p">.</span><span class="py">Definiciones</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">{</span><span class="nv">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;kill_10&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">nombre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Cazador&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">desc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Mata 10 jugadores&quot;</span><span class="p">,</span>
<span class="w">     </span><span class="nv">tipo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;kill&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">objetivo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="nv">recompensa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">500</span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="nv">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;walk_5k&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">nombre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Caminante&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">desc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Camina 5000 unidades&quot;</span><span class="p">,</span>
<span class="w">     </span><span class="nv">tipo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;walk&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">objetivo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5000</span><span class="p">,</span><span class="w"> </span><span class="nv">recompensa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">200</span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="nv">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;buy_3&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">nombre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Comprador&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">desc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Compra 3 items&quot;</span><span class="p">,</span>
<span class="w">     </span><span class="nv">tipo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;buy&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">objetivo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="nv">recompensa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">300</span><span class="p">},</span>
<span class="p">}</span>

<span class="nv">sql</span><span class="p">.</span><span class="nf">Query</span><span class="p">([[</span><span class="nv">CREATE</span><span class="w"> </span><span class="nv">TABLE</span><span class="w"> </span><span class="nv">IF</span><span class="w"> </span><span class="nv">NOT</span><span class="w"> </span><span class="nv">EXISTS</span><span class="w"> </span><span class="nf">quest_progress</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="nv">steamid</span><span class="w"> </span><span class="nv">TEXT</span><span class="p">,</span><span class="w"> </span><span class="nv">quest_id</span><span class="w"> </span><span class="nv">TEXT</span><span class="p">,</span><span class="w"> </span><span class="nv">progreso</span><span class="w"> </span><span class="nv">REAL</span><span class="w"> </span><span class="nv">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="nv">completada</span><span class="w"> </span><span class="nv">INTEGER</span><span class="w"> </span><span class="nv">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">fecha</span><span class="w"> </span><span class="nv">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="nv">PRIMARY</span><span class="w"> </span><span class="nf">KEY</span><span class="w"> </span><span class="p">(</span><span class="nv">steamid</span><span class="p">,</span><span class="w"> </span><span class="nv">quest_id</span><span class="p">))]])</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">Quests</span><span class="p">.</span><span class="nf">GetProgreso</span><span class="p">(</span><span class="nv">ply</span><span class="p">,</span><span class="w"> </span><span class="nv">questId</span><span class="p">)</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">sql</span><span class="p">.</span><span class="nf">Query</span><span class="p">(</span><span class="nb">string.format</span><span class="p">(</span>
<span class="w">        </span><span class="s2">&quot;SELECT progreso, completada FROM quest_progress WHERE steamid=%s AND quest_id=%s&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nv">sql</span><span class="p">.</span><span class="nf">SQLStr</span><span class="p">(</span><span class="nv">ply</span><span class="p">:</span><span class="nf">SteamID64</span><span class="p">()),</span><span class="w"> </span><span class="nv">sql</span><span class="p">.</span><span class="nf">SQLStr</span><span class="p">(</span><span class="nv">questId</span><span class="p">)))</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">res</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="nb">tonumber</span><span class="p">(</span><span class="nv">res</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nv">progreso</span><span class="p">),</span><span class="w"> </span><span class="nb">tonumber</span><span class="p">(</span><span class="nv">res</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nv">completada</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span>
<span class="kr">end</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">Quests</span><span class="p">.</span><span class="nf">Avanzar</span><span class="p">(</span><span class="nv">ply</span><span class="p">,</span><span class="w"> </span><span class="nv">tipo</span><span class="p">,</span><span class="w"> </span><span class="nv">cantidad</span><span class="p">)</span>
<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">quest</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">Quests</span><span class="p">.</span><span class="py">Definiciones</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">quest</span><span class="p">.</span><span class="py">tipo</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="nv">tipo</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="nv">continue</span><span class="w"> </span><span class="kr">end</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">prog</span><span class="p">,</span><span class="w"> </span><span class="nv">completada</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">Quests</span><span class="p">.</span><span class="nf">GetProgreso</span><span class="p">(</span><span class="nv">ply</span><span class="p">,</span><span class="w"> </span><span class="nv">quest</span><span class="p">.</span><span class="py">id</span><span class="p">)</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">completada</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="nv">continue</span><span class="w"> </span><span class="kr">end</span>
<span class="w">        </span><span class="nv">prog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">prog</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">cantidad</span>
<span class="w">        </span><span class="nv">sql</span><span class="p">.</span><span class="nf">Query</span><span class="p">(</span><span class="nb">string.format</span><span class="p">(</span>
<span class="w">            </span><span class="s2">&quot;INSERT OR REPLACE INTO quest_progress VALUES (%s, %s, %f, %d, %s)&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nv">sql</span><span class="p">.</span><span class="nf">SQLStr</span><span class="p">(</span><span class="nv">ply</span><span class="p">:</span><span class="nf">SteamID64</span><span class="p">()),</span><span class="w"> </span><span class="nv">sql</span><span class="p">.</span><span class="nf">SQLStr</span><span class="p">(</span><span class="nv">quest</span><span class="p">.</span><span class="py">id</span><span class="p">),</span>
<span class="w">            </span><span class="nv">prog</span><span class="p">,</span><span class="w"> </span><span class="nv">prog</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nv">quest</span><span class="p">.</span><span class="py">objetivo</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">sql</span><span class="p">.</span><span class="nf">SQLStr</span><span class="p">(</span><span class="nb">os.date</span><span class="p">(</span><span class="s2">&quot;%Y-%m-%d&quot;</span><span class="p">))))</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">prog</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nv">quest</span><span class="p">.</span><span class="py">objetivo</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="nv">ply</span><span class="p">:</span><span class="nf">ChatPrint</span><span class="p">(</span><span class="s2">&quot;¬°Misi√≥n completada: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">quest</span><span class="p">.</span><span class="py">nombre</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;! +$&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">quest</span><span class="p">.</span><span class="py">recompensa</span><span class="p">)</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">end</span>
<span class="kr">end</span>

<span class="c1">-- Hooks de tracking</span>
<span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;PlayerDeath&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Quests_Kill&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">v</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">a</span><span class="p">)</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nf">IsValid</span><span class="p">(</span><span class="nv">a</span><span class="p">)</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">a</span><span class="p">:</span><span class="nf">IsPlayer</span><span class="p">()</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="nv">v</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="nv">Quests</span><span class="p">.</span><span class="nf">Avanzar</span><span class="p">(</span><span class="nv">a</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;kill&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="kr">end</span>
<span class="kr">end</span><span class="p">)</span>

<span class="nv">hook</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">&quot;PlayerSay&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Quests_Cmd&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">ply</span><span class="p">,</span><span class="w"> </span><span class="nv">text</span><span class="p">)</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;!misiones&quot;</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="nv">ply</span><span class="p">:</span><span class="nf">ChatPrint</span><span class="p">(</span><span class="s2">&quot;--- Misiones ---&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">q</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">Quests</span><span class="p">.</span><span class="py">Definiciones</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">            </span><span class="kd">local</span><span class="w"> </span><span class="nv">prog</span><span class="p">,</span><span class="w"> </span><span class="nv">done</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">Quests</span><span class="p">.</span><span class="nf">GetProgreso</span><span class="p">(</span><span class="nv">ply</span><span class="p">,</span><span class="w"> </span><span class="nv">q</span><span class="p">.</span><span class="py">id</span><span class="p">)</span>
<span class="w">            </span><span class="kd">local</span><span class="w"> </span><span class="nv">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">done</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="s2">&quot;‚úÖ&quot;</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="p">(</span><span class="nb">math.floor</span><span class="p">(</span><span class="nv">prog</span><span class="p">)</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;/&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">q</span><span class="p">.</span><span class="py">objetivo</span><span class="p">)</span>
<span class="w">            </span><span class="nv">ply</span><span class="p">:</span><span class="nf">ChatPrint</span><span class="p">(</span><span class="nv">q</span><span class="p">.</span><span class="py">nombre</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">q</span><span class="p">.</span><span class="py">desc</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; [&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">status</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;]&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="kr">end</span>
<span class="kr">end</span><span class="p">)</span>
</pre></div>
</pre></div>

</div>
</details>

<hr />
<h2 id="15-preguntas-teoricas"><span class="num">15</span> Preguntas Te√≥ricas</h2>
<h3 id="pregunta-151">Pregunta 15.1</h3>
<p>¬øPor qu√© es peligroso ejecutar <code>RunString()</code> con input del cliente? D√° un ejemplo concreto de exploit.</p>

<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">
<p><code>RunString()</code> ejecuta cualquier c√≥digo Lua arbitrario en el contexto actual. Si el input viene del cliente, un jugador malicioso puede ejecutar cualquier cosa en el servidor: <code>RunString("for _, p in pairs(player.GetAll()) do p:Kick('hacked') end")</code> kickea a todos. Es equivalente a darle acceso root al servidor a cualquier jugador conectado. <strong>NUNCA</strong> uses <code>RunString</code> con input externo.</p>
</div>
</details>
<h3 id="pregunta-152">Pregunta 15.2</h3>
<p>Explic√° la diferencia entre <code>net.WriteTable</code> y enviar los datos con <code>net.WriteString</code>/<code>net.WriteInt</code> individuales. ¬øCu√°ndo conviene cada enfoque?</p>

<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">
<p><code>net.WriteTable</code> serializa la tabla a JSON internamente, lo que es conveniente pero ineficiente: incluye las claves como strings, usa m√°s bytes, y es m√°s lento de parsear. Enviar datos individuales con <code>WriteString/WriteInt/WriteBool</code> es m√°s eficiente en ancho de banda y procesamiento, pero requiere que ambos lados conozcan la estructura exacta. Us√° <code>WriteTable</code> para datos din√°micos/variables. Us√° Write individuales para estructuras fijas y frecuentes.</p>
</div>
</details>
<h3 id="pregunta-153">Pregunta 15.3</h3>
<p>¬øQu√© pasa si dos addons usan el mismo identificador en <code>hook.Add</code> para el mismo evento? ¬øC√≥mo se evita?</p>

<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">
<p>El segundo hook <strong>reemplaza</strong> al primero silenciosamente. No hay error ni warning. Se evita usando un prefijo √∫nico para tu addon: <code>"MiAddon_NombreDescriptivo"</code>. Esto es especialmente problem√°tico con nombres gen√©ricos como <code>"Spawn"</code> o <code>"Death"</code> que m√∫ltiples addons podr√≠an usar.</p>
</div>
</details>
<h3 id="pregunta-154">Pregunta 15.4</h3>
<p>¬øPor qu√© <code>ents.GetAll()</code> dentro de <code>Think</code> o <code>HUDPaint</code> es una mala idea? ¬øCu√°les son las alternativas?</p>

<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">
<p><code>ents.GetAll()</code> retorna TODAS las entidades del mapa ‚Äî pueden ser cientos o miles. En <code>Think</code> (66 ticks/seg) o <code>HUDPaint</code> (cada frame), iterar sobre todas es un desperdicio masivo. Alternativas: <code>player.GetAll()</code> para jugadores, <code>ents.FindByClass()</code> si necesit√°s una clase espec√≠fica, cachear resultados y actualizar peri√≥dicamente, o usar <code>ents.FindInSphere()</code> para limitar por distancia.</p>
</div>
</details>
<h3 id="pregunta-155">Pregunta 15.5</h3>
<p>Explic√° qu√© es una "race condition" en el contexto de GLua networking. D√° un ejemplo de cu√°ndo podr√≠a ocurrir y c√≥mo prevenirla.</p>

<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">
<p>Una race condition ocurre cuando dos operaciones asincr√≥nicas dependen del mismo estado. Ejemplo: un jugador env√≠a dos net messages de "comprar item" casi simult√°neamente. Si el server procesa el primero y resta el dinero, pero el segundo llega antes de que la resta se complete, ambas compras podr√≠an aprobarse con dinero insuficiente. Prevenci√≥n: usar flags de "procesando" por jugador, o verificar condiciones at√≥micamente antes de modificar estado.</p>
</div>
</details>
<h3 id="pregunta-156">Pregunta 15.6</h3>
<p>¬øPor qu√© nunca deb√©s validar permisos (admin, dinero, etc.) solo en el cliente? D√° un ejemplo de c√≥mo un jugador malicioso podr√≠a explotar esto.</p>

<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">
<p>Un jugador puede modificar cualquier c√≥digo del cliente usando un injector de Lua. Si la verificaci√≥n es solo en client (<code>if ply:IsAdmin() then net.SendToServer() end</code>), el jugador simplemente elimina el <code>if</code> y llama a <code>net.SendToServer()</code> directamente. El server debe SIEMPRE verificar permisos en <code>net.Receive</code> antes de ejecutar la acci√≥n. El cliente solo sirve para mejorar la UX, nunca para seguridad.</p>
</div>
</details>
<h3 id="pregunta-157">Pregunta 15.7</h3>
<p>¬øCu√°l es la diferencia entre <code>SafeRemoveEntity(ent)</code> y <code>ent:Remove()</code>? ¬øCu√°ndo usar√≠as cada una?</p>

<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">
<p><code>ent:Remove()</code> tira error si <code>ent</code> es <code>nil</code> o <code>NULL</code>. <code>SafeRemoveEntity(ent)</code> primero verifica <code>IsValid(ent)</code> y solo entonces llama <code>Remove</code> ‚Äî nunca tira error. Us√° <code>SafeRemoveEntity</code> cuando no est√©s 100% seguro de que la entidad existe (dentro de timers, callbacks, cleanup). Us√° <code>ent:Remove()</code> cuando ya verificaste con <code>IsValid</code>.</p>
</div>
</details>
<h3 id="pregunta-158">Pregunta 15.8</h3>
<p>¬øPor qu√© es importante llamar <code>IsValid(ply)</code> dentro de un callback de <code>timer.Simple</code> despu√©s de un delay? ¬øQu√© podr√≠a haber pasado con el jugador?</p>
<details>
<summary>Ver soluci√≥n</summary>
<div class="solution-content">
<p>Despu√©s de un delay, el jugador puede haberse desconectado. La variable <code>ply</code> apunta a una entidad que ya no existe ‚Äî es <code>NULL</code>. Llamar cualquier m√©todo sobre <code>NULL</code> (<code>ply:ChatPrint()</code>) causa un error. Siempre verific√° <code>if not IsValid(ply) then return end</code> al inicio del callback. Esto aplica a cualquier referencia a entidad guardada que se use despu√©s de un delay.</p>
</div>
</details>

<hr />
<h2 id="cierre">Cierre</h2>
<p>Estos ejercicios cubren desde lo b√°sico hasta proyectos de producci√≥n real. No hace falta hacerlos en orden ‚Äî eleg√≠ los que te desaf√≠en seg√∫n tu nivel actual. La clave para aprender GLua es <strong>escribir c√≥digo, romperlo, y arreglarlo</strong>. Cada error es una lecci√≥n.</p>
<h3 id="recursos-para-los-ejercicios">Recursos para los Ejercicios</h3>
<ul>
<li><strong>Wiki oficial:</strong> <a href="https://wiki.facepunch.com/gmod/">wiki.facepunch.com/gmod</a> ‚Äî busc√° cualquier funci√≥n</li>
<li><strong>Curso principal:</strong> Referencia r√°pida para cada sistema mencionado</li>
<li><strong>Consola del juego:</strong> Us√° <code>lua_run</code> y <code>lua_run_cl</code> para testear fragmentos r√°pidos</li>
</ul>

</main>

<button class="btt" id="btt" onclick="window.scrollTo({top:0,behavior:'smooth'})">‚Üë</button>

<script>
window.addEventListener('scroll',()=>{
  const h=document.documentElement;
  const p=(h.scrollTop/(h.scrollHeight-h.clientHeight))*100;
  document.getElementById('prog').style.width=p+'%';
  document.getElementById('btt').classList.toggle('show',h.scrollTop>400);
});
document.querySelectorAll('.sb-nav a').forEach(a=>{
  a.addEventListener('click',()=>{
    if(window.innerWidth<=900)document.getElementById('sb').classList.remove('open');
  });
});
</script>
</body>
</html>